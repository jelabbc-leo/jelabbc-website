--
-- Script was generated by Devart dbForge Studio for MySQL, Version 2025.2.109.0
-- Product home page: https://www.devart.com/dbforge/mysql/studio
-- Script date 18/01/2026 06:45:23 p. m.
-- Server version: 8.0.42
--

--
-- Disable foreign keys
--
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;

--
-- Set SQL mode
--
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;

--
-- Set character set the client will use to send SQL statements to the server
--
SET NAMES 'utf8';

--
-- Set default database
--
USE jela_qa;

--
-- Drop procedure `drop_index_if_exists`
--
DROP PROCEDURE IF EXISTS drop_index_if_exists;

--
-- Drop procedure `sp_ActualizarTiemposTicket`
--
DROP PROCEDURE IF EXISTS sp_ActualizarTiemposTicket;

--
-- Drop procedure `sp_GenerarFolioTicket`
--
DROP PROCEDURE IF EXISTS sp_GenerarFolioTicket;

--
-- Drop table `cat_conceptos_familias`
--
DROP TABLE IF EXISTS cat_conceptos_familias;

--
-- Drop table `cat_documentos`
--
DROP TABLE IF EXISTS cat_documentos;

--
-- Drop table `cat_forma_de_pago`
--
DROP TABLE IF EXISTS cat_forma_de_pago;

--
-- Drop table `cat_metodo_de_pago`
--
DROP TABLE IF EXISTS cat_metodo_de_pago;

--
-- Drop table `cat_regimen_fiscal`
--
DROP TABLE IF EXISTS cat_regimen_fiscal;

--
-- Drop table `cat_tipo_documentos`
--
DROP TABLE IF EXISTS cat_tipo_documentos;

--
-- Drop table `cat_unidades_medidas`
--
DROP TABLE IF EXISTS cat_unidades_medidas;

--
-- Drop table `cat_usos_cfdi`
--
DROP TABLE IF EXISTS cat_usos_cfdi;

--
-- Drop table `cat_vehiculos_unidad`
--
DROP TABLE IF EXISTS cat_vehiculos_unidad;

--
-- Drop table `conf_residentes_blacklist`
--
DROP TABLE IF EXISTS conf_residentes_blacklist;

--
-- Drop table `conf_residentes_telegram`
--
DROP TABLE IF EXISTS conf_residentes_telegram;

--
-- Drop table `conf_residentes_whitelist`
--
DROP TABLE IF EXISTS conf_residentes_whitelist;

--
-- Drop table `log_validacion_telegram`
--
DROP TABLE IF EXISTS log_validacion_telegram;

--
-- Drop table `op_documentos_colonias`
--
DROP TABLE IF EXISTS op_documentos_colonias;

--
-- Drop table `op_documentos_detalle`
--
DROP TABLE IF EXISTS op_documentos_detalle;

--
-- Drop table `op_medidorevento`
--
DROP TABLE IF EXISTS op_medidorevento;

--
-- Drop table `op_medidorlectura`
--
DROP TABLE IF EXISTS op_medidorlectura;

--
-- Drop procedure `sp_completar_respuesta_formulario`
--
DROP PROCEDURE IF EXISTS sp_completar_respuesta_formulario;

--
-- Drop procedure `sp_crear_respuesta_formulario`
--
DROP PROCEDURE IF EXISTS sp_crear_respuesta_formulario;

--
-- Drop table `op_formulario_historial`
--
DROP TABLE IF EXISTS op_formulario_historial;

--
-- Drop table `op_documento_formulario_pdf`
--
DROP TABLE IF EXISTS op_documento_formulario_pdf;

--
-- Drop procedure `sp_actualizar_progreso_respuesta`
--
DROP PROCEDURE IF EXISTS sp_actualizar_progreso_respuesta;

--
-- Drop table `op_respuesta_campo`
--
DROP TABLE IF EXISTS op_respuesta_campo;

--
-- Drop view `vw_estadisticas_formularios_entidad`
--
DROP VIEW IF EXISTS vw_estadisticas_formularios_entidad CASCADE;

--
-- Drop view `vw_respuestas_pendientes_sync`
--
DROP VIEW IF EXISTS vw_respuestas_pendientes_sync CASCADE;

--
-- Drop trigger `trg_respuesta_hash`
--
DROP TRIGGER IF EXISTS trg_respuesta_hash;

--
-- Drop table `op_respuesta_formulario`
--
DROP TABLE IF EXISTS op_respuesta_formulario;

--
-- Drop view `vw_formularios_resumen`
--
DROP VIEW IF EXISTS vw_formularios_resumen CASCADE;

--
-- Drop table `op_fallo_formulario`
--
DROP TABLE IF EXISTS op_fallo_formulario;

--
-- Drop table `op_documentos`
--
DROP TABLE IF EXISTS op_documentos;

--
-- Drop view `vw_tickets_completo`
--
DROP VIEW IF EXISTS vw_tickets_completo CASCADE;

--
-- Drop procedure `sp_cambiar_estado_ticket`
--
DROP PROCEDURE IF EXISTS sp_cambiar_estado_ticket;

--
-- Drop table `conf_ticket_sla`
--
DROP TABLE IF EXISTS conf_ticket_sla;

--
-- Drop trigger `trg_NotificarCambioEstado`
--
DROP TRIGGER IF EXISTS trg_NotificarCambioEstado;

--
-- Drop trigger `trg_NotificarCambioEstadoTelegram`
--
DROP TRIGGER IF EXISTS trg_NotificarCambioEstadoTelegram;

--
-- Drop table `op_telegram_notifications_queue`
--
DROP TABLE IF EXISTS op_telegram_notifications_queue;

--
-- Drop table `op_ticket_adjuntos`
--
DROP TABLE IF EXISTS op_ticket_adjuntos;

--
-- Drop table `op_ticket_comentarios`
--
DROP TABLE IF EXISTS op_ticket_comentarios;

--
-- Drop procedure `sp_asignar_ticket`
--
DROP PROCEDURE IF EXISTS sp_asignar_ticket;

--
-- Drop table `op_ticket_notificaciones`
--
DROP TABLE IF EXISTS op_ticket_notificaciones;

--
-- Drop procedure `sp_crear_ticket`
--
DROP PROCEDURE IF EXISTS sp_crear_ticket;

--
-- Drop table `op_ticket_timeline`
--
DROP TABLE IF EXISTS op_ticket_timeline;

--
-- Drop table `op_tickets`
--
DROP TABLE IF EXISTS op_tickets;

--
-- Drop table `cat_categorias_ticket`
--
DROP TABLE IF EXISTS cat_categorias_ticket;

--
-- Drop table `cat_colaboradores`
--
DROP TABLE IF EXISTS cat_colaboradores;

--
-- Drop table `cat_colonias`
--
DROP TABLE IF EXISTS cat_colonias;

--
-- Drop table `cat_conceptos`
--
DROP TABLE IF EXISTS cat_conceptos;

--
-- Drop view `vw_campos_con_opciones`
--
DROP VIEW IF EXISTS vw_campos_con_opciones CASCADE;

--
-- Drop procedure `sp_obtener_formulario_completo`
--
DROP PROCEDURE IF EXISTS sp_obtener_formulario_completo;

--
-- Drop table `cat_opciones_campo`
--
DROP TABLE IF EXISTS cat_opciones_campo;

--
-- Drop table `cat_validaciones_campo`
--
DROP TABLE IF EXISTS cat_validaciones_campo;

--
-- Drop table `cat_campos_formulario`
--
DROP TABLE IF EXISTS cat_campos_formulario;

--
-- Drop table `cat_plantilla_pdf`
--
DROP TABLE IF EXISTS cat_plantilla_pdf;

--
-- Drop trigger `trg_formulario_version`
--
DROP TRIGGER IF EXISTS trg_formulario_version;

--
-- Drop table `cat_formularios`
--
DROP TABLE IF EXISTS cat_formularios;

--
-- Drop table `cat_medidor`
--
DROP TABLE IF EXISTS cat_medidor;

--
-- Drop table `rel_rol_permisos`
--
DROP TABLE IF EXISTS rel_rol_permisos;

--
-- Drop table `cat_permisos`
--
DROP TABLE IF EXISTS cat_permisos;

--
-- Drop table `cat_proveedores`
--
DROP TABLE IF EXISTS cat_proveedores;

--
-- Drop table `cat_roles`
--
DROP TABLE IF EXISTS cat_roles;

--
-- Drop table `cat_ticket_categorias`
--
DROP TABLE IF EXISTS cat_ticket_categorias;

--
-- Drop table `op_comunicados_lecturas`
--
DROP TABLE IF EXISTS op_comunicados_lecturas;

--
-- Drop trigger `trg_pagos_detalle_after_delete`
--
DROP TRIGGER IF EXISTS trg_pagos_detalle_after_delete;

--
-- Drop trigger `trg_pagos_detalle_after_insert`
--
DROP TRIGGER IF EXISTS trg_pagos_detalle_after_insert;

--
-- Drop table `op_pagos_detalle`
--
DROP TABLE IF EXISTS op_pagos_detalle;

--
-- Drop view `vw_estado_cuenta`
--
DROP VIEW IF EXISTS vw_estado_cuenta CASCADE;

--
-- Drop view `vw_resumen_morosidad`
--
DROP VIEW IF EXISTS vw_resumen_morosidad CASCADE;

--
-- Drop procedure `sp_AplicarRecargosMora`
--
DROP PROCEDURE IF EXISTS sp_AplicarRecargosMora;

--
-- Drop procedure `sp_GenerarCuotasMensuales`
--
DROP PROCEDURE IF EXISTS sp_GenerarCuotasMensuales;

--
-- Drop function `fn_GenerarFolio`
--
DROP FUNCTION IF EXISTS fn_GenerarFolio;

--
-- Drop table `op_cuotas`
--
DROP TABLE IF EXISTS op_cuotas;

--
-- Drop table `op_pagos`
--
DROP TABLE IF EXISTS op_pagos;

--
-- Drop view `vw_calendario_reservaciones`
--
DROP VIEW IF EXISTS vw_calendario_reservaciones CASCADE;

--
-- Drop table `op_reservaciones`
--
DROP TABLE IF EXISTS op_reservaciones;

--
-- Drop view `vw_visitantes_activos`
--
DROP VIEW IF EXISTS vw_visitantes_activos CASCADE;

--
-- Drop table `op_visitantes`
--
DROP TABLE IF EXISTS op_visitantes;

--
-- Drop table `cat_residentes`
--
DROP TABLE IF EXISTS cat_residentes;

--
-- Drop table `cat_unidades`
--
DROP TABLE IF EXISTS cat_unidades;

--
-- Drop table `conf_formulario_config`
--
DROP TABLE IF EXISTS conf_formulario_config;

--
-- Drop table `conf_rolopciones`
--
DROP TABLE IF EXISTS conf_rolopciones;

--
-- Drop table `conf_opciones`
--
DROP TABLE IF EXISTS conf_opciones;

--
-- Drop table `conf_perfiles`
--
DROP TABLE IF EXISTS conf_perfiles;

--
-- Drop table `conf_usuarioroles`
--
DROP TABLE IF EXISTS conf_usuarioroles;

--
-- Drop table `conf_roles`
--
DROP TABLE IF EXISTS conf_roles;

--
-- Drop view `vw_areas_disponibles_reservacion`
--
DROP VIEW IF EXISTS vw_areas_disponibles_reservacion CASCADE;

--
-- Drop table `cat_areas_comunes`
--
DROP TABLE IF EXISTS cat_areas_comunes;

--
-- Drop table `cat_conceptos_cuota`
--
DROP TABLE IF EXISTS cat_conceptos_cuota;

--
-- Drop table `conf_ticket_prompts`
--
DROP TABLE IF EXISTS conf_ticket_prompts;

--
-- Drop table `op_comunicados`
--
DROP TABLE IF EXISTS op_comunicados;

--
-- Drop table `op_ticket_prompt_ajustes_log`
--
DROP TABLE IF EXISTS op_ticket_prompt_ajustes_log;

--
-- Drop table `conf_usuarios`
--
DROP TABLE IF EXISTS conf_usuarios;

--
-- Drop table `op_telegram_blacklist`
--
DROP TABLE IF EXISTS op_telegram_blacklist;

--
-- Drop table `op_telegram_clientes`
--
DROP TABLE IF EXISTS op_telegram_clientes;

--
-- Drop table `op_telegram_logs_validacion`
--
DROP TABLE IF EXISTS op_telegram_logs_validacion;

--
-- Drop table `op_telegram_whitelist`
--
DROP TABLE IF EXISTS op_telegram_whitelist;

--
-- Drop procedure `sp_CalcularMetricasDiarias`
--
DROP PROCEDURE IF EXISTS sp_CalcularMetricasDiarias;

--
-- Drop table `op_ticket_metricas`
--
DROP TABLE IF EXISTS op_ticket_metricas;

--
-- Drop table `op_ticket_robot_monitoreo`
--
DROP TABLE IF EXISTS op_ticket_robot_monitoreo;

--
-- Drop table `op_ticket_acciones`
--
DROP TABLE IF EXISTS op_ticket_acciones;

--
-- Drop table `op_ticket_archivos`
--
DROP TABLE IF EXISTS op_ticket_archivos;

--
-- Drop table `op_ticket_conversacion`
--
DROP TABLE IF EXISTS op_ticket_conversacion;

--
-- Drop table `op_ticket_logprompts`
--
DROP TABLE IF EXISTS op_ticket_logprompts;

--
-- Drop table `op_ticket_logs_interacciones`
--
DROP TABLE IF EXISTS op_ticket_logs_interacciones;

--
-- Drop table `op_ticket_logs_sistema`
--
DROP TABLE IF EXISTS op_ticket_logs_sistema;

--
-- Drop procedure `sp_EncolarNotificacionWhatsApp`
--
DROP PROCEDURE IF EXISTS sp_EncolarNotificacionWhatsApp;

--
-- Drop table `op_ticket_notificaciones_whatsapp`
--
DROP TABLE IF EXISTS op_ticket_notificaciones_whatsapp;

--
-- Drop procedure `sp_ValidarClienteDuplicado`
--
DROP PROCEDURE IF EXISTS sp_ValidarClienteDuplicado;

--
-- Drop table `op_ticket_validacion_cliente`
--
DROP TABLE IF EXISTS op_ticket_validacion_cliente;

--
-- Drop table `op_tickets_v2`
--
DROP TABLE IF EXISTS op_tickets_v2;

--
-- Drop table `cat_entidades`
--
DROP TABLE IF EXISTS cat_entidades;

--
-- Drop table `cat_sub_entidades`
--
DROP TABLE IF EXISTS cat_sub_entidades;

--
-- Set default database
--
USE jela_qa;

--
-- Create table `cat_sub_entidades`
--
CREATE TABLE cat_sub_entidades (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 0,
  Clave varchar(50) DEFAULT NULL,
  Alias varchar(50) DEFAULT NULL,
  CIF varchar(20) DEFAULT NULL,
  RazonSocial varchar(255) DEFAULT NULL,
  Telefonos varchar(50) DEFAULT NULL,
  Whatsapp varchar(20) DEFAULT NULL,
  Mail varchar(255) DEFAULT NULL,
  CP varchar(10) DEFAULT '',
  TipoVialidad varchar(255) DEFAULT NULL,
  NombreVialidad varchar(255) DEFAULT NULL,
  NoExterior varchar(255) DEFAULT NULL,
  NoInterior varchar(255) DEFAULT NULL,
  Colonia varchar(255) DEFAULT NULL,
  Localidad varchar(255) DEFAULT NULL,
  Municipio varchar(255) DEFAULT NULL,
  EntidadFederativa varchar(255) DEFAULT NULL,
  EntreCalle varchar(255) DEFAULT NULL,
  RFC varchar(20) DEFAULT NULL,
  FechaAlta datetime DEFAULT NULL,
  FechaInicioSAT varchar(255) DEFAULT NULL,
  ClaveRegimen varchar(255) DEFAULT NULL,
  RegimenFiscal varchar(255) DEFAULT NULL,
  Latitud double NOT NULL DEFAULT 0,
  Longitud double NOT NULL DEFAULT 0,
  Usuario varchar(50) DEFAULT NULL,
  Contraseña varchar(255) DEFAULT NULL,
  IdPerfil int NOT NULL DEFAULT 0,
  Activo tinyint(1) DEFAULT NULL,
  EsSeccionCondominio tinyint(1) DEFAULT 0 COMMENT '1=Es una secciÃ³n/torre de condominio',
  TipoSeccion enum ('Torre', 'Seccion', 'Edificio', 'Cluster', 'Privada', 'Otro') DEFAULT NULL COMMENT 'Tipo de secciÃ³n',
  NumeroNiveles int DEFAULT NULL COMMENT 'NÃºmero de niveles/pisos',
  NumeroUnidades int DEFAULT 0 COMMENT 'NÃºmero de unidades en esta secciÃ³n',
  TieneElevador tinyint(1) DEFAULT 0 COMMENT '1=Tiene elevador',
  NumeroElevadores int DEFAULT 0 COMMENT 'NÃºmero de elevadores',
  TieneEstacionamiento tinyint(1) DEFAULT 0 COMMENT '1=Tiene estacionamiento',
  CajonesEstacionamiento int DEFAULT 0 COMMENT 'NÃºmero de cajones de estacionamiento',
  Administrador varchar(200) DEFAULT NULL COMMENT 'Nombre del administrador',
  TelefonoVigilancia varchar(20) DEFAULT NULL COMMENT 'TelÃ©fono de caseta de vigilancia',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 8,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_EsSeccionCondominio` on table `cat_sub_entidades`
--
ALTER TABLE cat_sub_entidades
ADD INDEX idx_EsSeccionCondominio (EsSeccionCondominio);

--
-- Create index `IDX_sub_entidades` on table `cat_sub_entidades`
--
ALTER TABLE cat_sub_entidades
ADD INDEX IDX_sub_entidades (IdEntidad, Clave, CIF, RazonSocial);

--
-- Create index `IDX_sub_entidades_CIF` on table `cat_sub_entidades`
--
ALTER TABLE cat_sub_entidades
ADD INDEX IDX_sub_entidades_CIF (CIF);

--
-- Create index `IDX_sub_entidades_Clave` on table `cat_sub_entidades`
--
ALTER TABLE cat_sub_entidades
ADD INDEX IDX_sub_entidades_Clave (Clave);

--
-- Create index `IDX_sub_entidades_IdEntidad` on table `cat_sub_entidades`
--
ALTER TABLE cat_sub_entidades
ADD INDEX IDX_sub_entidades_IdEntidad (IdEntidad);

--
-- Create table `cat_entidades`
--
CREATE TABLE cat_entidades (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(50) DEFAULT NULL,
  Alias varchar(50) DEFAULT NULL,
  CIF varchar(20) DEFAULT NULL,
  RazonSocial varchar(255) DEFAULT NULL,
  CP varchar(10) DEFAULT '',
  TipoVialidad varchar(255) DEFAULT NULL,
  NombreVialidad varchar(255) DEFAULT NULL,
  NoExterior varchar(255) DEFAULT NULL,
  NoInterior varchar(255) DEFAULT NULL,
  Colonia varchar(255) DEFAULT NULL,
  Localidad varchar(255) DEFAULT NULL,
  Municipio varchar(255) DEFAULT NULL,
  EntidadFederativa varchar(255) DEFAULT NULL,
  EntreCalle varchar(255) DEFAULT NULL,
  RFC varchar(20) DEFAULT NULL,
  FechaAlta datetime DEFAULT NULL,
  FechaInicioSAT varchar(255) DEFAULT NULL,
  ClaveRegimen varchar(255) DEFAULT NULL,
  RegimenFiscal varchar(255) DEFAULT NULL,
  ClaveMetodo varchar(255) DEFAULT NULL,
  MetodoDePago varchar(255) DEFAULT NULL,
  ClaveForma varchar(255) DEFAULT NULL,
  FormaDePago varchar(255) DEFAULT NULL,
  ClaveUso varchar(255) DEFAULT NULL,
  UsoCFDI varchar(255) DEFAULT NULL,
  Latitud double NOT NULL DEFAULT 0,
  Longitud double NOT NULL DEFAULT 0,
  Usuario varchar(50) DEFAULT NULL,
  Contraseña varchar(255) DEFAULT NULL,
  IdPerfil int NOT NULL DEFAULT 0,
  Activo tinyint(1) DEFAULT NULL,
  EsCondominio tinyint(1) DEFAULT 0 COMMENT '1=Es un condominio/fraccionamiento',
  TipoCondominio enum ('Vertical', 'Horizontal', 'Mixto') DEFAULT NULL COMMENT 'Tipo de condominio',
  NumeroUnidades int DEFAULT 0 COMMENT 'NÃºmero total de unidades',
  FechaConstitucion date DEFAULT NULL COMMENT 'Fecha de constituciÃ³n del condominio',
  ReglamentoPath varchar(500) DEFAULT NULL COMMENT 'Ruta al archivo del reglamento',
  LogoPath varchar(500) DEFAULT NULL COMMENT 'Ruta al logo del condominio',
  TelefonoAdministracion varchar(20) DEFAULT NULL COMMENT 'TelÃ©fono de administraciÃ³n',
  EmailAdministracion varchar(200) DEFAULT NULL COMMENT 'Email de administraciÃ³n',
  TelegramBotToken varchar(100) DEFAULT NULL COMMENT 'Token del bot de Telegram',
  TelegramGrupoChatId varchar(50) DEFAULT NULL COMMENT 'Chat ID del grupo de Telegram',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 5,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_EsCondominio` on table `cat_entidades`
--
ALTER TABLE cat_entidades
ADD INDEX idx_EsCondominio (EsCondominio);

--
-- Create table `op_tickets_v2`
--
CREATE TABLE op_tickets_v2 (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  TicketIdExterno varchar(100) DEFAULT NULL COMMENT 'ID del ticket en sistema externo (Klarna, etc.)',
  AsuntoCorto varchar(200) NOT NULL COMMENT 'Asunto corto generado por IA',
  MensajeOriginal text NOT NULL COMMENT 'Mensaje original del cliente',
  ResumenIA text DEFAULT NULL COMMENT 'Resumen generado por IA',
  Canal varchar(50) NOT NULL COMMENT 'Canal de entrada (Email, Chat, Telefono, RedesSociales, App)',
  NombreCompleto varchar(200) DEFAULT NULL COMMENT 'Nombre completo del cliente',
  EmailCliente varchar(255) DEFAULT NULL COMMENT 'Email del cliente',
  TelefonoCliente varchar(50) DEFAULT NULL COMMENT 'Teléfono del cliente',
  IdCliente int DEFAULT NULL COMMENT 'ID del cliente en sistema (FK a cat_clientes si existe)',
  CategoriaAsignada varchar(100) DEFAULT NULL COMMENT 'Categoría asignada por IA',
  SubcategoriaAsignada varchar(100) DEFAULT NULL COMMENT 'Subcategoría asignada por IA',
  SentimientoDetectado varchar(50) DEFAULT NULL COMMENT 'Sentimiento detectado por IA (Negativo, Neutral, Positivo)',
  PrioridadAsignada varchar(50) DEFAULT 'Media' COMMENT 'Prioridad asignada por IA (Baja, Media, Alta, Crítica)',
  UrgenciaAsignada varchar(50) DEFAULT 'Media' COMMENT 'Urgencia asignada por IA (Baja, Media, Alta)',
  PuedeResolverIA tinyint(1) DEFAULT 0 COMMENT 'Indica si la IA puede resolver automáticamente',
  RespuestaIA text DEFAULT NULL COMMENT 'Respuesta generada por IA',
  Estado varchar(50) DEFAULT 'Abierto' COMMENT 'Estado del ticket (Abierto, EnProceso, Resuelto, Cerrado, Cancelado)',
  IdAgenteAsignado int DEFAULT NULL COMMENT 'ID del agente asignado (FK a conf_usuarios)',
  FechaAsignacionAgente datetime DEFAULT NULL COMMENT 'Fecha de asignación a agente',
  FechaResolucion datetime DEFAULT NULL COMMENT 'Fecha de resolución del ticket',
  TiempoResolucionMinutos int DEFAULT NULL COMMENT 'Tiempo de resolución en minutos',
  SatisfaccionCliente int DEFAULT NULL COMMENT 'Calificación de satisfacción (1-5)',
  ComentarioSatisfaccion text DEFAULT NULL COMMENT 'Comentario del cliente sobre la atención',
  IdUsuarioCreacion int NOT NULL COMMENT 'ID del usuario que creó el ticket',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación',
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',
  Activo tinyint(1) DEFAULT 1 COMMENT 'Indica si el ticket está activo',
  TipoTicket enum ('Accion', 'Inaccion', 'LlamadaCortada', 'ChatWeb', 'ChatApp', 'WhatsApp', 'Telegram') DEFAULT NULL COMMENT 'Tipo de ticket según origen',
  IPOrigen varchar(50) DEFAULT NULL COMMENT 'Dirección IP desde donde se originó',
  DuracionLlamadaSegundos int DEFAULT NULL COMMENT 'Duración total de la llamada en segundos',
  MomentoCorte varchar(100) DEFAULT NULL COMMENT 'Momento en que se cortó la llamada',
  IntentosReconexion int DEFAULT 0 COMMENT 'Número de intentos de reconexión',
  MontoRelacionado decimal(10, 2) DEFAULT NULL COMMENT 'Monto relacionado con el ticket',
  PedidoRelacionado varchar(100) DEFAULT NULL COMMENT 'ID del pedido o transacción',
  RiesgoFraude tinyint(1) DEFAULT 0 COMMENT 'Indica si la IA detectó posible fraude',
  RequiereEscalamiento tinyint(1) DEFAULT 0 COMMENT 'Indica si requiere escalamiento a humano',
  Impacto enum ('Individual', 'Grupal', 'Masivo') DEFAULT 'Individual' COMMENT 'Impacto del ticket',
  CSATScore int DEFAULT NULL COMMENT 'Customer Satisfaction Score (1-5)',
  ResueltoporIA tinyint(1) DEFAULT 0 COMMENT 'Indica si fue resuelto por IA sin intervención humana',
  Idioma varchar(10) DEFAULT 'es' COMMENT 'Idioma del ticket: es, en, etc.',
  ChatId bigint DEFAULT NULL COMMENT 'ID de Telegram del cliente',
  ClienteValidado tinyint(1) DEFAULT 0 COMMENT 'Si el cliente pasÃ³ validaciÃ³n',
  NivelValidacion varchar(50) DEFAULT 'pendiente' COMMENT 'Nivel de validaciÃ³n alcanzado',
  CreditosUsados int DEFAULT 0 COMMENT 'CrÃ©ditos consumidos por este ticket',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 8,
AVG_ROW_LENGTH = 2340,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Tickets de atención al cliente tipo Klarna con procesamiento IA - Módulo 07',
ROW_FORMAT = DYNAMIC;

--
-- Create check constraint
--
ALTER TABLE op_tickets_v2
ADD CONSTRAINT chk_csat_score CHECK (`CSATScore` BETWEEN 1 AND 5);

--
-- Create index `idx_ticket_agente` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_agente (IdAgenteAsignado);

--
-- Create index `idx_ticket_canal` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_canal (Canal);

--
-- Create index `idx_ticket_cliente` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_cliente (IdCliente);

--
-- Create index `idx_ticket_email` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_email (EmailCliente);

--
-- Create index `idx_ticket_escalamiento` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_escalamiento (RequiereEscalamiento);

--
-- Create index `idx_ticket_estado` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_estado (Estado);

--
-- Create index `idx_ticket_fecha_creacion` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_fecha_creacion (FechaCreacion);

--
-- Create index `idx_ticket_idioma` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_idioma (Idioma);

--
-- Create index `idx_ticket_ip` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_ip (IPOrigen);

--
-- Create index `idx_ticket_prioridad` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_prioridad (PrioridadAsignada);

--
-- Create index `idx_ticket_resuelto_ia` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_resuelto_ia (ResueltoporIA);

--
-- Create index `idx_ticket_riesgo` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_riesgo (RiesgoFraude);

--
-- Create index `idx_ticket_sentimiento` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_sentimiento (SentimientoDetectado);

--
-- Create index `idx_ticket_tipo` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_ticket_tipo (TipoTicket);

--
-- Create index `idx_tickets_chat_id` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_tickets_chat_id (ChatId);

--
-- Create index `idx_tickets_cliente_validado` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_tickets_cliente_validado (ClienteValidado);

--
-- Create index `idx_tickets_v2_entidad` on table `op_tickets_v2`
--
ALTER TABLE op_tickets_v2
ADD INDEX idx_tickets_v2_entidad (IdEntidad);

--
-- Create foreign key
--
ALTER TABLE op_tickets_v2
ADD CONSTRAINT fk_tickets_v2_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_ticket_validacion_cliente`
--
CREATE TABLE op_ticket_validacion_cliente (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  TelefonoCliente varchar(50) DEFAULT NULL,
  EmailCliente varchar(255) DEFAULT NULL,
  IPOrigen varchar(50) DEFAULT NULL,
  TieneTicketAbierto tinyint(1) DEFAULT 0,
  IdTicketAbierto int DEFAULT NULL COMMENT 'FK a op_tickets_v2',
  NumeroTicketsHistoricos int DEFAULT 0,
  UltimaInteraccion datetime DEFAULT NULL,
  Bloqueado tinyint(1) DEFAULT 0 COMMENT 'Cliente bloqueado por spam/abuso',
  MotivoBloqueo text DEFAULT NULL,
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Validación de clientes para prevenir duplicados',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_validacion_bloqueado` on table `op_ticket_validacion_cliente`
--
ALTER TABLE op_ticket_validacion_cliente
ADD INDEX idx_validacion_bloqueado (Bloqueado);

--
-- Create index `idx_validacion_email` on table `op_ticket_validacion_cliente`
--
ALTER TABLE op_ticket_validacion_cliente
ADD INDEX idx_validacion_email (EmailCliente);

--
-- Create index `idx_validacion_entidad` on table `op_ticket_validacion_cliente`
--
ALTER TABLE op_ticket_validacion_cliente
ADD INDEX idx_validacion_entidad (IdEntidad);

--
-- Create index `idx_validacion_ip` on table `op_ticket_validacion_cliente`
--
ALTER TABLE op_ticket_validacion_cliente
ADD INDEX idx_validacion_ip (IPOrigen);

--
-- Create index `idx_validacion_telefono` on table `op_ticket_validacion_cliente`
--
ALTER TABLE op_ticket_validacion_cliente
ADD INDEX idx_validacion_telefono (TelefonoCliente);

--
-- Create foreign key
--
ALTER TABLE op_ticket_validacion_cliente
ADD CONSTRAINT op_ticket_validacion_cliente_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_validacion_cliente
ADD CONSTRAINT op_ticket_validacion_cliente_ibfk_2 FOREIGN KEY (IdTicketAbierto)
REFERENCES op_tickets_v2 (Id) ON DELETE SET NULL;

DELIMITER $$

--
-- Create procedure `sp_ValidarClienteDuplicado`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_ValidarClienteDuplicado (IN p_Telefono varchar(50),
IN p_Email varchar(255),
IN p_IP varchar(50),
IN p_IdEntidad int,
OUT p_TieneTicketAbierto boolean,
OUT p_IdTicketAbierto int)
BEGIN
  -- Buscar tickets abiertos del cliente
  SELECT
    COUNT(*) > 0,
    MAX(Id) INTO p_TieneTicketAbierto,
  p_IdTicketAbierto
  FROM op_tickets_v2
  WHERE (
  (p_Telefono IS NOT NULL
  AND TelefonoCliente = p_Telefono)
  OR (p_Email IS NOT NULL
  AND EmailCliente = p_Email)
  OR (p_IP IS NOT NULL
  AND IPOrigen = p_IP)
  )
  AND Estado IN ('Abierto', 'EnProceso')
  AND IdEntidad = p_IdEntidad
  AND Activo = 1;

  -- Actualizar tabla de validación
  INSERT INTO op_ticket_validacion_cliente (IdEntidad,
  TelefonoCliente,
  EmailCliente,
  IPOrigen,
  TieneTicketAbierto,
  IdTicketAbierto,
  UltimaInteraccion,
  IdUsuarioCreacion)
    VALUES (p_IdEntidad, p_Telefono, p_Email, p_IP, p_TieneTicketAbierto, p_IdTicketAbierto, NOW(), 1)
  ON DUPLICATE KEY UPDATE
  TieneTicketAbierto = p_TieneTicketAbierto,
  IdTicketAbierto = p_IdTicketAbierto,
  UltimaInteraccion = NOW(),
  FechaUltimaActualizacion = NOW();
END
$$

DELIMITER ;

--
-- Create table `op_ticket_notificaciones_whatsapp`
--
CREATE TABLE op_ticket_notificaciones_whatsapp (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  IdTicket int NOT NULL COMMENT 'FK a op_tickets_v2',
  NumeroWhatsApp varchar(50) NOT NULL COMMENT 'Número destino con código país',
  TipoNotificacion varchar(100) NOT NULL COMMENT 'TicketCreado, RespuestaAgente, etc.',
  MensajeTexto text NOT NULL COMMENT 'Texto del mensaje a enviar',
  PlantillaId varchar(100) DEFAULT NULL COMMENT 'ID de plantilla de YCloud (opcional)',
  ParametrosPlantilla json DEFAULT NULL COMMENT 'Parámetros para plantilla',
  Estado enum ('Pendiente', 'Enviando', 'Enviado', 'Fallido', 'Cancelado') DEFAULT 'Pendiente',
  IntentosEnvio int DEFAULT 0,
  MaximoIntentos int DEFAULT 3,
  ProximoIntento datetime DEFAULT NULL COMMENT 'Fecha del próximo intento',
  FechaEnvio datetime DEFAULT NULL COMMENT 'Fecha de envío exitoso',
  IdMensajeYCloud varchar(200) DEFAULT NULL COMMENT 'ID del mensaje en YCloud',
  RespuestaYCloudJSON text DEFAULT NULL COMMENT 'Respuesta completa de YCloud',
  MensajeError text DEFAULT NULL,
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Cola de notificaciones WhatsApp',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_notif_entidad` on table `op_ticket_notificaciones_whatsapp`
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD INDEX idx_notif_entidad (IdEntidad);

--
-- Create index `idx_notif_estado` on table `op_ticket_notificaciones_whatsapp`
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD INDEX idx_notif_estado (Estado);

--
-- Create index `idx_notif_fecha_creacion` on table `op_ticket_notificaciones_whatsapp`
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD INDEX idx_notif_fecha_creacion (FechaCreacion);

--
-- Create index `idx_notif_proximo_intento` on table `op_ticket_notificaciones_whatsapp`
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD INDEX idx_notif_proximo_intento (ProximoIntento);

--
-- Create index `idx_notif_ticket` on table `op_ticket_notificaciones_whatsapp`
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD INDEX idx_notif_ticket (IdTicket);

--
-- Create foreign key
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD CONSTRAINT op_ticket_notificaciones_whatsapp_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_notificaciones_whatsapp
ADD CONSTRAINT op_ticket_notificaciones_whatsapp_ibfk_2 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE CASCADE;

DELIMITER $$

--
-- Create procedure `sp_EncolarNotificacionWhatsApp`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_EncolarNotificacionWhatsApp (IN p_IdTicket int,
IN p_NumeroWhatsApp varchar(50),
IN p_TipoNotificacion varchar(100),
IN p_MensajeTexto text,
IN p_IdEntidad int)
BEGIN
  -- Insertar notificación en la cola
  INSERT INTO op_ticket_notificaciones_whatsapp (IdEntidad,
  IdTicket,
  NumeroWhatsApp,
  TipoNotificacion,
  MensajeTexto,
  Estado,
  IntentosEnvio,
  ProximoIntento,
  IdUsuarioCreacion)
    VALUES (p_IdEntidad, p_IdTicket, p_NumeroWhatsApp, p_TipoNotificacion, p_MensajeTexto, 'Pendiente', 0, NOW(), 1);

  -- Retornar el ID de la notificación creada
  SELECT
    LAST_INSERT_ID() AS IdNotificacion;
END
$$

DELIMITER ;

--
-- Create table `op_ticket_logs_sistema`
--
CREATE TABLE op_ticket_logs_sistema (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  IdTicket int DEFAULT NULL COMMENT 'FK a op_tickets_v2 (opcional)',
  TipoEvento varchar(100) NOT NULL COMMENT 'Tipo de evento: TicketCreado, EstadoCambiado, etc.',
  Descripcion text DEFAULT NULL COMMENT 'Descripción del evento',
  Severidad enum ('Info', 'Warning', 'Error', 'Critical') DEFAULT 'Info',
  Metadata json DEFAULT NULL COMMENT 'Datos adicionales en JSON',
  IdUsuarioCreacion int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Auditoría de eventos del sistema de tickets',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_logs_sistema_entidad` on table `op_ticket_logs_sistema`
--
ALTER TABLE op_ticket_logs_sistema
ADD INDEX idx_logs_sistema_entidad (IdEntidad);

--
-- Create index `idx_logs_sistema_fecha` on table `op_ticket_logs_sistema`
--
ALTER TABLE op_ticket_logs_sistema
ADD INDEX idx_logs_sistema_fecha (FechaCreacion);

--
-- Create index `idx_logs_sistema_severidad` on table `op_ticket_logs_sistema`
--
ALTER TABLE op_ticket_logs_sistema
ADD INDEX idx_logs_sistema_severidad (Severidad);

--
-- Create index `idx_logs_sistema_ticket` on table `op_ticket_logs_sistema`
--
ALTER TABLE op_ticket_logs_sistema
ADD INDEX idx_logs_sistema_ticket (IdTicket);

--
-- Create index `idx_logs_sistema_tipo` on table `op_ticket_logs_sistema`
--
ALTER TABLE op_ticket_logs_sistema
ADD INDEX idx_logs_sistema_tipo (TipoEvento);

--
-- Create foreign key
--
ALTER TABLE op_ticket_logs_sistema
ADD CONSTRAINT op_ticket_logs_sistema_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_logs_sistema
ADD CONSTRAINT op_ticket_logs_sistema_ibfk_2 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE SET NULL;

--
-- Create table `op_ticket_logs_interacciones`
--
CREATE TABLE op_ticket_logs_interacciones (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  IdTicket int NOT NULL COMMENT 'FK a op_tickets_v2',
  Canal varchar(50) NOT NULL COMMENT 'VAPI, YCloud, Telegram, ChatWeb, Firebase',
  TipoInteraccion varchar(100) NOT NULL COMMENT 'LlamadaIniciada, MensajeRecibido, etc.',
  IdExternoCanal varchar(200) DEFAULT NULL COMMENT 'ID del mensaje/llamada en el canal externo',
  DatosInteraccion json DEFAULT NULL COMMENT 'Datos completos de la interacción',
  Duracion int DEFAULT NULL COMMENT 'Duración en segundos (para llamadas)',
  Exitosa tinyint(1) DEFAULT 1 COMMENT 'Indica si la interacción fue exitosa',
  MensajeError text DEFAULT NULL COMMENT 'Mensaje de error si falló',
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Tracking de interacciones multicanal',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_logs_interacciones_canal` on table `op_ticket_logs_interacciones`
--
ALTER TABLE op_ticket_logs_interacciones
ADD INDEX idx_logs_interacciones_canal (Canal);

--
-- Create index `idx_logs_interacciones_entidad` on table `op_ticket_logs_interacciones`
--
ALTER TABLE op_ticket_logs_interacciones
ADD INDEX idx_logs_interacciones_entidad (IdEntidad);

--
-- Create index `idx_logs_interacciones_fecha` on table `op_ticket_logs_interacciones`
--
ALTER TABLE op_ticket_logs_interacciones
ADD INDEX idx_logs_interacciones_fecha (FechaCreacion);

--
-- Create index `idx_logs_interacciones_ticket` on table `op_ticket_logs_interacciones`
--
ALTER TABLE op_ticket_logs_interacciones
ADD INDEX idx_logs_interacciones_ticket (IdTicket);

--
-- Create foreign key
--
ALTER TABLE op_ticket_logs_interacciones
ADD CONSTRAINT op_ticket_logs_interacciones_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_logs_interacciones
ADD CONSTRAINT op_ticket_logs_interacciones_ibfk_2 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE CASCADE;

--
-- Create table `op_ticket_logprompts`
--
CREATE TABLE op_ticket_logprompts (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  IdTicket int DEFAULT NULL COMMENT 'FK a op_tickets_v2 (anonimizado)',
  IdPrompt int DEFAULT NULL COMMENT 'FK a conf_ticket_prompts',
  PromptEnviado text NOT NULL COMMENT 'Prompt enviado a la IA (anonimizado)',
  RespuestaIA text DEFAULT NULL COMMENT 'Respuesta de la IA',
  ModeloUtilizado varchar(100) DEFAULT NULL COMMENT 'gpt-4o-mini, gpt-4, etc.',
  TokensUtilizados int DEFAULT NULL COMMENT 'Tokens consumidos',
  TiempoRespuestaMs int DEFAULT NULL COMMENT 'Tiempo de respuesta en milisegundos',
  Exitoso tinyint(1) DEFAULT 1,
  MensajeError text DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Log de prompts enviados a IA (anonimizados)',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_logprompts_entidad` on table `op_ticket_logprompts`
--
ALTER TABLE op_ticket_logprompts
ADD INDEX idx_logprompts_entidad (IdEntidad);

--
-- Create index `idx_logprompts_fecha` on table `op_ticket_logprompts`
--
ALTER TABLE op_ticket_logprompts
ADD INDEX idx_logprompts_fecha (FechaCreacion);

--
-- Create index `idx_logprompts_modelo` on table `op_ticket_logprompts`
--
ALTER TABLE op_ticket_logprompts
ADD INDEX idx_logprompts_modelo (ModeloUtilizado);

--
-- Create index `idx_logprompts_prompt` on table `op_ticket_logprompts`
--
ALTER TABLE op_ticket_logprompts
ADD INDEX idx_logprompts_prompt (IdPrompt);

--
-- Create index `idx_logprompts_ticket` on table `op_ticket_logprompts`
--
ALTER TABLE op_ticket_logprompts
ADD INDEX idx_logprompts_ticket (IdTicket);

--
-- Create foreign key
--
ALTER TABLE op_ticket_logprompts
ADD CONSTRAINT op_ticket_logprompts_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_logprompts
ADD CONSTRAINT op_ticket_logprompts_ibfk_2 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE SET NULL;

--
-- Create table `op_ticket_conversacion`
--
CREATE TABLE op_ticket_conversacion (
  Id int NOT NULL AUTO_INCREMENT,
  IdTicket int NOT NULL COMMENT 'ID del ticket (FK a op_tickets_v2)',
  TipoMensaje varchar(50) NOT NULL COMMENT 'Tipo de mensaje (Cliente, Agente, Sistema, IA)',
  Mensaje text NOT NULL COMMENT 'Contenido del mensaje',
  EsRespuestaIA tinyint(1) DEFAULT 0 COMMENT 'Indica si es una respuesta generada por IA',
  IdUsuarioEnvio int DEFAULT NULL COMMENT 'ID del usuario que envió el mensaje (FK a conf_usuarios)',
  NombreUsuarioEnvio varchar(200) DEFAULT NULL COMMENT 'Nombre del usuario que envió (para clientes externos)',
  FechaEnvio datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha y hora de envío',
  Leido tinyint(1) DEFAULT 0 COMMENT 'Indica si el mensaje ha sido leído',
  FechaLectura datetime DEFAULT NULL COMMENT 'Fecha de lectura del mensaje',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 12,
AVG_ROW_LENGTH = 2048,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Historial de conversación de tickets - Módulo 07',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_conversacion_fecha` on table `op_ticket_conversacion`
--
ALTER TABLE op_ticket_conversacion
ADD INDEX idx_conversacion_fecha (FechaEnvio);

--
-- Create index `idx_conversacion_ticket` on table `op_ticket_conversacion`
--
ALTER TABLE op_ticket_conversacion
ADD INDEX idx_conversacion_ticket (IdTicket);

--
-- Create index `idx_conversacion_tipo` on table `op_ticket_conversacion`
--
ALTER TABLE op_ticket_conversacion
ADD INDEX idx_conversacion_tipo (TipoMensaje);

--
-- Create foreign key
--
ALTER TABLE op_ticket_conversacion
ADD CONSTRAINT op_ticket_conversacion_ibfk_1 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE CASCADE;

--
-- Create table `op_ticket_archivos`
--
CREATE TABLE op_ticket_archivos (
  Id int NOT NULL AUTO_INCREMENT,
  IdTicket int NOT NULL COMMENT 'ID del ticket (FK a op_tickets_v2)',
  IdMensajeConversacion int DEFAULT NULL COMMENT 'ID del mensaje de conversación asociado (FK a op_ticket_conversacion)',
  NombreArchivo varchar(255) NOT NULL COMMENT 'Nombre original del archivo',
  NombreArchivoServidor varchar(255) NOT NULL COMMENT 'Nombre del archivo en el servidor',
  RutaArchivo varchar(500) NOT NULL COMMENT 'Ruta completa del archivo',
  TipoMime varchar(100) DEFAULT NULL COMMENT 'Tipo MIME del archivo',
  TamanioBytes bigint DEFAULT NULL COMMENT 'Tamaño del archivo en bytes',
  IdUsuarioSubida int DEFAULT NULL COMMENT 'ID del usuario que subió el archivo',
  FechaSubida datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de subida',
  Activo tinyint(1) DEFAULT 1 COMMENT 'Indica si el archivo está activo',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Archivos adjuntos de tickets - Módulo 07',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_archivos_mensaje` on table `op_ticket_archivos`
--
ALTER TABLE op_ticket_archivos
ADD INDEX idx_archivos_mensaje (IdMensajeConversacion);

--
-- Create index `idx_archivos_ticket` on table `op_ticket_archivos`
--
ALTER TABLE op_ticket_archivos
ADD INDEX idx_archivos_ticket (IdTicket);

--
-- Create foreign key
--
ALTER TABLE op_ticket_archivos
ADD CONSTRAINT op_ticket_archivos_ibfk_1 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_ticket_archivos
ADD CONSTRAINT op_ticket_archivos_ibfk_2 FOREIGN KEY (IdMensajeConversacion)
REFERENCES op_ticket_conversacion (Id) ON DELETE SET NULL;

--
-- Create table `op_ticket_acciones`
--
CREATE TABLE op_ticket_acciones (
  Id int NOT NULL AUTO_INCREMENT,
  IdTicket int NOT NULL COMMENT 'ID del ticket (FK a op_tickets_v2)',
  TipoAccion varchar(100) NOT NULL COMMENT 'Tipo de acción (Creacion, Asignacion, CambioEstado, Resolucion, Escalacion, etc.)',
  Descripcion text DEFAULT NULL COMMENT 'Descripción de la acción',
  ValorAnterior varchar(255) DEFAULT NULL COMMENT 'Valor anterior (para cambios)',
  ValorNuevo varchar(255) DEFAULT NULL COMMENT 'Valor nuevo (para cambios)',
  IdUsuarioAccion int DEFAULT NULL COMMENT 'ID del usuario que realizó la acción (FK a conf_usuarios)',
  EsAccionIA tinyint(1) DEFAULT 0 COMMENT 'Indica si la acción fue realizada por IA',
  FechaAccion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha y hora de la acción',
  Metadata text DEFAULT NULL COMMENT 'Metadatos adicionales en JSON',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 11,
AVG_ROW_LENGTH = 2048,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Historial de acciones realizadas en tickets - Módulo 07',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_acciones_fecha` on table `op_ticket_acciones`
--
ALTER TABLE op_ticket_acciones
ADD INDEX idx_acciones_fecha (FechaAccion);

--
-- Create index `idx_acciones_ticket` on table `op_ticket_acciones`
--
ALTER TABLE op_ticket_acciones
ADD INDEX idx_acciones_ticket (IdTicket);

--
-- Create index `idx_acciones_tipo` on table `op_ticket_acciones`
--
ALTER TABLE op_ticket_acciones
ADD INDEX idx_acciones_tipo (TipoAccion);

--
-- Create foreign key
--
ALTER TABLE op_ticket_acciones
ADD CONSTRAINT op_ticket_acciones_ibfk_1 FOREIGN KEY (IdTicket)
REFERENCES op_tickets_v2 (Id) ON DELETE CASCADE;

--
-- Create table `op_ticket_robot_monitoreo`
--
CREATE TABLE op_ticket_robot_monitoreo (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  FechaEjecucion datetime NOT NULL COMMENT 'Fecha/hora de ejecución',
  TipoMonitoreo varchar(100) NOT NULL COMMENT 'TicketsSinAtender, TicketsVencidos, etc.',
  TicketsDetectados int DEFAULT 0 COMMENT 'Número de tickets detectados',
  AccionesRealizadas int DEFAULT 0 COMMENT 'Número de acciones tomadas',
  NotificacionesEnviadas int DEFAULT 0,
  TiempoEjecucionMs int DEFAULT NULL COMMENT 'Tiempo de ejecución en milisegundos',
  Exitoso tinyint(1) DEFAULT 1,
  MensajeError text DEFAULT NULL,
  DetallesJSON json DEFAULT NULL COMMENT 'Detalles de la ejecución',
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Tracking de ejecuciones del robot de monitoreo',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_robot_entidad` on table `op_ticket_robot_monitoreo`
--
ALTER TABLE op_ticket_robot_monitoreo
ADD INDEX idx_robot_entidad (IdEntidad);

--
-- Create index `idx_robot_exitoso` on table `op_ticket_robot_monitoreo`
--
ALTER TABLE op_ticket_robot_monitoreo
ADD INDEX idx_robot_exitoso (Exitoso);

--
-- Create index `idx_robot_fecha` on table `op_ticket_robot_monitoreo`
--
ALTER TABLE op_ticket_robot_monitoreo
ADD INDEX idx_robot_fecha (FechaEjecucion);

--
-- Create index `idx_robot_tipo` on table `op_ticket_robot_monitoreo`
--
ALTER TABLE op_ticket_robot_monitoreo
ADD INDEX idx_robot_tipo (TipoMonitoreo);

--
-- Create foreign key
--
ALTER TABLE op_ticket_robot_monitoreo
ADD CONSTRAINT op_ticket_robot_monitoreo_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_ticket_metricas`
--
CREATE TABLE op_ticket_metricas (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  FechaMetrica date NOT NULL COMMENT 'Fecha de la métrica',
  TipoAgregacion enum ('Diaria', 'Semanal', 'Mensual') DEFAULT 'Diaria',
  Canal varchar(50) DEFAULT NULL COMMENT 'Canal específico o NULL para todos',
  TotalTicketsCreados int DEFAULT 0,
  TotalTicketsResueltos int DEFAULT 0,
  TotalTicketsResueltosIA int DEFAULT 0,
  PorcentajeResolucionIA decimal(5, 2) DEFAULT 0.00,
  TiempoPromedioResolucionMinutos decimal(10, 2) DEFAULT NULL,
  TiempoPromedioRespuestaMinutos decimal(10, 2) DEFAULT NULL,
  CSATPromedio decimal(3, 2) DEFAULT NULL COMMENT 'Promedio de satisfacción',
  TotalLlamadasVAPI int DEFAULT 0,
  TotalMensajesWhatsApp int DEFAULT 0,
  TotalChatWeb int DEFAULT 0,
  TotalChatApp int DEFAULT 0,
  TokensIAUtilizados int DEFAULT 0,
  CostoEstimadoIA decimal(10, 4) DEFAULT 0.0000,
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Métricas agregadas del sistema de tickets',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_metricas_entidad` on table `op_ticket_metricas`
--
ALTER TABLE op_ticket_metricas
ADD INDEX idx_metricas_entidad (IdEntidad);

--
-- Create index `idx_metricas_fecha` on table `op_ticket_metricas`
--
ALTER TABLE op_ticket_metricas
ADD INDEX idx_metricas_fecha (FechaMetrica);

--
-- Create index `idx_metricas_tipo` on table `op_ticket_metricas`
--
ALTER TABLE op_ticket_metricas
ADD INDEX idx_metricas_tipo (TipoAgregacion);

--
-- Create index `uk_metrica_fecha_canal` on table `op_ticket_metricas`
--
ALTER TABLE op_ticket_metricas
ADD UNIQUE INDEX uk_metrica_fecha_canal (IdEntidad, FechaMetrica, TipoAgregacion, Canal);

--
-- Create foreign key
--
ALTER TABLE op_ticket_metricas
ADD CONSTRAINT op_ticket_metricas_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

DELIMITER $$

--
-- Create procedure `sp_CalcularMetricasDiarias`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_CalcularMetricasDiarias (IN p_Fecha date,
IN p_IdEntidad int)
BEGIN
  -- Calcular métricas del día
  INSERT INTO op_ticket_metricas (IdEntidad,
  FechaMetrica,
  TipoAgregacion,
  TotalTicketsCreados,
  TotalTicketsResueltos,
  TotalTicketsResueltosIA,
  PorcentajeResolucionIA,
  TiempoPromedioResolucionMinutos,
  CSATPromedio,
  IdUsuarioCreacion)
    SELECT
      p_IdEntidad,
      p_Fecha,
      'Diaria',
      COUNT(*) AS TotalTicketsCreados,
      SUM(CASE WHEN Estado = 'Resuelto' THEN 1 ELSE 0 END) AS TotalTicketsResueltos,
      SUM(CASE WHEN ResueltoporIA = 1 THEN 1 ELSE 0 END) AS TotalTicketsResueltosIA,
      CASE WHEN COUNT(*) > 0 THEN (SUM(CASE WHEN ResueltoporIA = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*)) ELSE 0 END AS PorcentajeResolucionIA,
      AVG(CASE WHEN TiempoResolucionMinutos IS NOT NULL THEN TiempoResolucionMinutos ELSE NULL END) AS TiempoPromedioResolucionMinutos,
      AVG(CASE WHEN CSATScore IS NOT NULL THEN CSATScore ELSE NULL END) AS CSATPromedio,
      1
    FROM op_tickets_v2
    WHERE DATE(FechaCreacion) = p_Fecha
    AND IdEntidad = p_IdEntidad
    AND Activo = 1
  ON DUPLICATE KEY UPDATE
  TotalTicketsCreados = VALUES(TotalTicketsCreados),
  TotalTicketsResueltos = VALUES(TotalTicketsResueltos),
  TotalTicketsResueltosIA = VALUES(TotalTicketsResueltosIA),
  PorcentajeResolucionIA = VALUES(PorcentajeResolucionIA),
  TiempoPromedioResolucionMinutos = VALUES(TiempoPromedioResolucionMinutos),
  CSATPromedio = VALUES(CSATPromedio),
  FechaUltimaActualizacion = NOW();

  -- Retornar las métricas calculadas
  SELECT
    FechaMetrica,
    TotalTicketsCreados,
    TotalTicketsResueltos,
    TotalTicketsResueltosIA,
    PorcentajeResolucionIA,
    TiempoPromedioResolucionMinutos,
    CSATPromedio
  FROM op_ticket_metricas
  WHERE FechaMetrica = p_Fecha
  AND IdEntidad = p_IdEntidad
  AND TipoAgregacion = 'Diaria';
END
$$

DELIMITER ;

--
-- Create table `op_telegram_whitelist`
--
CREATE TABLE op_telegram_whitelist (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  ChatId bigint NOT NULL,
  ClienteNombre varchar(255) NOT NULL,
  Email varchar(255) DEFAULT NULL,
  Empresa varchar(255) DEFAULT NULL,
  FechaAprobacion datetime DEFAULT CURRENT_TIMESTAMP,
  AprobadoPor varchar(100) DEFAULT NULL COMMENT 'Usuario que aprobó',
  Notas text DEFAULT NULL COMMENT 'Notas sobre la aprobación',
  Prioridad enum ('alta', 'media', 'baja') DEFAULT 'media',
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Clientes pre-aprobados (whitelist)',
ROW_FORMAT = DYNAMIC;

--
-- Create index `ChatId` on table `op_telegram_whitelist`
--
ALTER TABLE op_telegram_whitelist
ADD UNIQUE INDEX ChatId (ChatId);

--
-- Create index `idx_whitelist_activo` on table `op_telegram_whitelist`
--
ALTER TABLE op_telegram_whitelist
ADD INDEX idx_whitelist_activo (Activo);

--
-- Create index `idx_whitelist_entidad` on table `op_telegram_whitelist`
--
ALTER TABLE op_telegram_whitelist
ADD INDEX idx_whitelist_entidad (IdEntidad);

--
-- Create index `idx_whitelist_prioridad` on table `op_telegram_whitelist`
--
ALTER TABLE op_telegram_whitelist
ADD INDEX idx_whitelist_prioridad (Prioridad);

--
-- Create index `uk_whitelist_chat_id` on table `op_telegram_whitelist`
--
ALTER TABLE op_telegram_whitelist
ADD UNIQUE INDEX uk_whitelist_chat_id (ChatId);

--
-- Create foreign key
--
ALTER TABLE op_telegram_whitelist
ADD CONSTRAINT op_telegram_whitelist_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_telegram_logs_validacion`
--
CREATE TABLE op_telegram_logs_validacion (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  ChatId bigint NOT NULL,
  FechaValidacion datetime DEFAULT CURRENT_TIMESTAMP,
  Resultado enum ('aprobado', 'rechazado', 'pendiente') NOT NULL,
  NivelAlcanzado varchar(50) DEFAULT NULL COMMENT 'Nivel de validación alcanzado (1-4)',
  RazonRechazo text DEFAULT NULL COMMENT 'Razón del rechazo si aplica',
  IPOrigen varchar(50) DEFAULT NULL,
  Metadata json DEFAULT NULL COMMENT 'Información adicional en formato JSON',
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Logs de validación de clientes Telegram',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_telegram_logs_chat_fecha` on table `op_telegram_logs_validacion`
--
ALTER TABLE op_telegram_logs_validacion
ADD INDEX idx_telegram_logs_chat_fecha (ChatId, FechaValidacion DESC);

--
-- Create index `idx_telegram_logs_chat_id` on table `op_telegram_logs_validacion`
--
ALTER TABLE op_telegram_logs_validacion
ADD INDEX idx_telegram_logs_chat_id (ChatId);

--
-- Create index `idx_telegram_logs_entidad` on table `op_telegram_logs_validacion`
--
ALTER TABLE op_telegram_logs_validacion
ADD INDEX idx_telegram_logs_entidad (IdEntidad);

--
-- Create index `idx_telegram_logs_fecha` on table `op_telegram_logs_validacion`
--
ALTER TABLE op_telegram_logs_validacion
ADD INDEX idx_telegram_logs_fecha (FechaValidacion DESC);

--
-- Create index `idx_telegram_logs_resultado` on table `op_telegram_logs_validacion`
--
ALTER TABLE op_telegram_logs_validacion
ADD INDEX idx_telegram_logs_resultado (Resultado);

--
-- Create foreign key
--
ALTER TABLE op_telegram_logs_validacion
ADD CONSTRAINT op_telegram_logs_validacion_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_telegram_clientes`
--
CREATE TABLE op_telegram_clientes (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  ChatId bigint NOT NULL COMMENT 'ID de Telegram del cliente',
  Username varchar(255) DEFAULT NULL COMMENT 'Username de Telegram (@usuario)',
  FirstName varchar(255) DEFAULT NULL,
  LastName varchar(255) DEFAULT NULL,
  EstadoCliente varchar(20) DEFAULT 'activo' COMMENT 'activo, bloqueado, suspendido',
  TipoCliente varchar(20) DEFAULT 'standard' COMMENT 'standard, premium, trial',
  FechaVencimiento date DEFAULT NULL COMMENT 'Fecha de vencimiento de licencia',
  CreditosDisponibles int DEFAULT 0 COMMENT 'Créditos disponibles para tickets',
  TicketsMesActual int DEFAULT 0 COMMENT 'Tickets creados en el mes actual',
  LimiteTicketsMes int DEFAULT 50 COMMENT 'Límite mensual de tickets',
  UltimaActividad datetime DEFAULT NULL,
  RazonBloqueo text DEFAULT NULL,
  BloqueadoPor varchar(100) DEFAULT NULL,
  FechaBloqueo datetime DEFAULT NULL,
  IntentosFallidos int DEFAULT 0 COMMENT 'Intentos fallidos de validación',
  IPUltimoAcceso varchar(50) DEFAULT NULL,
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Clientes registrados de Telegram',
ROW_FORMAT = DYNAMIC;

--
-- Create index `ChatId` on table `op_telegram_clientes`
--
ALTER TABLE op_telegram_clientes
ADD UNIQUE INDEX ChatId (ChatId);

--
-- Create index `idx_telegram_entidad` on table `op_telegram_clientes`
--
ALTER TABLE op_telegram_clientes
ADD INDEX idx_telegram_entidad (IdEntidad);

--
-- Create index `idx_telegram_estado` on table `op_telegram_clientes`
--
ALTER TABLE op_telegram_clientes
ADD INDEX idx_telegram_estado (EstadoCliente);

--
-- Create index `idx_telegram_tipo` on table `op_telegram_clientes`
--
ALTER TABLE op_telegram_clientes
ADD INDEX idx_telegram_tipo (TipoCliente);

--
-- Create index `idx_telegram_username` on table `op_telegram_clientes`
--
ALTER TABLE op_telegram_clientes
ADD INDEX idx_telegram_username (Username);

--
-- Create index `uk_telegram_chat_id` on table `op_telegram_clientes`
--
ALTER TABLE op_telegram_clientes
ADD UNIQUE INDEX uk_telegram_chat_id (ChatId);

--
-- Create foreign key
--
ALTER TABLE op_telegram_clientes
ADD CONSTRAINT op_telegram_clientes_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_telegram_blacklist`
--
CREATE TABLE op_telegram_blacklist (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  ChatId bigint NOT NULL,
  Username varchar(255) DEFAULT NULL,
  RazonBloqueo text NOT NULL,
  FechaBloqueo datetime DEFAULT CURRENT_TIMESTAMP,
  BloqueadoPor varchar(100) DEFAULT NULL COMMENT 'Usuario que bloqueó',
  Permanente tinyint(1) DEFAULT 0,
  FechaLevantamiento datetime DEFAULT NULL COMMENT 'Fecha de levantamiento si es temporal',
  NotasAdicionales text DEFAULT NULL,
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaUltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Clientes bloqueados (blacklist)',
ROW_FORMAT = DYNAMIC;

--
-- Create index `ChatId` on table `op_telegram_blacklist`
--
ALTER TABLE op_telegram_blacklist
ADD UNIQUE INDEX ChatId (ChatId);

--
-- Create index `idx_blacklist_entidad` on table `op_telegram_blacklist`
--
ALTER TABLE op_telegram_blacklist
ADD INDEX idx_blacklist_entidad (IdEntidad);

--
-- Create index `idx_blacklist_fecha_levantamiento` on table `op_telegram_blacklist`
--
ALTER TABLE op_telegram_blacklist
ADD INDEX idx_blacklist_fecha_levantamiento (FechaLevantamiento);

--
-- Create index `idx_blacklist_permanente` on table `op_telegram_blacklist`
--
ALTER TABLE op_telegram_blacklist
ADD INDEX idx_blacklist_permanente (Permanente);

--
-- Create index `uk_blacklist_chat_id` on table `op_telegram_blacklist`
--
ALTER TABLE op_telegram_blacklist
ADD UNIQUE INDEX uk_blacklist_chat_id (ChatId);

--
-- Create foreign key
--
ALTER TABLE op_telegram_blacklist
ADD CONSTRAINT op_telegram_blacklist_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `conf_usuarios`
--
CREATE TABLE conf_usuarios (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Username varchar(50) NOT NULL,
  PasswordHash varchar(255) NOT NULL,
  Nombre varchar(100) NOT NULL,
  Activo tinyint(1) DEFAULT 1,
  CreadoEn timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  email varchar(50) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 4,
AVG_ROW_LENGTH = 5461,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_usuarios_entidad` on table `conf_usuarios`
--
ALTER TABLE conf_usuarios
ADD INDEX idx_usuarios_entidad (IdEntidad);

--
-- Create index `uk_usuario_entidad` on table `conf_usuarios`
--
ALTER TABLE conf_usuarios
ADD UNIQUE INDEX uk_usuario_entidad (IdEntidad, Username);

--
-- Create foreign key
--
ALTER TABLE conf_usuarios
ADD CONSTRAINT fk_usuarios_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_ticket_prompt_ajustes_log`
--
CREATE TABLE op_ticket_prompt_ajustes_log (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  IdPrompt int NOT NULL COMMENT 'FK a conf_ticket_prompts',
  FechaAjuste datetime NOT NULL COMMENT 'Fecha del ajuste',
  VersionAnterior text NOT NULL COMMENT 'Versión anterior del prompt',
  VersionNueva text NOT NULL COMMENT 'Versión nueva del prompt',
  MotivoAjuste text DEFAULT NULL COMMENT 'Razón del ajuste',
  MetricasAntes json DEFAULT NULL COMMENT 'Métricas antes del ajuste',
  MetricasDespues json DEFAULT NULL COMMENT 'Métricas después del ajuste',
  MejoraDetectada tinyint(1) DEFAULT NULL COMMENT 'Si hubo mejora o no',
  PorcentajeMejora decimal(5, 2) DEFAULT NULL,
  Aprobado tinyint(1) DEFAULT 0 COMMENT 'Si el ajuste fue aprobado',
  IdUsuarioAprobacion int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaAprobacion datetime DEFAULT NULL,
  IdUsuarioCreacion int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Log de ajustes automáticos de prompts',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_ajustes_aprobado` on table `op_ticket_prompt_ajustes_log`
--
ALTER TABLE op_ticket_prompt_ajustes_log
ADD INDEX idx_ajustes_aprobado (Aprobado);

--
-- Create index `idx_ajustes_entidad` on table `op_ticket_prompt_ajustes_log`
--
ALTER TABLE op_ticket_prompt_ajustes_log
ADD INDEX idx_ajustes_entidad (IdEntidad);

--
-- Create index `idx_ajustes_fecha` on table `op_ticket_prompt_ajustes_log`
--
ALTER TABLE op_ticket_prompt_ajustes_log
ADD INDEX idx_ajustes_fecha (FechaAjuste);

--
-- Create index `idx_ajustes_prompt` on table `op_ticket_prompt_ajustes_log`
--
ALTER TABLE op_ticket_prompt_ajustes_log
ADD INDEX idx_ajustes_prompt (IdPrompt);

--
-- Create foreign key
--
ALTER TABLE op_ticket_prompt_ajustes_log
ADD CONSTRAINT op_ticket_prompt_ajustes_log_ibfk_1 FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_prompt_ajustes_log
ADD CONSTRAINT op_ticket_prompt_ajustes_log_ibfk_2 FOREIGN KEY (IdUsuarioAprobacion)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL;

--
-- Create table `op_comunicados`
--
CREATE TABLE op_comunicados (
  Id int NOT NULL AUTO_INCREMENT,
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades',
  SubEntidadId int DEFAULT NULL COMMENT 'FK a cat_sub_entidades (si Destinatarios=Seccion)',
  Titulo varchar(200) NOT NULL COMMENT 'TÃ­tulo del comunicado',
  Contenido text NOT NULL COMMENT 'Contenido del comunicado',
  Resumen varchar(500) DEFAULT NULL COMMENT 'Resumen para notificaciones',
  TipoComunicado enum ('Aviso', 'Urgente', 'Mantenimiento', 'Evento', 'Asamblea', 'Cobranza', 'General') DEFAULT 'General',
  Prioridad enum ('Baja', 'Normal', 'Alta', 'Urgente') DEFAULT 'Normal',
  FechaPublicacion datetime NOT NULL COMMENT 'Fecha de publicaciÃ³n',
  FechaExpiracion datetime DEFAULT NULL COMMENT 'Fecha de expiraciÃ³n',
  EnviarEmail tinyint(1) DEFAULT 0,
  EnviarTelegram tinyint(1) DEFAULT 0,
  EnviarPush tinyint(1) DEFAULT 0,
  EnviarSMS tinyint(1) DEFAULT 0,
  Destinatarios enum ('Todos', 'Propietarios', 'Inquilinos', 'Morosos', 'Seccion', 'Unidades') DEFAULT 'Todos',
  UnidadesDestino text DEFAULT NULL COMMENT 'IDs de unidades separados por coma (si Destinatarios=Unidades)',
  ArchivoAdjuntoPath varchar(500) DEFAULT NULL COMMENT 'Archivo adjunto',
  ImagenPath varchar(500) DEFAULT NULL COMMENT 'Imagen del comunicado',
  Estado enum ('Borrador', 'Programado', 'Publicado', 'Expirado', 'Cancelado') DEFAULT 'Borrador',
  TotalDestinatarios int DEFAULT 0 COMMENT 'Total de destinatarios',
  TotalLeidos int DEFAULT 0 COMMENT 'Total que han leÃ­do',
  TotalEmailEnviados int DEFAULT 0,
  TotalTelegramEnviados int DEFAULT 0,
  CreadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  PublicadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Comunicados y avisos a residentes',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_Destinatarios` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_Destinatarios (Destinatarios);

--
-- Create index `idx_EntidadId` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_Estado` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_Estado (Estado);

--
-- Create index `idx_FechaExpiracion` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_FechaExpiracion (FechaExpiracion);

--
-- Create index `idx_FechaPublicacion` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_FechaPublicacion (FechaPublicacion);

--
-- Create index `idx_Prioridad` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_Prioridad (Prioridad);

--
-- Create index `idx_SubEntidadId` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_SubEntidadId (SubEntidadId);

--
-- Create index `idx_TipoComunicado` on table `op_comunicados`
--
ALTER TABLE op_comunicados
ADD INDEX idx_TipoComunicado (TipoComunicado);

--
-- Create foreign key
--
ALTER TABLE op_comunicados
ADD CONSTRAINT fk_comunicados_creado FOREIGN KEY (CreadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_comunicados
ADD CONSTRAINT fk_comunicados_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_comunicados
ADD CONSTRAINT fk_comunicados_publicado FOREIGN KEY (PublicadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_comunicados
ADD CONSTRAINT fk_comunicados_subentidad FOREIGN KEY (SubEntidadId)
REFERENCES cat_sub_entidades (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create table `conf_ticket_prompts`
--
CREATE TABLE conf_ticket_prompts (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  NombrePrompt varchar(100) NOT NULL COMMENT 'Nombre único del prompt (ej: AnalisisTicket, ResolucionTicket)',
  Descripcion varchar(500) DEFAULT NULL COMMENT 'Descripción del propósito del prompt',
  ContenidoPrompt text NOT NULL COMMENT 'Contenido completo del prompt para la IA',
  Activo tinyint(1) DEFAULT 1 COMMENT 'Indica si el prompt está activo y disponible para uso',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación del prompt',
  UltimaActualizacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Fecha de última actualización',
  IdUsuarioCreacion int DEFAULT NULL COMMENT 'ID del usuario que creó el prompt (FK a conf_usuarios)',
  IdUsuarioActualizacion int DEFAULT NULL COMMENT 'ID del usuario que actualizó el prompt (FK a conf_usuarios)',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 3,
AVG_ROW_LENGTH = 8192,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Configuración de prompts para procesamiento de tickets con IA',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_prompt_activo` on table `conf_ticket_prompts`
--
ALTER TABLE conf_ticket_prompts
ADD INDEX idx_prompt_activo (Activo);

--
-- Create index `idx_prompt_nombre` on table `conf_ticket_prompts`
--
ALTER TABLE conf_ticket_prompts
ADD INDEX idx_prompt_nombre (NombrePrompt);

--
-- Create index `idx_prompts_entidad` on table `conf_ticket_prompts`
--
ALTER TABLE conf_ticket_prompts
ADD INDEX idx_prompts_entidad (IdEntidad);

--
-- Create index `uk_prompt_entidad` on table `conf_ticket_prompts`
--
ALTER TABLE conf_ticket_prompts
ADD UNIQUE INDEX uk_prompt_entidad (IdEntidad, NombrePrompt);

--
-- Create foreign key
--
ALTER TABLE conf_ticket_prompts
ADD CONSTRAINT conf_ticket_prompts_ibfk_1 FOREIGN KEY (IdUsuarioCreacion)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL;

--
-- Create foreign key
--
ALTER TABLE conf_ticket_prompts
ADD CONSTRAINT conf_ticket_prompts_ibfk_2 FOREIGN KEY (IdUsuarioActualizacion)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL;

--
-- Create foreign key
--
ALTER TABLE conf_ticket_prompts
ADD CONSTRAINT fk_prompts_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_conceptos_cuota`
--
CREATE TABLE cat_conceptos_cuota (
  Id int NOT NULL AUTO_INCREMENT,
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades (Condominio)',
  Clave varchar(20) NOT NULL COMMENT 'CÃ³digo Ãºnico: MANT, AGUA, EXTRA',
  Nombre varchar(100) NOT NULL COMMENT 'Cuota de Mantenimiento, Agua, Extraordinaria',
  Descripcion text DEFAULT NULL,
  TipoCuota enum ('Ordinaria', 'Extraordinaria', 'Servicio', 'Multa', 'Otro') DEFAULT 'Ordinaria',
  MontoBase decimal(12, 2) DEFAULT 0.00 COMMENT 'Monto base por defecto',
  EsRecurrente tinyint(1) DEFAULT 1 COMMENT '1=Se genera automÃ¡ticamente cada periodo',
  Periodicidad enum ('Mensual', 'Bimestral', 'Trimestral', 'Semestral', 'Anual', 'Unico') DEFAULT 'Mensual',
  DiaVencimiento int DEFAULT 10 COMMENT 'DÃ­a del mes para vencimiento',
  AplicaRecargo tinyint(1) DEFAULT 1 COMMENT '1=Aplica recargo por mora',
  PorcentajeRecargo decimal(5, 2) DEFAULT 5.00 COMMENT 'Porcentaje de recargo mensual',
  DiasGracia int DEFAULT 5 COMMENT 'DÃ­as de gracia antes de recargo',
  AplicaDescuentoProntoPago tinyint(1) DEFAULT 0,
  PorcentajeDescuento decimal(5, 2) DEFAULT 0.00,
  DiaLimiteDescuento int DEFAULT 5 COMMENT 'DÃ­a lÃ­mite para descuento',
  CuentaContable varchar(20) DEFAULT NULL COMMENT 'Cuenta contable asociada',
  CreadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  ModificadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  Activo tinyint(1) DEFAULT 1,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'CatÃ¡logo de conceptos de cuotas',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_Activo` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD INDEX idx_Activo (Activo);

--
-- Create index `idx_Clave` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD INDEX idx_Clave (Clave);

--
-- Create index `idx_CreadoPor` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD INDEX idx_CreadoPor (CreadoPor);

--
-- Create index `idx_EntidadId` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_EsRecurrente` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD INDEX idx_EsRecurrente (EsRecurrente);

--
-- Create index `idx_TipoCuota` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD INDEX idx_TipoCuota (TipoCuota);

--
-- Create index `uk_Entidad_Clave` on table `cat_conceptos_cuota`
--
ALTER TABLE cat_conceptos_cuota
ADD UNIQUE INDEX uk_Entidad_Clave (EntidadId, Clave);

--
-- Create foreign key
--
ALTER TABLE cat_conceptos_cuota
ADD CONSTRAINT fk_conceptos_cuota_creado FOREIGN KEY (CreadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_conceptos_cuota
ADD CONSTRAINT fk_conceptos_cuota_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_conceptos_cuota
ADD CONSTRAINT fk_conceptos_cuota_modificado FOREIGN KEY (ModificadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create table `cat_areas_comunes`
--
CREATE TABLE cat_areas_comunes (
  Id int NOT NULL AUTO_INCREMENT,
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades (Condominio)',
  SubEntidadId int DEFAULT NULL COMMENT 'FK a cat_sub_entidades (NULL=Ã¡rea compartida de toda la entidad)',
  Clave varchar(20) NOT NULL COMMENT 'CÃ³digo Ãºnico: SAL, ALB, GIM',
  Nombre varchar(100) NOT NULL COMMENT 'SalÃ³n de Fiestas, Alberca, Gimnasio',
  TipoArea enum ('Salon', 'Alberca', 'Gimnasio', 'Jardin', 'Terraza', 'Asador', 'Ludoteca', 'SalaJuntas', 'Estacionamiento', 'Cancha', 'Otro') DEFAULT 'Salon',
  Descripcion text DEFAULT NULL,
  Ubicacion varchar(200) DEFAULT NULL COMMENT 'UbicaciÃ³n dentro del condominio',
  Capacidad int DEFAULT NULL COMMENT 'Capacidad mÃ¡xima de personas',
  CostoReservacion decimal(12, 2) DEFAULT 0.00 COMMENT 'Costo por reservar',
  DepositoRequerido decimal(12, 2) DEFAULT 0.00 COMMENT 'DepÃ³sito reembolsable',
  RequiereReservacion tinyint(1) DEFAULT 1 COMMENT '1=Requiere reservaciÃ³n previa',
  HoraApertura time DEFAULT '08:00:00' COMMENT 'Hora de apertura',
  HoraCierre time DEFAULT '22:00:00' COMMENT 'Hora de cierre',
  DiasDisponibles varchar(20) DEFAULT 'L,M,X,J,V,S,D' COMMENT 'DÃ­as disponibles',
  DuracionMinimaHoras int DEFAULT 2 COMMENT 'DuraciÃ³n mÃ­nima de reservaciÃ³n',
  DuracionMaximaHoras int DEFAULT 8 COMMENT 'DuraciÃ³n mÃ¡xima de reservaciÃ³n',
  AnticipacionMinimaDias int DEFAULT 1 COMMENT 'DÃ­as de anticipaciÃ³n mÃ­nima',
  AnticipacionMaximaDias int DEFAULT 30 COMMENT 'DÃ­as de anticipaciÃ³n mÃ¡xima',
  ImagenPath varchar(500) DEFAULT NULL,
  Reglamento text DEFAULT NULL COMMENT 'Reglas de uso del Ã¡rea',
  CreadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  ModificadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  Activo tinyint(1) DEFAULT 1,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'CatÃ¡logo de Ã¡reas comunes del condominio (salones, albercas, gimnasios)',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_Activo` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_Activo (Activo);

--
-- Create index `idx_Clave` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_Clave (Clave);

--
-- Create index `idx_CreadoPor` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_CreadoPor (CreadoPor);

--
-- Create index `idx_EntidadId` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_RequiereReservacion` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_RequiereReservacion (RequiereReservacion);

--
-- Create index `idx_SubEntidadId` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_SubEntidadId (SubEntidadId);

--
-- Create index `idx_TipoArea` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD INDEX idx_TipoArea (TipoArea);

--
-- Create index `uk_Entidad_Clave` on table `cat_areas_comunes`
--
ALTER TABLE cat_areas_comunes
ADD UNIQUE INDEX uk_Entidad_Clave (EntidadId, Clave);

--
-- Create foreign key
--
ALTER TABLE cat_areas_comunes
ADD CONSTRAINT fk_areas_comunes_creado FOREIGN KEY (CreadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_areas_comunes
ADD CONSTRAINT fk_areas_comunes_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_areas_comunes
ADD CONSTRAINT fk_areas_comunes_modificado FOREIGN KEY (ModificadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_areas_comunes
ADD CONSTRAINT fk_areas_comunes_subentidad FOREIGN KEY (SubEntidadId)
REFERENCES cat_sub_entidades (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create view `vw_areas_disponibles_reservacion`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_areas_disponibles_reservacion
AS
SELECT
  `ac`.`Id` AS `AreaComunId`,
  `ac`.`EntidadId` AS `EntidadId`,
  `e`.`RazonSocial` AS `EntidadNombre`,
  `ac`.`SubEntidadId` AS `SubEntidadId`,
  `se`.`RazonSocial` AS `SubEntidadNombre`,
  `ac`.`Clave` AS `Clave`,
  `ac`.`Nombre` AS `AreaNombre`,
  `ac`.`TipoArea` AS `TipoArea`,
  `ac`.`Descripcion` AS `Descripcion`,
  `ac`.`Ubicacion` AS `Ubicacion`,
  `ac`.`Capacidad` AS `Capacidad`,
  `ac`.`CostoReservacion` AS `CostoReservacion`,
  `ac`.`DepositoRequerido` AS `DepositoRequerido`,
  `ac`.`HoraApertura` AS `HoraApertura`,
  `ac`.`HoraCierre` AS `HoraCierre`,
  `ac`.`DiasDisponibles` AS `DiasDisponibles`,
  `ac`.`DuracionMinimaHoras` AS `DuracionMinimaHoras`,
  `ac`.`DuracionMaximaHoras` AS `DuracionMaximaHoras`,
  `ac`.`AnticipacionMinimaDias` AS `AnticipacionMinimaDias`,
  `ac`.`AnticipacionMaximaDias` AS `AnticipacionMaximaDias`,
  `ac`.`Reglamento` AS `Reglamento`,
  `ac`.`ImagenPath` AS `ImagenPath`,
  (CASE WHEN (`ac`.`SubEntidadId` IS NULL) THEN 'Compartida (Todo el condominio)' ELSE CONCAT('Exclusiva (', `se`.`RazonSocial`, ')') END) AS `TipoAcceso`,
  (CASE WHEN (`ac`.`SubEntidadId` IS NULL) THEN 1 ELSE 0 END) AS `EsCompartida`
FROM ((`cat_areas_comunes` `ac`
  JOIN `cat_entidades` `e`
    ON ((`ac`.`EntidadId` = `e`.`Id`)))
  LEFT JOIN `cat_sub_entidades` `se`
    ON ((`ac`.`SubEntidadId` = `se`.`Id`)))
WHERE ((`ac`.`Activo` = 1)
AND (`ac`.`RequiereReservacion` = 1))
ORDER BY `ac`.`EntidadId`, (CASE WHEN (`ac`.`SubEntidadId` IS NULL) THEN 1 ELSE 0 END) DESC, `ac`.`Nombre`;

--
-- Create table `conf_roles`
--
CREATE TABLE conf_roles (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Nombre varchar(50) NOT NULL,
  Descripcion varchar(100) DEFAULT NULL,
  CreadoPor int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  Activo tinyint(1) DEFAULT 1,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 6,
AVG_ROW_LENGTH = 3276,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_conf_roles_entidad` on table `conf_roles`
--
ALTER TABLE conf_roles
ADD INDEX idx_conf_roles_entidad (IdEntidad);

--
-- Create index `uk_conf_rol_entidad` on table `conf_roles`
--
ALTER TABLE conf_roles
ADD UNIQUE INDEX uk_conf_rol_entidad (IdEntidad, Nombre);

--
-- Create foreign key
--
ALTER TABLE conf_roles
ADD CONSTRAINT fk_conf_roles_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `conf_usuarioroles`
--
CREATE TABLE conf_usuarioroles (
  UsuarioId int NOT NULL,
  RolId int NOT NULL,
  Activo tinyint(1) DEFAULT 1,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (UsuarioId, RolId)
)
ENGINE = INNODB,
AVG_ROW_LENGTH = 5461,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `conf_usuarioroles`
--
ALTER TABLE conf_usuarioroles
ADD INDEX idx_activo (Activo);

--
-- Create foreign key
--
ALTER TABLE conf_usuarioroles
ADD CONSTRAINT conf_usuarioroles_ibfk_1 FOREIGN KEY (UsuarioId)
REFERENCES conf_usuarios (Id);

--
-- Create foreign key
--
ALTER TABLE conf_usuarioroles
ADD CONSTRAINT conf_usuarioroles_ibfk_2 FOREIGN KEY (RolId)
REFERENCES conf_roles (Id);

--
-- Create table `conf_perfiles`
--
CREATE TABLE conf_perfiles (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Clave varchar(255) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  Tipo varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_perfiles_entidad` on table `conf_perfiles`
--
ALTER TABLE conf_perfiles
ADD INDEX idx_perfiles_entidad (IdEntidad);

--
-- Create foreign key
--
ALTER TABLE conf_perfiles
ADD CONSTRAINT fk_perfiles_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `conf_opciones`
--
CREATE TABLE conf_opciones (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Nombre varchar(100) NOT NULL,
  Url varchar(200) NOT NULL,
  Icono varchar(50) DEFAULT NULL,
  Plataforma enum ('web', 'movil', 'both') DEFAULT 'web',
  RibbonTab varchar(50) NOT NULL,
  RibbonGroup varchar(50) NOT NULL,
  Activo tinyint(1) DEFAULT NULL,
  OrdenTab int NOT NULL DEFAULT 0 COMMENT 'Orden de la pestaña del ribbon (menor = primero)',
  OrdenGrupo int NOT NULL DEFAULT 0 COMMENT 'Orden del grupo dentro de la pestaña (menor = primero)',
  OrdenOpcion int NOT NULL DEFAULT 0 COMMENT 'Orden de la opción dentro del grupo (menor = primero)',
  Descripcion text DEFAULT NULL,
  CreadoPor int DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  ModificadoPor int DEFAULT NULL,
  FechaModificacion datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 45,
AVG_ROW_LENGTH = 372,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `conf_opciones`
--
ALTER TABLE conf_opciones
ADD INDEX idx_activo (Activo);

--
-- Create index `idx_opciones_entidad` on table `conf_opciones`
--
ALTER TABLE conf_opciones
ADD INDEX idx_opciones_entidad (IdEntidad);

--
-- Create index `idx_orden_ribbon` on table `conf_opciones`
--
ALTER TABLE conf_opciones
ADD INDEX idx_orden_ribbon (OrdenTab, OrdenGrupo, OrdenOpcion);

--
-- Create index `idx_ribbon` on table `conf_opciones`
--
ALTER TABLE conf_opciones
ADD INDEX idx_ribbon (RibbonTab, RibbonGroup, OrdenTab, OrdenGrupo, OrdenOpcion);

--
-- Create foreign key
--
ALTER TABLE conf_opciones
ADD CONSTRAINT fk_opciones_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `conf_rolopciones`
--
CREATE TABLE conf_rolopciones (
  RolId int NOT NULL,
  OpcionId int NOT NULL,
  Activo tinyint(1) DEFAULT 1,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (RolId, OpcionId)
)
ENGINE = INNODB,
AVG_ROW_LENGTH = 273,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `conf_rolopciones`
--
ALTER TABLE conf_rolopciones
ADD INDEX idx_activo (Activo);

--
-- Create foreign key
--
ALTER TABLE conf_rolopciones
ADD CONSTRAINT conf_rolopciones_ibfk_1 FOREIGN KEY (RolId)
REFERENCES conf_roles (Id);

--
-- Create foreign key
--
ALTER TABLE conf_rolopciones
ADD CONSTRAINT conf_rolopciones_ibfk_2 FOREIGN KEY (OpcionId)
REFERENCES conf_opciones (Id);

--
-- Create table `conf_formulario_config`
--
CREATE TABLE conf_formulario_config (
  config_id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  clave varchar(100) NOT NULL,
  valor text NOT NULL,
  tipo_dato enum ('string', 'int', 'decimal', 'boolean', 'json') DEFAULT 'string',
  descripcion text DEFAULT NULL,
  categoria varchar(50) DEFAULT 'general',
  es_editable tinyint(1) DEFAULT 1,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  modificado_por int DEFAULT NULL,
  PRIMARY KEY (config_id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 16,
AVG_ROW_LENGTH = 1092,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Configuración global del módulo de formularios',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_categoria` on table `conf_formulario_config`
--
ALTER TABLE conf_formulario_config
ADD INDEX idx_categoria (categoria);

--
-- Create index `idx_form_config_entidad` on table `conf_formulario_config`
--
ALTER TABLE conf_formulario_config
ADD INDEX idx_form_config_entidad (IdEntidad);

--
-- Create index `uk_config_entidad` on table `conf_formulario_config`
--
ALTER TABLE conf_formulario_config
ADD UNIQUE INDEX uk_config_entidad (IdEntidad, clave);

--
-- Create foreign key
--
ALTER TABLE conf_formulario_config
ADD CONSTRAINT fk_form_config_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_unidades`
--
CREATE TABLE cat_unidades (
  id int NOT NULL AUTO_INCREMENT,
  codigo varchar(50) NOT NULL COMMENT 'Código único de la unidad',
  nombre varchar(200) NOT NULL,
  entidad_id int NOT NULL,
  SubEntidadId int DEFAULT NULL COMMENT 'FK a cat_sub_entidades',
  torre varchar(50) DEFAULT NULL,
  edificio varchar(50) DEFAULT NULL,
  piso varchar(20) DEFAULT NULL,
  numero varchar(20) DEFAULT NULL COMMENT 'Número de unidad/departamento',
  Calle varchar(200) DEFAULT NULL,
  NumeroExterior varchar(20) DEFAULT NULL,
  NumeroInterior varchar(20) DEFAULT NULL,
  Referencia varchar(500) DEFAULT NULL,
  Latitud decimal(10, 6) DEFAULT NULL,
  Longitud decimal(10, 6) DEFAULT NULL,
  superficie decimal(10, 2) DEFAULT NULL COMMENT 'Superficie en m²',
  numero_residentes int DEFAULT 0,
  activo tinyint(1) DEFAULT 1,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de unidades habitacionales',
ROW_FORMAT = DYNAMIC;

--
-- Create index `codigo` on table `cat_unidades`
--
ALTER TABLE cat_unidades
ADD UNIQUE INDEX codigo (codigo);

--
-- Create index `idx_activo` on table `cat_unidades`
--
ALTER TABLE cat_unidades
ADD INDEX idx_activo (activo);

--
-- Create index `idx_codigo` on table `cat_unidades`
--
ALTER TABLE cat_unidades
ADD INDEX idx_codigo (codigo);

--
-- Create index `idx_edificio` on table `cat_unidades`
--
ALTER TABLE cat_unidades
ADD INDEX idx_edificio (edificio);

--
-- Create index `idx_entidad` on table `cat_unidades`
--
ALTER TABLE cat_unidades
ADD INDEX idx_entidad (entidad_id);

--
-- Create index `idx_torre` on table `cat_unidades`
--
ALTER TABLE cat_unidades
ADD INDEX idx_torre (torre);

--
-- Create foreign key
--
ALTER TABLE cat_unidades
ADD CONSTRAINT fk_unidad_entidad FOREIGN KEY (entidad_id)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE cat_unidades
ADD CONSTRAINT fk_unidades_subentidad FOREIGN KEY (SubEntidadId)
REFERENCES cat_sub_entidades (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create table `cat_residentes`
--
CREATE TABLE cat_residentes (
  Id int NOT NULL AUTO_INCREMENT,
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades (Condominio)',
  SubEntidadId int DEFAULT NULL COMMENT 'FK a cat_sub_entidades (Torre/SecciÃ³n)',
  UnidadId int NOT NULL COMMENT 'FK a cat_unidades',
  Nombre varchar(100) NOT NULL COMMENT 'Nombre(s)',
  ApellidoPaterno varchar(100) NOT NULL,
  ApellidoMaterno varchar(100) DEFAULT NULL,
  NombreCompleto varchar(300) GENERATED ALWAYS AS (CONCAT(`Nombre`, _utf8mb4 ' ', `ApellidoPaterno`, COALESCE(CONCAT(_utf8mb4 ' ', `ApellidoMaterno`), _utf8mb4 ''))) STORED,
  TipoResidente enum ('Propietario', 'Inquilino', 'Familiar', 'Empleado') DEFAULT 'Propietario',
  EsPrincipal tinyint(1) DEFAULT 0 COMMENT '1=Es el responsable principal de la unidad',
  Email varchar(200) DEFAULT NULL,
  Telefono varchar(20) DEFAULT NULL,
  TelefonoCelular varchar(20) DEFAULT NULL,
  TelefonoEmergencia varchar(20) DEFAULT NULL,
  TelegramChatId varchar(50) DEFAULT NULL COMMENT 'Chat ID de Telegram',
  TelegramUsername varchar(100) DEFAULT NULL COMMENT 'Username de Telegram',
  TelegramActivo tinyint(1) DEFAULT 0,
  TipoIdentificacion enum ('INE', 'Pasaporte', 'Licencia', 'Cedula', 'Otro') DEFAULT 'INE',
  NumeroIdentificacion varchar(50) DEFAULT NULL,
  RFC varchar(13) DEFAULT NULL,
  CURP varchar(18) DEFAULT NULL,
  FechaIngreso date DEFAULT NULL COMMENT 'Fecha de ingreso al condominio',
  FechaSalida date DEFAULT NULL COMMENT 'Fecha de salida (si aplica)',
  TieneVehiculo tinyint(1) DEFAULT 0,
  PlacasVehiculo varchar(20) DEFAULT NULL,
  FotoPath varchar(500) DEFAULT NULL,
  IdentificacionPath varchar(500) DEFAULT NULL,
  RecibirNotificacionesEmail tinyint(1) DEFAULT 1,
  RecibirNotificacionesTelegram tinyint(1) DEFAULT 1,
  RecibirNotificacionesPush tinyint(1) DEFAULT 1,
  CreadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  ModificadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  Activo tinyint(1) DEFAULT 1,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  ClaveElector varchar(18) DEFAULT NULL,
  VigenciaINE varchar(10) DEFAULT NULL,
  SeccionElectoral varchar(10) DEFAULT NULL,
  FechaNacimiento date DEFAULT NULL,
  Sexo char(1) DEFAULT NULL,
  DomicilioINE varchar(500) DEFAULT NULL,
  ImagenINE longtext DEFAULT NULL,
  FechaEscaneoINE datetime DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 5,
AVG_ROW_LENGTH = 5461,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'CatÃ¡logo de residentes del condominio',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_Activo` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_Activo (Activo);

--
-- Create index `idx_CreadoPor` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_CreadoPor (CreadoPor);

--
-- Create index `idx_Email` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_Email (Email);

--
-- Create index `idx_EntidadId` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_EsPrincipal` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_EsPrincipal (EsPrincipal);

--
-- Create index `idx_NombreCompleto` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_NombreCompleto (NombreCompleto);

--
-- Create index `idx_SubEntidadId` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_SubEntidadId (SubEntidadId);

--
-- Create index `idx_Telefono` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_Telefono (Telefono);

--
-- Create index `idx_TelegramChatId` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_TelegramChatId (TelegramChatId);

--
-- Create index `idx_TipoResidente` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_TipoResidente (TipoResidente);

--
-- Create index `idx_UnidadId` on table `cat_residentes`
--
ALTER TABLE cat_residentes
ADD INDEX idx_UnidadId (UnidadId);

--
-- Create foreign key
--
ALTER TABLE cat_residentes
ADD CONSTRAINT fk_residentes_creado FOREIGN KEY (CreadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_residentes
ADD CONSTRAINT fk_residentes_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_residentes
ADD CONSTRAINT fk_residentes_modificado FOREIGN KEY (ModificadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_residentes
ADD CONSTRAINT fk_residentes_subentidad FOREIGN KEY (SubEntidadId)
REFERENCES cat_sub_entidades (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_residentes
ADD CONSTRAINT fk_residentes_unidad FOREIGN KEY (UnidadId)
REFERENCES cat_unidades (id) ON UPDATE CASCADE;

--
-- Create table `op_visitantes`
--
CREATE TABLE op_visitantes (
  Id int NOT NULL AUTO_INCREMENT,
  Folio varchar(20) NOT NULL COMMENT 'Folio Ãºnico: VIS-YYYYMMDD-XXXX',
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades',
  UnidadId int NOT NULL COMMENT 'FK a cat_unidades (unidad visitada)',
  ResidenteId int DEFAULT NULL COMMENT 'FK a cat_residentes (quien autoriza)',
  NombreVisitante varchar(200) NOT NULL COMMENT 'Nombre completo del visitante',
  TipoIdentificacion enum ('INE', 'Pasaporte', 'Licencia', 'Cedula', 'Otro') DEFAULT 'INE',
  NumeroIdentificacion varchar(50) DEFAULT NULL COMMENT 'NÃºmero de identificaciÃ³n',
  TieneVehiculo tinyint(1) DEFAULT 0,
  PlacasVehiculo varchar(20) DEFAULT NULL COMMENT 'Placas del vehÃ­culo',
  ColorVehiculo varchar(30) DEFAULT NULL COMMENT 'Color del vehÃ­culo',
  MarcaVehiculo varchar(50) DEFAULT NULL COMMENT 'Marca del vehÃ­culo',
  ModeloVehiculo varchar(50) DEFAULT NULL COMMENT 'Modelo del vehÃ­culo',
  TipoVisita enum ('Personal', 'Proveedor', 'Delivery', 'Emergencia', 'Trabajador', 'Invitado', 'Otro') DEFAULT 'Personal',
  MotivoVisita varchar(200) DEFAULT NULL COMMENT 'Motivo de la visita',
  EmpresaProveedor varchar(200) DEFAULT NULL COMMENT 'Empresa (si es proveedor)',
  FechaEntrada datetime NOT NULL COMMENT 'Fecha y hora de entrada',
  FechaSalida datetime DEFAULT NULL COMMENT 'Fecha y hora de salida',
  TiempoEstancia int GENERATED ALWAYS AS ((CASE WHEN (`FechaSalida` IS NOT NULL) THEN TIMESTAMPDIFF(MINUTE, `FechaEntrada`, `FechaSalida`) ELSE NULL END)) STORED COMMENT 'Tiempo de estancia en minutos',
  Estado enum ('EnCondominio', 'Salida', 'Rechazado') DEFAULT 'EnCondominio',
  MotivoRechazo varchar(500) DEFAULT NULL COMMENT 'Motivo si fue rechazado',
  AutorizadoPor varchar(100) DEFAULT NULL COMMENT 'Nombre del residente que autoriza',
  TelefonoAutorizacion varchar(20) DEFAULT NULL COMMENT 'TelÃ©fono de autorizaciÃ³n',
  FotoVisitantePath varchar(500) DEFAULT NULL COMMENT 'Foto del visitante',
  FotoIdentificacionPath varchar(500) DEFAULT NULL COMMENT 'Foto de la identificaciÃ³n',
  Observaciones text DEFAULT NULL,
  RegistradoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios (vigilante entrada)',
  RegistroSalidaPor int DEFAULT NULL COMMENT 'FK a conf_usuarios (vigilante salida)',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Registro de visitantes',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_EntidadId` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_Estado` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_Estado (Estado);

--
-- Create index `idx_FechaEntrada` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_FechaEntrada (FechaEntrada);

--
-- Create index `idx_FechaSalida` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_FechaSalida (FechaSalida);

--
-- Create index `idx_Folio` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_Folio (Folio);

--
-- Create index `idx_NombreVisitante` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_NombreVisitante (NombreVisitante);

--
-- Create index `idx_PlacasVehiculo` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_PlacasVehiculo (PlacasVehiculo);

--
-- Create index `idx_ResidenteId` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_ResidenteId (ResidenteId);

--
-- Create index `idx_TipoVisita` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_TipoVisita (TipoVisita);

--
-- Create index `idx_UnidadId` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD INDEX idx_UnidadId (UnidadId);

--
-- Create index `uk_Folio` on table `op_visitantes`
--
ALTER TABLE op_visitantes
ADD UNIQUE INDEX uk_Folio (Folio);

--
-- Create foreign key
--
ALTER TABLE op_visitantes
ADD CONSTRAINT fk_visitantes_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_visitantes
ADD CONSTRAINT fk_visitantes_registrado FOREIGN KEY (RegistradoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_visitantes
ADD CONSTRAINT fk_visitantes_residente FOREIGN KEY (ResidenteId)
REFERENCES cat_residentes (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_visitantes
ADD CONSTRAINT fk_visitantes_salida FOREIGN KEY (RegistroSalidaPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_visitantes
ADD CONSTRAINT fk_visitantes_unidad FOREIGN KEY (UnidadId)
REFERENCES cat_unidades (id) ON UPDATE CASCADE;

--
-- Create view `vw_visitantes_activos`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_visitantes_activos
AS
SELECT
  `v`.`Id` AS `VisitanteId`,
  `v`.`Folio` AS `Folio`,
  `v`.`EntidadId` AS `EntidadId`,
  `e`.`RazonSocial` AS `EntidadNombre`,
  `v`.`UnidadId` AS `UnidadId`,
  `u`.`codigo` AS `UnidadCodigo`,
  `u`.`nombre` AS `UnidadNombre`,
  `v`.`NombreVisitante` AS `NombreVisitante`,
  `v`.`TipoVisita` AS `TipoVisita`,
  `v`.`MotivoVisita` AS `MotivoVisita`,
  `v`.`FechaEntrada` AS `FechaEntrada`,
  TIMESTAMPDIFF(MINUTE, `v`.`FechaEntrada`, NOW()) AS `MinutosEnCondominio`,
  `v`.`TieneVehiculo` AS `TieneVehiculo`,
  `v`.`PlacasVehiculo` AS `PlacasVehiculo`,
  `v`.`AutorizadoPor` AS `AutorizadoPor`
FROM ((`op_visitantes` `v`
  JOIN `cat_entidades` `e`
    ON ((`v`.`EntidadId` = `e`.`Id`)))
  JOIN `cat_unidades` `u`
    ON ((`v`.`UnidadId` = `u`.`id`)))
WHERE (`v`.`Estado` = 'EnCondominio')
ORDER BY `v`.`FechaEntrada` DESC;

--
-- Create table `op_reservaciones`
--
CREATE TABLE op_reservaciones (
  Id int NOT NULL AUTO_INCREMENT,
  Folio varchar(20) NOT NULL COMMENT 'Folio Ãºnico: RES-YYYYMMDD-XXXX',
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades',
  AreaComunId int NOT NULL COMMENT 'FK a cat_areas_comunes',
  UnidadId int NOT NULL COMMENT 'FK a cat_unidades (quien reserva)',
  ResidenteId int DEFAULT NULL COMMENT 'FK a cat_residentes',
  FechaReservacion date NOT NULL COMMENT 'Fecha de la reservaciÃ³n',
  HoraInicio time NOT NULL COMMENT 'Hora de inicio',
  HoraFin time NOT NULL COMMENT 'Hora de fin',
  DuracionHoras decimal(4, 2) GENERATED ALWAYS AS ((TIMESTAMPDIFF(MINUTE, CONCAT(`FechaReservacion`, _utf8mb3 ' ', `HoraInicio`), CONCAT(`FechaReservacion`, _utf8mb3 ' ', `HoraFin`)) / 60.0)) STORED,
  NumeroInvitados int DEFAULT 0 COMMENT 'NÃºmero de invitados',
  Motivo varchar(200) DEFAULT NULL COMMENT 'Motivo de la reservaciÃ³n',
  TipoEvento enum ('Reunion', 'Fiesta', 'Cumpleanos', 'Boda', 'Bautizo', 'Otro') DEFAULT 'Reunion',
  CostoReservacion decimal(12, 2) DEFAULT 0.00 COMMENT 'Costo de la reservaciÃ³n',
  DepositoRequerido decimal(12, 2) DEFAULT 0.00 COMMENT 'DepÃ³sito requerido',
  DepositoPagado decimal(12, 2) DEFAULT 0.00 COMMENT 'DepÃ³sito pagado',
  DepositoDevuelto decimal(12, 2) DEFAULT 0.00 COMMENT 'DepÃ³sito devuelto',
  MontoDescuento decimal(12, 2) DEFAULT 0.00 COMMENT 'Descuento aplicado',
  Estado enum ('Pendiente', 'Confirmada', 'EnUso', 'Completada', 'Cancelada', 'NoShow') DEFAULT 'Pendiente',
  MotivoRechazo varchar(500) DEFAULT NULL COMMENT 'Motivo si fue rechazada',
  MotivoCancelacion varchar(500) DEFAULT NULL COMMENT 'Motivo si fue cancelada',
  Observaciones text DEFAULT NULL,
  ReglamentoAceptado tinyint(1) DEFAULT 0 COMMENT 'Si aceptÃ³ el reglamento',
  SolicitadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  AprobadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaAprobacion datetime DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Reservaciones de Ã¡reas comunes',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_AreaComunId` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_AreaComunId (AreaComunId);

--
-- Create index `idx_EntidadId` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_Estado` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_Estado (Estado);

--
-- Create index `idx_FechaHora` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_FechaHora (FechaReservacion, HoraInicio, HoraFin);

--
-- Create index `idx_FechaReservacion` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_FechaReservacion (FechaReservacion);

--
-- Create index `idx_Folio` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_Folio (Folio);

--
-- Create index `idx_ResidenteId` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_ResidenteId (ResidenteId);

--
-- Create index `idx_UnidadId` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD INDEX idx_UnidadId (UnidadId);

--
-- Create index `uk_Folio` on table `op_reservaciones`
--
ALTER TABLE op_reservaciones
ADD UNIQUE INDEX uk_Folio (Folio);

--
-- Create foreign key
--
ALTER TABLE op_reservaciones
ADD CONSTRAINT fk_reservaciones_aprobado FOREIGN KEY (AprobadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_reservaciones
ADD CONSTRAINT fk_reservaciones_area FOREIGN KEY (AreaComunId)
REFERENCES cat_areas_comunes (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_reservaciones
ADD CONSTRAINT fk_reservaciones_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_reservaciones
ADD CONSTRAINT fk_reservaciones_residente FOREIGN KEY (ResidenteId)
REFERENCES cat_residentes (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_reservaciones
ADD CONSTRAINT fk_reservaciones_solicitado FOREIGN KEY (SolicitadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_reservaciones
ADD CONSTRAINT fk_reservaciones_unidad FOREIGN KEY (UnidadId)
REFERENCES cat_unidades (id) ON UPDATE CASCADE;

--
-- Create view `vw_calendario_reservaciones`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_calendario_reservaciones
AS
SELECT
  `r`.`Id` AS `ReservacionId`,
  `r`.`Folio` AS `Folio`,
  `r`.`EntidadId` AS `EntidadId`,
  `e`.`RazonSocial` AS `EntidadNombre`,
  `r`.`AreaComunId` AS `AreaComunId`,
  `ac`.`Nombre` AS `AreaNombre`,
  `ac`.`TipoArea` AS `TipoArea`,
  `ac`.`SubEntidadId` AS `AreaSubEntidadId`,
  `se`.`RazonSocial` AS `AreaSubEntidadNombre`,
  `r`.`UnidadId` AS `UnidadId`,
  `u`.`codigo` AS `UnidadCodigo`,
  `u`.`nombre` AS `UnidadNombre`,
  `r`.`FechaReservacion` AS `FechaReservacion`,
  `r`.`HoraInicio` AS `HoraInicio`,
  `r`.`HoraFin` AS `HoraFin`,
  `r`.`DuracionHoras` AS `DuracionHoras`,
  `r`.`NumeroInvitados` AS `NumeroInvitados`,
  `r`.`TipoEvento` AS `TipoEvento`,
  `r`.`Motivo` AS `Motivo`,
  `r`.`Estado` AS `Estado`,
  `r`.`CostoReservacion` AS `CostoReservacion`,
  `r`.`DepositoPagado` AS `DepositoPagado`,
  CONCAT(`r`.`FechaReservacion`, ' ', `r`.`HoraInicio`) AS `FechaHoraInicio`,
  CONCAT(`r`.`FechaReservacion`, ' ', `r`.`HoraFin`) AS `FechaHoraFin`
FROM ((((`op_reservaciones` `r`
  JOIN `cat_entidades` `e`
    ON ((`r`.`EntidadId` = `e`.`Id`)))
  JOIN `cat_areas_comunes` `ac`
    ON ((`r`.`AreaComunId` = `ac`.`Id`)))
  LEFT JOIN `cat_sub_entidades` `se`
    ON ((`ac`.`SubEntidadId` = `se`.`Id`)))
  JOIN `cat_unidades` `u`
    ON ((`r`.`UnidadId` = `u`.`id`)))
WHERE (`r`.`Estado` <> 'Cancelada')
ORDER BY `r`.`FechaReservacion`, `r`.`HoraInicio`;

--
-- Create table `op_pagos`
--
CREATE TABLE op_pagos (
  Id int NOT NULL AUTO_INCREMENT,
  Folio varchar(20) NOT NULL COMMENT 'Folio Ãºnico: PAG-YYYYMMDD-XXXX',
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades',
  UnidadId int NOT NULL COMMENT 'FK a cat_unidades',
  ResidenteId int DEFAULT NULL COMMENT 'FK a cat_residentes (quien paga)',
  Monto decimal(12, 2) NOT NULL COMMENT 'Monto total del pago',
  FormaPago enum ('Efectivo', 'Transferencia', 'Tarjeta', 'Cheque', 'Deposito', 'SPEI', 'Otro') NOT NULL,
  Referencia varchar(100) DEFAULT NULL COMMENT 'NÃºmero de referencia bancaria',
  Banco varchar(100) DEFAULT NULL COMMENT 'Banco de origen',
  NumeroAutorizacion varchar(50) DEFAULT NULL COMMENT 'NÃºmero de autorizaciÃ³n (tarjeta)',
  FechaPago date NOT NULL COMMENT 'Fecha del pago',
  ComprobantePath varchar(500) DEFAULT NULL COMMENT 'Ruta del comprobante digitalizado',
  Estado enum ('Aplicado', 'Pendiente', 'Rechazado', 'Cancelado') DEFAULT 'Aplicado',
  MotivoRechazo varchar(500) DEFAULT NULL COMMENT 'Motivo si fue rechazado',
  Observaciones text DEFAULT NULL,
  RegistradoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  AprobadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaAprobacion datetime DEFAULT NULL,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Pagos registrados',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_EntidadId` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_Estado` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_Estado (Estado);

--
-- Create index `idx_FechaPago` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_FechaPago (FechaPago);

--
-- Create index `idx_Folio` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_Folio (Folio);

--
-- Create index `idx_FormaPago` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_FormaPago (FormaPago);

--
-- Create index `idx_Referencia` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_Referencia (Referencia);

--
-- Create index `idx_ResidenteId` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_ResidenteId (ResidenteId);

--
-- Create index `idx_UnidadId` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD INDEX idx_UnidadId (UnidadId);

--
-- Create index `uk_Folio` on table `op_pagos`
--
ALTER TABLE op_pagos
ADD UNIQUE INDEX uk_Folio (Folio);

--
-- Create foreign key
--
ALTER TABLE op_pagos
ADD CONSTRAINT fk_pagos_aprobado FOREIGN KEY (AprobadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_pagos
ADD CONSTRAINT fk_pagos_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_pagos
ADD CONSTRAINT fk_pagos_registrado FOREIGN KEY (RegistradoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_pagos
ADD CONSTRAINT fk_pagos_residente FOREIGN KEY (ResidenteId)
REFERENCES cat_residentes (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_pagos
ADD CONSTRAINT fk_pagos_unidad FOREIGN KEY (UnidadId)
REFERENCES cat_unidades (id) ON UPDATE CASCADE;

--
-- Create table `op_cuotas`
--
CREATE TABLE op_cuotas (
  Id int NOT NULL AUTO_INCREMENT,
  Folio varchar(20) NOT NULL COMMENT 'Folio Ãºnico: CUO-YYYYMM-XXXX',
  EntidadId int NOT NULL COMMENT 'FK a cat_entidades (Condominio)',
  UnidadId int NOT NULL COMMENT 'FK a cat_unidades',
  ConceptoCuotaId int NOT NULL COMMENT 'FK a cat_conceptos_cuota',
  ResidenteId int DEFAULT NULL COMMENT 'FK a cat_residentes (responsable del pago)',
  Periodo varchar(7) NOT NULL COMMENT 'Formato: YYYY-MM',
  Anio int GENERATED ALWAYS AS (CAST(SUBSTR(`Periodo`, 1, 4) AS UNSIGNED)) STORED,
  Mes int GENERATED ALWAYS AS (CAST(SUBSTR(`Periodo`, 6, 2) AS UNSIGNED)) STORED,
  Monto decimal(12, 2) NOT NULL COMMENT 'Monto base',
  Descuento decimal(12, 2) DEFAULT 0.00 COMMENT 'Descuento aplicado',
  Recargo decimal(12, 2) DEFAULT 0.00 COMMENT 'Recargo por mora',
  MontoTotal decimal(12, 2) GENERATED ALWAYS AS (((`Monto` - `Descuento`) + `Recargo`)) STORED,
  MontoPagado decimal(12, 2) DEFAULT 0.00 COMMENT 'Total pagado',
  Saldo decimal(12, 2) GENERATED ALWAYS AS ((((`Monto` - `Descuento`) + `Recargo`) - `MontoPagado`)) STORED,
  FechaEmision date NOT NULL COMMENT 'Fecha de emisiÃ³n de la cuota',
  FechaVencimiento date NOT NULL COMMENT 'Fecha lÃ­mite de pago',
  FechaPago date DEFAULT NULL COMMENT 'Fecha en que se liquidÃ³',
  Estado enum ('Pendiente', 'Parcial', 'Pagada', 'Vencida', 'Cancelada') DEFAULT 'Pendiente',
  Observaciones text DEFAULT NULL,
  CreadoPor int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Cuotas generadas por unidad',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_AnioMes` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_AnioMes (Anio, Mes);

--
-- Create index `idx_ConceptoCuotaId` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_ConceptoCuotaId (ConceptoCuotaId);

--
-- Create index `idx_EntidadId` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_EntidadId (EntidadId);

--
-- Create index `idx_Estado` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_Estado (Estado);

--
-- Create index `idx_FechaVencimiento` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_FechaVencimiento (FechaVencimiento);

--
-- Create index `idx_Folio` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_Folio (Folio);

--
-- Create index `idx_Periodo` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_Periodo (Periodo);

--
-- Create index `idx_ResidenteId` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_ResidenteId (ResidenteId);

--
-- Create index `idx_Saldo` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_Saldo (Saldo);

--
-- Create index `idx_UnidadId` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD INDEX idx_UnidadId (UnidadId);

--
-- Create index `uk_Folio` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD UNIQUE INDEX uk_Folio (Folio);

--
-- Create index `uk_Unidad_Concepto_Periodo` on table `op_cuotas`
--
ALTER TABLE op_cuotas
ADD UNIQUE INDEX uk_Unidad_Concepto_Periodo (UnidadId, ConceptoCuotaId, Periodo);

--
-- Create foreign key
--
ALTER TABLE op_cuotas
ADD CONSTRAINT fk_cuotas_concepto FOREIGN KEY (ConceptoCuotaId)
REFERENCES cat_conceptos_cuota (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_cuotas
ADD CONSTRAINT fk_cuotas_creado FOREIGN KEY (CreadoPor)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_cuotas
ADD CONSTRAINT fk_cuotas_entidad FOREIGN KEY (EntidadId)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_cuotas
ADD CONSTRAINT fk_cuotas_residente FOREIGN KEY (ResidenteId)
REFERENCES cat_residentes (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_cuotas
ADD CONSTRAINT fk_cuotas_unidad FOREIGN KEY (UnidadId)
REFERENCES cat_unidades (id) ON UPDATE CASCADE;

DELIMITER $$

--
-- Create function `fn_GenerarFolio`
--
CREATE
DEFINER = 'jlsg'@'%'
FUNCTION fn_GenerarFolio (p_Prefijo varchar(5),
p_Tabla varchar(50))
RETURNS varchar(20) CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci
DETERMINISTIC
BEGIN
  DECLARE v_Folio varchar(20);
  DECLARE v_Fecha varchar(8);
  DECLARE v_Consecutivo int;

  SET v_Fecha = DATE_FORMAT(CURDATE(), '%Y%m%d');

  -- Obtener el siguiente consecutivo del dÃ­a
  SET v_Consecutivo = (SELECT
      COALESCE(MAX(
      CAST(SUBSTRING(Folio, LENGTH(CONCAT(p_Prefijo, '-', v_Fecha, '-')) + 1) AS UNSIGNED)
      ), 0) + 1
    FROM (SELECT
        Folio
      FROM op_cuotas
      WHERE Folio LIKE CONCAT(p_Prefijo, '-', v_Fecha, '-%')
      UNION ALL
      SELECT
        Folio
      FROM op_pagos
      WHERE Folio LIKE CONCAT(p_Prefijo, '-', v_Fecha, '-%')
      UNION ALL
      SELECT
        Folio
      FROM op_reservaciones
      WHERE Folio LIKE CONCAT(p_Prefijo, '-', v_Fecha, '-%')
      UNION ALL
      SELECT
        Folio
      FROM op_visitantes
      WHERE Folio LIKE CONCAT(p_Prefijo, '-', v_Fecha, '-%')) AS folios);

  SET v_Folio = CONCAT(p_Prefijo, '-', v_Fecha, '-', LPAD(v_Consecutivo, 4, '0'));

  RETURN v_Folio;
END
$$

--
-- Create procedure `sp_GenerarCuotasMensuales`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_GenerarCuotasMensuales (IN p_EntidadId int,
IN p_Periodo varchar(7),  -- Formato: YYYY-MM
IN p_UsuarioId int)
BEGIN
  DECLARE v_Anio int;
  DECLARE v_Mes int;
  DECLARE v_FechaEmision date;
  DECLARE v_Contador int DEFAULT 0;

  -- Extraer aÃ±o y mes
  SET v_Anio = CAST(SUBSTRING(p_Periodo, 1, 4) AS UNSIGNED);
  SET v_Mes = CAST(SUBSTRING(p_Periodo, 6, 2) AS UNSIGNED);
  SET v_FechaEmision = CONCAT(p_Periodo, '-01');

  -- Insertar cuotas para cada unidad y concepto recurrente
  INSERT INTO op_cuotas (Folio, EntidadId, UnidadId, ConceptoCuotaId, ResidenteId,
  Periodo, Monto, FechaEmision, FechaVencimiento, Estado, CreadoPor)
    SELECT
      CONCAT('CUO-', p_Periodo, '-', LPAD(ROW_NUMBER() OVER (
      ORDER BY u.id, cc.Id), 4, '0')) AS Folio,
      p_EntidadId,
      u.id AS UnidadId,
      cc.Id AS ConceptoCuotaId,
      u.PropietarioId AS ResidenteId,
      p_Periodo,
      CASE WHEN cc.Clave = 'MANT' AND
          u.CuotaOrdinaria > 0 THEN u.CuotaOrdinaria ELSE cc.MontoDefault END AS Monto,
      v_FechaEmision,
      DATE_ADD(v_FechaEmision, INTERVAL cc.DiaVencimiento - 1 DAY) AS FechaVencimiento,
      'Pendiente',
      p_UsuarioId
    FROM cat_unidades u
      CROSS JOIN cat_conceptos_cuota cc
    WHERE u.entidad_id = p_EntidadId
    AND u.activo = 1
    AND cc.EntidadId = p_EntidadId
    AND cc.EsRecurrente = 1
    AND cc.Activo = 1
    AND NOT EXISTS (SELECT
        1
      FROM op_cuotas c
      WHERE c.UnidadId = u.id
      AND c.ConceptoCuotaId = cc.Id
      AND c.Periodo = p_Periodo);

  SET v_Contador = ROW_COUNT();

  SELECT
    v_Contador AS CuotasGeneradas,
    p_Periodo AS Periodo,
    p_EntidadId AS EntidadId;
END
$$

--
-- Create procedure `sp_AplicarRecargosMora`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_AplicarRecargosMora (IN p_EntidadId int,
IN p_FechaCorte date)
BEGIN
  DECLARE v_Contador int DEFAULT 0;

  -- Actualizar estado a Vencida para cuotas pasadas de fecha
  UPDATE op_cuotas c
  SET c.Estado = 'Vencida'
  WHERE c.EntidadId = p_EntidadId
  AND c.Estado IN ('Pendiente', 'Parcial')
  AND c.FechaVencimiento < p_FechaCorte
  AND c.Saldo > 0;

  -- Aplicar recargos segÃºn configuraciÃ³n del concepto
  UPDATE op_cuotas c
  INNER JOIN cat_conceptos_cuota cc
    ON c.ConceptoCuotaId = cc.Id
  SET c.Recargo = ROUND(c.Monto * (cc.PorcentajeRecargo / 100), 2)
  WHERE c.EntidadId = p_EntidadId
  AND c.Estado = 'Vencida'
  AND c.Recargo = 0
  AND cc.PorcentajeRecargo > 0
  AND DATEDIFF(p_FechaCorte, c.FechaVencimiento) > cc.DiasGracia;

  SET v_Contador = ROW_COUNT();

  SELECT
    v_Contador AS RecargosAplicados,
    p_FechaCorte AS FechaCorte,
    p_EntidadId AS EntidadId;
END
$$

DELIMITER ;

--
-- Create view `vw_resumen_morosidad`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_resumen_morosidad
AS
SELECT
  `c`.`EntidadId` AS `EntidadId`,
  `e`.`RazonSocial` AS `EntidadNombre`,
  `c`.`UnidadId` AS `UnidadId`,
  `u`.`codigo` AS `UnidadCodigo`,
  `u`.`nombre` AS `UnidadNombre`,
  COUNT((CASE WHEN (`c`.`Estado` IN ('Pendiente', 'Parcial', 'Vencida')) THEN 1 END)) AS `CuotasPendientes`,
  SUM((CASE WHEN (`c`.`Estado` IN ('Pendiente', 'Parcial', 'Vencida')) THEN `c`.`Saldo` ELSE 0 END)) AS `SaldoTotal`,
  MIN((CASE WHEN (`c`.`Estado` IN ('Pendiente', 'Parcial', 'Vencida')) THEN `c`.`Periodo` END)) AS `PeriodoMasAntiguo`,
  MAX((CASE WHEN ((`c`.`Estado` IN ('Pendiente', 'Parcial', 'Vencida')) AND
      (`c`.`FechaVencimiento` < CURDATE())) THEN (TO_DAYS(CURDATE()) - TO_DAYS(`c`.`FechaVencimiento`)) ELSE 0 END)) AS `MaxDiasVencido`
FROM ((`op_cuotas` `c`
  JOIN `cat_entidades` `e`
    ON ((`c`.`EntidadId` = `e`.`Id`)))
  JOIN `cat_unidades` `u`
    ON ((`c`.`UnidadId` = `u`.`id`)))
GROUP BY `c`.`EntidadId`,
         `e`.`RazonSocial`,
         `c`.`UnidadId`,
         `u`.`codigo`,
         `u`.`nombre`
HAVING (`SaldoTotal` > 0)
ORDER BY `SaldoTotal` DESC;

--
-- Create view `vw_estado_cuenta`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_estado_cuenta
AS
SELECT
  `c`.`Id` AS `CuotaId`,
  `c`.`Folio` AS `Folio`,
  `c`.`EntidadId` AS `EntidadId`,
  `e`.`RazonSocial` AS `EntidadNombre`,
  `c`.`UnidadId` AS `UnidadId`,
  `u`.`codigo` AS `UnidadCodigo`,
  `u`.`nombre` AS `UnidadNombre`,
  `cc`.`Nombre` AS `ConceptoNombre`,
  `cc`.`TipoCuota` AS `TipoCuota`,
  `c`.`Periodo` AS `Periodo`,
  `c`.`Anio` AS `Anio`,
  `c`.`Mes` AS `Mes`,
  `c`.`Monto` AS `Monto`,
  `c`.`Descuento` AS `Descuento`,
  `c`.`Recargo` AS `Recargo`,
  `c`.`MontoTotal` AS `MontoTotal`,
  `c`.`MontoPagado` AS `MontoPagado`,
  `c`.`Saldo` AS `Saldo`,
  `c`.`FechaEmision` AS `FechaEmision`,
  `c`.`FechaVencimiento` AS `FechaVencimiento`,
  `c`.`FechaPago` AS `FechaPago`,
  `c`.`Estado` AS `Estado`,
  (CASE WHEN (`c`.`Estado` = 'Pagada') THEN 0 WHEN (`c`.`FechaVencimiento` < CURDATE()) THEN (TO_DAYS(CURDATE()) - TO_DAYS(`c`.`FechaVencimiento`)) ELSE 0 END) AS `DiasVencido`
FROM (((`op_cuotas` `c`
  JOIN `cat_entidades` `e`
    ON ((`c`.`EntidadId` = `e`.`Id`)))
  JOIN `cat_unidades` `u`
    ON ((`c`.`UnidadId` = `u`.`id`)))
  JOIN `cat_conceptos_cuota` `cc`
    ON ((`c`.`ConceptoCuotaId` = `cc`.`Id`)))
ORDER BY `c`.`UnidadId`, `c`.`Periodo` DESC, `cc`.`Nombre`;

--
-- Create table `op_pagos_detalle`
--
CREATE TABLE op_pagos_detalle (
  Id int NOT NULL AUTO_INCREMENT,
  PagoId int NOT NULL COMMENT 'FK a op_pagos',
  CuotaId int NOT NULL COMMENT 'FK a op_cuotas',
  MontoAplicado decimal(12, 2) NOT NULL COMMENT 'Monto aplicado a esta cuota',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Detalle de aplicaciÃ³n de pagos a cuotas',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_CuotaId` on table `op_pagos_detalle`
--
ALTER TABLE op_pagos_detalle
ADD INDEX idx_CuotaId (CuotaId);

--
-- Create index `idx_PagoId` on table `op_pagos_detalle`
--
ALTER TABLE op_pagos_detalle
ADD INDEX idx_PagoId (PagoId);

--
-- Create index `uk_Pago_Cuota` on table `op_pagos_detalle`
--
ALTER TABLE op_pagos_detalle
ADD UNIQUE INDEX uk_Pago_Cuota (PagoId, CuotaId);

--
-- Create foreign key
--
ALTER TABLE op_pagos_detalle
ADD CONSTRAINT fk_pagos_detalle_cuota FOREIGN KEY (CuotaId)
REFERENCES op_cuotas (Id) ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_pagos_detalle
ADD CONSTRAINT fk_pagos_detalle_pago FOREIGN KEY (PagoId)
REFERENCES op_pagos (Id) ON DELETE CASCADE ON UPDATE CASCADE;

DELIMITER $$

--
-- Create trigger `trg_pagos_detalle_after_insert`
--
CREATE
DEFINER = 'jlsg'@'%'
TRIGGER trg_pagos_detalle_after_insert
AFTER INSERT
ON op_pagos_detalle
FOR EACH ROW
BEGIN
  -- Actualizar MontoPagado en la cuota
  UPDATE op_cuotas
  SET MontoPagado = (SELECT
      COALESCE(SUM(MontoAplicado), 0)
    FROM op_pagos_detalle
    WHERE CuotaId = NEW.CuotaId)
  WHERE Id = NEW.CuotaId;

  -- Actualizar Estado de la cuota
  UPDATE op_cuotas
  SET Estado = CASE WHEN Saldo <= 0 THEN 'Pagada' WHEN MontoPagado > 0 THEN 'Parcial' ELSE Estado END,
      FechaPago = CASE WHEN Saldo <= 0 THEN CURDATE() ELSE FechaPago END
  WHERE Id = NEW.CuotaId;
END
$$

--
-- Create trigger `trg_pagos_detalle_after_delete`
--
CREATE
DEFINER = 'jlsg'@'%'
TRIGGER trg_pagos_detalle_after_delete
AFTER DELETE
ON op_pagos_detalle
FOR EACH ROW
BEGIN
  -- Actualizar MontoPagado en la cuota
  UPDATE op_cuotas
  SET MontoPagado = (SELECT
      COALESCE(SUM(MontoAplicado), 0)
    FROM op_pagos_detalle
    WHERE CuotaId = OLD.CuotaId)
  WHERE Id = OLD.CuotaId;

  -- Actualizar Estado de la cuota
  UPDATE op_cuotas
  SET Estado = CASE WHEN MontoPagado = 0 THEN 'Pendiente' WHEN Saldo > 0 THEN 'Parcial' ELSE 'Pagada' END,
      FechaPago = CASE WHEN MontoPagado = 0 THEN NULL ELSE FechaPago END
  WHERE Id = OLD.CuotaId;
END
$$

DELIMITER ;

--
-- Create table `op_comunicados_lecturas`
--
CREATE TABLE op_comunicados_lecturas (
  Id int NOT NULL AUTO_INCREMENT,
  ComunicadoId int NOT NULL COMMENT 'FK a op_comunicados',
  ResidenteId int DEFAULT NULL COMMENT 'FK a cat_residentes',
  UsuarioId int DEFAULT NULL COMMENT 'FK a conf_usuarios',
  FechaLectura datetime DEFAULT CURRENT_TIMESTAMP,
  Canal enum ('Web', 'App', 'Email', 'Telegram') DEFAULT 'Web',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Registro de lecturas de comunicados',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_ComunicadoId` on table `op_comunicados_lecturas`
--
ALTER TABLE op_comunicados_lecturas
ADD INDEX idx_ComunicadoId (ComunicadoId);

--
-- Create index `idx_FechaLectura` on table `op_comunicados_lecturas`
--
ALTER TABLE op_comunicados_lecturas
ADD INDEX idx_FechaLectura (FechaLectura);

--
-- Create index `idx_ResidenteId` on table `op_comunicados_lecturas`
--
ALTER TABLE op_comunicados_lecturas
ADD INDEX idx_ResidenteId (ResidenteId);

--
-- Create index `idx_UsuarioId` on table `op_comunicados_lecturas`
--
ALTER TABLE op_comunicados_lecturas
ADD INDEX idx_UsuarioId (UsuarioId);

--
-- Create index `uk_Comunicado_Residente` on table `op_comunicados_lecturas`
--
ALTER TABLE op_comunicados_lecturas
ADD UNIQUE INDEX uk_Comunicado_Residente (ComunicadoId, ResidenteId);

--
-- Create foreign key
--
ALTER TABLE op_comunicados_lecturas
ADD CONSTRAINT fk_lecturas_comunicado FOREIGN KEY (ComunicadoId)
REFERENCES op_comunicados (Id) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_comunicados_lecturas
ADD CONSTRAINT fk_lecturas_residente FOREIGN KEY (ResidenteId)
REFERENCES cat_residentes (Id) ON DELETE CASCADE ON UPDATE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_comunicados_lecturas
ADD CONSTRAINT fk_lecturas_usuario FOREIGN KEY (UsuarioId)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL ON UPDATE CASCADE;

--
-- Create table `cat_ticket_categorias`
--
CREATE TABLE cat_ticket_categorias (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Nombre varchar(100) NOT NULL COMMENT 'Nombre de la categoría',
  Descripcion text DEFAULT NULL COMMENT 'Descripción de la categoría',
  CategoriaPadre int DEFAULT NULL COMMENT 'ID de la categoría padre (para subcategorías)',
  Orden int DEFAULT 0 COMMENT 'Orden de visualización',
  Activo tinyint(1) DEFAULT 1 COMMENT 'Indica si la categoría está activa',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 16,
AVG_ROW_LENGTH = 1092,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de categorías de tickets - Módulo 07',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_categoria_activo` on table `cat_ticket_categorias`
--
ALTER TABLE cat_ticket_categorias
ADD INDEX idx_categoria_activo (Activo);

--
-- Create index `idx_categoria_orden` on table `cat_ticket_categorias`
--
ALTER TABLE cat_ticket_categorias
ADD INDEX idx_categoria_orden (Orden);

--
-- Create index `idx_categoria_padre` on table `cat_ticket_categorias`
--
ALTER TABLE cat_ticket_categorias
ADD INDEX idx_categoria_padre (CategoriaPadre);

--
-- Create index `idx_ticket_cat_entidad` on table `cat_ticket_categorias`
--
ALTER TABLE cat_ticket_categorias
ADD INDEX idx_ticket_cat_entidad (IdEntidad);

--
-- Create index `uk_ticket_cat_entidad` on table `cat_ticket_categorias`
--
ALTER TABLE cat_ticket_categorias
ADD UNIQUE INDEX uk_ticket_cat_entidad (IdEntidad, Nombre);

--
-- Create foreign key
--
ALTER TABLE cat_ticket_categorias
ADD CONSTRAINT cat_ticket_categorias_ibfk_1 FOREIGN KEY (CategoriaPadre)
REFERENCES cat_ticket_categorias (Id) ON DELETE SET NULL;

--
-- Create foreign key
--
ALTER TABLE cat_ticket_categorias
ADD CONSTRAINT fk_ticket_cat_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_roles`
--
CREATE TABLE cat_roles (
  id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  nombre varchar(100) NOT NULL,
  descripcion text DEFAULT NULL,
  activo tinyint(1) DEFAULT 1,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 11,
AVG_ROW_LENGTH = 3276,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de roles del sistema',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `cat_roles`
--
ALTER TABLE cat_roles
ADD INDEX idx_activo (activo);

--
-- Create index `idx_nombre` on table `cat_roles`
--
ALTER TABLE cat_roles
ADD INDEX idx_nombre (nombre);

--
-- Create index `idx_roles_entidad` on table `cat_roles`
--
ALTER TABLE cat_roles
ADD INDEX idx_roles_entidad (IdEntidad);

--
-- Create index `uk_rol_entidad` on table `cat_roles`
--
ALTER TABLE cat_roles
ADD UNIQUE INDEX uk_rol_entidad (IdEntidad, nombre);

--
-- Create foreign key
--
ALTER TABLE cat_roles
ADD CONSTRAINT fk_roles_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_proveedores`
--
CREATE TABLE cat_proveedores (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Clave varchar(50) DEFAULT NULL,
  Alias varchar(50) DEFAULT NULL,
  CIF varchar(20) DEFAULT NULL,
  RazonSocial varchar(255) DEFAULT NULL,
  CP varchar(10) DEFAULT '',
  TipoVialidad varchar(255) DEFAULT NULL,
  NombreVialidad varchar(255) DEFAULT NULL,
  NoExterior varchar(255) DEFAULT NULL,
  NoInterior varchar(255) DEFAULT NULL,
  Colonia varchar(255) DEFAULT NULL,
  Localidad varchar(255) DEFAULT NULL,
  Municipio varchar(255) DEFAULT NULL,
  EntidadFederativa varchar(255) DEFAULT NULL,
  EntreCalle varchar(255) DEFAULT NULL,
  RFC varchar(20) DEFAULT NULL,
  FechaAlta datetime DEFAULT NULL,
  FechaInicioSAT varchar(255) DEFAULT NULL,
  ClaveRegimen varchar(255) DEFAULT NULL,
  RegimenFiscal varchar(255) DEFAULT NULL,
  ClaveMetodo varchar(255) DEFAULT NULL,
  MetodoDePago varchar(255) DEFAULT NULL,
  ClaveForma varchar(255) DEFAULT NULL,
  FormaDePago varchar(255) DEFAULT NULL,
  ClaveUso varchar(255) DEFAULT NULL,
  UsoCFDI varchar(255) DEFAULT NULL,
  Latitud double NOT NULL DEFAULT 0,
  Longitud double NOT NULL DEFAULT 0,
  Activo tinyint(1) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_proveedores_entidad` on table `cat_proveedores`
--
ALTER TABLE cat_proveedores
ADD INDEX idx_proveedores_entidad (IdEntidad);

--
-- Create foreign key
--
ALTER TABLE cat_proveedores
ADD CONSTRAINT fk_proveedores_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_permisos`
--
CREATE TABLE cat_permisos (
  id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  modulo varchar(100) NOT NULL COMMENT 'Módulo del sistema (Tickets, Órdenes, etc)',
  nombre varchar(100) NOT NULL,
  descripcion text DEFAULT NULL,
  clave varchar(100) NOT NULL COMMENT 'Clave única del permiso (ej: tickets.crear)',
  activo tinyint(1) DEFAULT 1,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 33,
AVG_ROW_LENGTH = 1024,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de permisos del sistema',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `cat_permisos`
--
ALTER TABLE cat_permisos
ADD INDEX idx_activo (activo);

--
-- Create index `idx_clave` on table `cat_permisos`
--
ALTER TABLE cat_permisos
ADD INDEX idx_clave (clave);

--
-- Create index `idx_modulo` on table `cat_permisos`
--
ALTER TABLE cat_permisos
ADD INDEX idx_modulo (modulo);

--
-- Create index `idx_permisos_entidad` on table `cat_permisos`
--
ALTER TABLE cat_permisos
ADD INDEX idx_permisos_entidad (IdEntidad);

--
-- Create index `uk_permiso_entidad` on table `cat_permisos`
--
ALTER TABLE cat_permisos
ADD UNIQUE INDEX uk_permiso_entidad (IdEntidad, clave);

--
-- Create foreign key
--
ALTER TABLE cat_permisos
ADD CONSTRAINT fk_permisos_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `rel_rol_permisos`
--
CREATE TABLE rel_rol_permisos (
  id int NOT NULL AUTO_INCREMENT,
  rol_id int NOT NULL,
  permiso_id int NOT NULL,
  fecha_asignacion datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Relación entre roles y permisos',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_permiso` on table `rel_rol_permisos`
--
ALTER TABLE rel_rol_permisos
ADD INDEX idx_permiso (permiso_id);

--
-- Create index `idx_rol` on table `rel_rol_permisos`
--
ALTER TABLE rel_rol_permisos
ADD INDEX idx_rol (rol_id);

--
-- Create index `uk_rol_permiso` on table `rel_rol_permisos`
--
ALTER TABLE rel_rol_permisos
ADD UNIQUE INDEX uk_rol_permiso (rol_id, permiso_id);

--
-- Create foreign key
--
ALTER TABLE rel_rol_permisos
ADD CONSTRAINT fk_rol_permiso_permiso FOREIGN KEY (permiso_id)
REFERENCES cat_permisos (id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE rel_rol_permisos
ADD CONSTRAINT fk_rol_permiso_rol FOREIGN KEY (rol_id)
REFERENCES cat_roles (id) ON DELETE CASCADE;

--
-- Create table `cat_medidor`
--
CREATE TABLE cat_medidor (
  IdMedidor int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL,
  CodigoMedidor varchar(100) NOT NULL,
  DevEui varchar(32) NOT NULL,
  AppEui varchar(32) DEFAULT NULL,
  AppKey varchar(64) DEFAULT NULL,
  Ubicacion varchar(255) DEFAULT NULL,
  Latitud decimal(10, 7) DEFAULT NULL,
  Longitud decimal(10, 7) DEFAULT NULL,
  FechaInstalacion date DEFAULT NULL,
  UnidadMedida varchar(20) NOT NULL DEFAULT 'm3',
  Activo tinyint(1) NOT NULL DEFAULT 1,
  FechaCreacion datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (IdMedidor)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_0900_ai_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `UqMedidorCodigo` on table `cat_medidor`
--
ALTER TABLE cat_medidor
ADD UNIQUE INDEX UqMedidorCodigo (CodigoMedidor);

--
-- Create index `UqMedidorDevEui` on table `cat_medidor`
--
ALTER TABLE cat_medidor
ADD UNIQUE INDEX UqMedidorDevEui (DevEui);

--
-- Create foreign key
--
ALTER TABLE cat_medidor
ADD CONSTRAINT FkMedidorEntidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id) ON UPDATE CASCADE;

--
-- Create table `cat_formularios`
--
CREATE TABLE cat_formularios (
  formulario_id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  nombre_formulario varchar(255) NOT NULL,
  descripcion text DEFAULT NULL,
  plataformas varchar(100) NOT NULL DEFAULT 'web,movil' COMMENT 'Valores: web, movil, escritorio separados por coma',
  estado enum ('activo', 'inactivo', 'borrador') DEFAULT 'borrador',
  version int DEFAULT 1,
  icono varchar(50) DEFAULT 'fa-file-alt',
  color_tema varchar(7) DEFAULT '#007bff',
  requiere_firma tinyint(1) DEFAULT 0,
  requiere_foto tinyint(1) DEFAULT 0,
  tiempo_estimado_minutos int DEFAULT 15,
  instrucciones text DEFAULT NULL,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  creado_por int NOT NULL,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  modificado_por int DEFAULT NULL,
  PRIMARY KEY (formulario_id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo maestro de formularios dinámicos',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_creado_por` on table `cat_formularios`
--
ALTER TABLE cat_formularios
ADD INDEX idx_creado_por (creado_por);

--
-- Create index `idx_estado` on table `cat_formularios`
--
ALTER TABLE cat_formularios
ADD INDEX idx_estado (estado);

--
-- Create index `idx_formularios_entidad` on table `cat_formularios`
--
ALTER TABLE cat_formularios
ADD INDEX idx_formularios_entidad (IdEntidad);

--
-- Create index `idx_formularios_estado_plataforma` on table `cat_formularios`
--
ALTER TABLE cat_formularios
ADD INDEX idx_formularios_estado_plataforma (estado, plataformas);

--
-- Create index `idx_plataformas` on table `cat_formularios`
--
ALTER TABLE cat_formularios
ADD INDEX idx_plataformas (plataformas);

--
-- Create index `uk_formulario_entidad` on table `cat_formularios`
--
ALTER TABLE cat_formularios
ADD UNIQUE INDEX uk_formulario_entidad (IdEntidad, nombre_formulario);

--
-- Create foreign key
--
ALTER TABLE cat_formularios
ADD CONSTRAINT fk_formularios_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

DELIMITER $$

--
-- Create trigger `trg_formulario_version`
--
CREATE
DEFINER = 'jlsg'@'%'
TRIGGER trg_formulario_version
BEFORE UPDATE
ON cat_formularios
FOR EACH ROW
BEGIN
  IF OLD.nombre_formulario != NEW.nombre_formulario
    OR OLD.descripcion != NEW.descripcion
    OR OLD.plataformas != NEW.plataformas THEN
    SET NEW.version = OLD.version + 1;
  END IF;
END
$$

DELIMITER ;

--
-- Create table `cat_plantilla_pdf`
--
CREATE TABLE cat_plantilla_pdf (
  plantilla_id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  nombre_plantilla varchar(100) NOT NULL,
  descripcion text DEFAULT NULL,
  formulario_id int DEFAULT NULL COMMENT 'NULL = plantilla genérica',
  contenido_html longtext DEFAULT NULL COMMENT 'Template HTML para generar PDF',
  estilos_css text DEFAULT NULL,
  encabezado_html text DEFAULT NULL,
  pie_pagina_html text DEFAULT NULL,
  logo_url varchar(500) DEFAULT NULL,
  orientacion enum ('portrait', 'landscape') DEFAULT 'portrait',
  tamaño_pagina enum ('letter', 'legal', 'a4') DEFAULT 'letter',
  margenes_json varchar(200) DEFAULT '{"top":20,"right":15,"bottom":20,"left":15}',
  activo tinyint(1) DEFAULT 1,
  es_default tinyint(1) DEFAULT 0,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  creado_por int NOT NULL,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  modificado_por int DEFAULT NULL,
  PRIMARY KEY (plantilla_id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de plantillas de PDF para generación de documentos',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `cat_plantilla_pdf`
--
ALTER TABLE cat_plantilla_pdf
ADD INDEX idx_activo (activo);

--
-- Create index `idx_formulario` on table `cat_plantilla_pdf`
--
ALTER TABLE cat_plantilla_pdf
ADD INDEX idx_formulario (formulario_id);

--
-- Create index `idx_plantilla_entidad` on table `cat_plantilla_pdf`
--
ALTER TABLE cat_plantilla_pdf
ADD INDEX idx_plantilla_entidad (IdEntidad);

--
-- Create index `uk_plantilla_entidad` on table `cat_plantilla_pdf`
--
ALTER TABLE cat_plantilla_pdf
ADD UNIQUE INDEX uk_plantilla_entidad (IdEntidad, nombre_plantilla);

--
-- Create foreign key
--
ALTER TABLE cat_plantilla_pdf
ADD CONSTRAINT fk_plantilla_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE cat_plantilla_pdf
ADD CONSTRAINT fk_plantilla_formulario FOREIGN KEY (formulario_id)
REFERENCES cat_formularios (formulario_id) ON DELETE SET NULL;

--
-- Create table `cat_campos_formulario`
--
CREATE TABLE cat_campos_formulario (
  campo_id int NOT NULL AUTO_INCREMENT,
  formulario_id int NOT NULL,
  nombre_campo varchar(255) NOT NULL COMMENT 'Nombre interno del campo (sin espacios)',
  etiqueta_campo varchar(255) NOT NULL COMMENT 'Etiqueta visible para el usuario',
  tipo_campo enum ('texto', 'numero', 'decimal', 'fecha', 'fecha_hora', 'hora', 'email', 'telefono', 'foto', 'firma', 'dropdown', 'checkbox', 'radio', 'textarea', 'archivo', 'ubicacion', 'codigo_barras', 'separador', 'titulo_seccion') NOT NULL,
  es_requerido tinyint(1) DEFAULT 0,
  es_visible tinyint(1) DEFAULT 1,
  es_editable tinyint(1) DEFAULT 1,
  posicion_orden int DEFAULT 0,
  valor_por_defecto varchar(500) DEFAULT NULL,
  ayuda_campo text DEFAULT NULL COMMENT 'Texto de ayuda para el usuario',
  placeholder varchar(255) DEFAULT NULL COMMENT 'Texto placeholder del campo',
  longitud_maxima int DEFAULT NULL,
  longitud_minima int DEFAULT NULL,
  patron_validacion varchar(500) DEFAULT NULL COMMENT 'Expresión regular para validación',
  mensaje_error_patron varchar(255) DEFAULT NULL,
  ancho_columna int DEFAULT 12 COMMENT 'Ancho en grid Bootstrap (1-12)',
  seccion varchar(100) DEFAULT NULL COMMENT 'Nombre de la sección/grupo',
  depende_de_campo int DEFAULT NULL COMMENT 'ID del campo del que depende visibilidad',
  depende_de_valor varchar(255) DEFAULT NULL COMMENT 'Valor que debe tener el campo padre',
  formato_numero varchar(50) DEFAULT NULL COMMENT 'Formato para números: #,##0.00',
  formato_fecha varchar(50) DEFAULT 'dd/MM/yyyy',
  acepta_multiples tinyint(1) DEFAULT 0 COMMENT 'Para fotos/archivos múltiples',
  max_archivos int DEFAULT 1,
  tipos_archivo_permitidos varchar(255) DEFAULT '.jpg,.jpeg,.png,.pdf',
  tamaño_max_mb decimal(5, 2) DEFAULT 5.00,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  altura_campo int DEFAULT NULL COMMENT 'Altura del campo en pixeles (para textarea, foto, firma)',
  PRIMARY KEY (campo_id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 12,
AVG_ROW_LENGTH = 1489,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de campos individuales de cada formulario',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_campos_formulario_orden` on table `cat_campos_formulario`
--
ALTER TABLE cat_campos_formulario
ADD INDEX idx_campos_formulario_orden (formulario_id, seccion, posicion_orden);

--
-- Create index `idx_formulario` on table `cat_campos_formulario`
--
ALTER TABLE cat_campos_formulario
ADD INDEX idx_formulario (formulario_id);

--
-- Create index `idx_orden` on table `cat_campos_formulario`
--
ALTER TABLE cat_campos_formulario
ADD INDEX idx_orden (formulario_id, posicion_orden);

--
-- Create index `idx_seccion` on table `cat_campos_formulario`
--
ALTER TABLE cat_campos_formulario
ADD INDEX idx_seccion (formulario_id, seccion);

--
-- Create index `idx_tipo` on table `cat_campos_formulario`
--
ALTER TABLE cat_campos_formulario
ADD INDEX idx_tipo (tipo_campo);

--
-- Create foreign key
--
ALTER TABLE cat_campos_formulario
ADD CONSTRAINT fk_campo_depende FOREIGN KEY (depende_de_campo)
REFERENCES cat_campos_formulario (campo_id) ON DELETE SET NULL;

--
-- Create foreign key
--
ALTER TABLE cat_campos_formulario
ADD CONSTRAINT fk_campo_formulario FOREIGN KEY (formulario_id)
REFERENCES cat_formularios (formulario_id) ON DELETE CASCADE;

--
-- Create table `cat_validaciones_campo`
--
CREATE TABLE cat_validaciones_campo (
  validacion_id int NOT NULL AUTO_INCREMENT,
  campo_id int NOT NULL,
  tipo_validacion enum ('regex', 'rango_numerico', 'rango_fecha', 'longitud', 'comparacion', 'lista_valores', 'personalizada') NOT NULL,
  expresion_regular varchar(500) DEFAULT NULL,
  valor_minimo decimal(18, 4) DEFAULT NULL,
  valor_maximo decimal(18, 4) DEFAULT NULL,
  fecha_minima date DEFAULT NULL,
  fecha_maxima date DEFAULT NULL,
  longitud_minima int DEFAULT NULL,
  longitud_maxima int DEFAULT NULL,
  campo_comparacion int DEFAULT NULL COMMENT 'ID del campo a comparar',
  operador_comparacion enum ('=', '!=', '>', '<', '>=', '<=') DEFAULT NULL,
  lista_valores_permitidos text DEFAULT NULL COMMENT 'JSON array de valores permitidos',
  mensaje_error varchar(500) NOT NULL,
  orden_ejecucion int DEFAULT 0,
  activo tinyint(1) DEFAULT 1,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (validacion_id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de reglas de validación para campos del formulario',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_campo` on table `cat_validaciones_campo`
--
ALTER TABLE cat_validaciones_campo
ADD INDEX idx_campo (campo_id);

--
-- Create index `idx_tipo` on table `cat_validaciones_campo`
--
ALTER TABLE cat_validaciones_campo
ADD INDEX idx_tipo (tipo_validacion);

--
-- Create foreign key
--
ALTER TABLE cat_validaciones_campo
ADD CONSTRAINT fk_validacion_campo FOREIGN KEY (campo_id)
REFERENCES cat_campos_formulario (campo_id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE cat_validaciones_campo
ADD CONSTRAINT fk_validacion_comparacion FOREIGN KEY (campo_comparacion)
REFERENCES cat_campos_formulario (campo_id) ON DELETE SET NULL;

--
-- Create table `cat_opciones_campo`
--
CREATE TABLE cat_opciones_campo (
  opcion_id int NOT NULL AUTO_INCREMENT,
  campo_id int NOT NULL,
  valor_opcion varchar(255) NOT NULL COMMENT 'Valor que se guarda',
  etiqueta_opcion varchar(255) NOT NULL COMMENT 'Texto visible',
  descripcion_opcion text DEFAULT NULL,
  icono varchar(50) DEFAULT NULL,
  color varchar(7) DEFAULT NULL,
  posicion_orden int DEFAULT 0,
  es_default tinyint(1) DEFAULT 0,
  activo tinyint(1) DEFAULT 1,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (opcion_id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 14,
AVG_ROW_LENGTH = 1260,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de opciones para campos dropdown, radio y checkbox',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_campo` on table `cat_opciones_campo`
--
ALTER TABLE cat_opciones_campo
ADD INDEX idx_campo (campo_id);

--
-- Create index `idx_orden` on table `cat_opciones_campo`
--
ALTER TABLE cat_opciones_campo
ADD INDEX idx_orden (campo_id, posicion_orden);

--
-- Create foreign key
--
ALTER TABLE cat_opciones_campo
ADD CONSTRAINT fk_opcion_campo FOREIGN KEY (campo_id)
REFERENCES cat_campos_formulario (campo_id) ON DELETE CASCADE;

DELIMITER $$

--
-- Create procedure `sp_obtener_formulario_completo`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_obtener_formulario_completo (IN p_formulario_id int)
BEGIN
  -- Datos del formulario
  SELECT
    *
  FROM cat_formularios
  WHERE formulario_id = p_formulario_id;

  -- Campos del formulario
  SELECT
    c.*,
    (SELECT
        COUNT(*)
      FROM cat_opciones_campo
      WHERE campo_id = c.campo_id
      AND activo = TRUE) AS total_opciones,
    (SELECT
        COUNT(*)
      FROM cat_validaciones_campo
      WHERE campo_id = c.campo_id
      AND activo = TRUE) AS total_validaciones
  FROM cat_campos_formulario c
  WHERE c.formulario_id = p_formulario_id
  ORDER BY c.posicion_orden;

  -- Opciones de todos los campos
  SELECT
    o.*
  FROM cat_opciones_campo o
    JOIN cat_campos_formulario c
      ON o.campo_id = c.campo_id
  WHERE c.formulario_id = p_formulario_id
  AND o.activo = TRUE
  ORDER BY c.posicion_orden, o.posicion_orden;

  -- Validaciones de todos los campos
  SELECT
    v.*
  FROM cat_validaciones_campo v
    JOIN cat_campos_formulario c
      ON v.campo_id = c.campo_id
  WHERE c.formulario_id = p_formulario_id
  AND v.activo = TRUE
  ORDER BY c.posicion_orden, v.orden_ejecucion;
END
$$

DELIMITER ;

--
-- Create view `vw_campos_con_opciones`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_campos_con_opciones
AS
SELECT
  `c`.`campo_id` AS `campo_id`,
  `c`.`formulario_id` AS `formulario_id`,
  `f`.`nombre_formulario` AS `nombre_formulario`,
  `c`.`nombre_campo` AS `nombre_campo`,
  `c`.`etiqueta_campo` AS `etiqueta_campo`,
  `c`.`tipo_campo` AS `tipo_campo`,
  `c`.`es_requerido` AS `es_requerido`,
  `c`.`posicion_orden` AS `posicion_orden`,
  `c`.`seccion` AS `seccion`,
  GROUP_CONCAT(CONCAT(`o`.`valor_opcion`, ':', `o`.`etiqueta_opcion`) ORDER BY `o`.`posicion_orden` ASC SEPARATOR '|') AS `opciones`
FROM ((`cat_campos_formulario` `c`
  JOIN `cat_formularios` `f`
    ON ((`c`.`formulario_id` = `f`.`formulario_id`)))
  LEFT JOIN `cat_opciones_campo` `o`
    ON (((`c`.`campo_id` = `o`.`campo_id`)
    AND (`o`.`activo` = TRUE))))
GROUP BY `c`.`campo_id`;

--
-- Create table `cat_conceptos`
--
CREATE TABLE cat_conceptos (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Clave varchar(50) DEFAULT NULL,
  ClaveAlterna varchar(50) DEFAULT NULL,
  Descripcion varchar(255) DEFAULT NULL,
  IdUnidadMedida int DEFAULT NULL,
  Existencia double NOT NULL DEFAULT 0,
  IdFamilia int NOT NULL DEFAULT 0,
  CostoUnitario decimal(10, 2) NOT NULL DEFAULT 0.00,
  FactorConversion double NOT NULL DEFAULT 0,
  Minimo double NOT NULL DEFAULT 0,
  Maximo double NOT NULL DEFAULT 0,
  Inventariable tinyint(1) DEFAULT NULL,
  Activo tinyint(1) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 35,
AVG_ROW_LENGTH = 481,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Productos y servicios',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_conceptos_entidad` on table `cat_conceptos`
--
ALTER TABLE cat_conceptos
ADD INDEX idx_conceptos_entidad (IdEntidad);

--
-- Create index `uk_concepto_entidad` on table `cat_conceptos`
--
ALTER TABLE cat_conceptos
ADD UNIQUE INDEX uk_concepto_entidad (IdEntidad, Clave);

--
-- Create foreign key
--
ALTER TABLE cat_conceptos
ADD CONSTRAINT fk_conceptos_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_colonias`
--
CREATE TABLE cat_colonias (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Clave varchar(50) DEFAULT NULL,
  UnidadTerritorial varchar(255) DEFAULT NULL,
  CP varchar(10) DEFAULT NULL,
  Latitud double NOT NULL DEFAULT 0,
  Longitud double NOT NULL DEFAULT 0,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 17,
AVG_ROW_LENGTH = 1024,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_colonias_entidad` on table `cat_colonias`
--
ALTER TABLE cat_colonias
ADD INDEX idx_colonias_entidad (IdEntidad);

--
-- Create foreign key
--
ALTER TABLE cat_colonias
ADD CONSTRAINT fk_colonias_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_colaboradores`
--
CREATE TABLE cat_colaboradores (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  Clave varchar(50) DEFAULT NULL,
  Alias varchar(50) DEFAULT NULL,
  CIF varchar(20) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  Apellidos varchar(255) DEFAULT NULL,
  CP varchar(10) DEFAULT '',
  TipoVialidad varchar(255) DEFAULT NULL,
  NombreVialidad varchar(255) DEFAULT NULL,
  NoExterior varchar(255) DEFAULT NULL,
  NoInterior varchar(255) DEFAULT NULL,
  Colonia varchar(255) DEFAULT NULL,
  Localidad varchar(255) DEFAULT NULL,
  Municipio varchar(255) DEFAULT NULL,
  EntidadFederativa varchar(255) DEFAULT NULL,
  EntreCalle varchar(255) DEFAULT NULL,
  RFC varchar(20) DEFAULT NULL,
  CURP varchar(255) DEFAULT NULL,
  NoIdentificacion varchar(50) DEFAULT NULL,
  NoPadron varchar(50) DEFAULT NULL,
  FechaAlta datetime DEFAULT NULL,
  FechaInicioSAT varchar(255) DEFAULT NULL,
  FechaNacimiento date DEFAULT NULL,
  ClaveRegimen varchar(255) DEFAULT NULL,
  RegimenFiscal varchar(255) DEFAULT NULL,
  ClaveMetodo varchar(255) DEFAULT NULL,
  MetodoDePago varchar(255) DEFAULT NULL,
  ClaveForma varchar(255) DEFAULT NULL,
  FormaDePago varchar(255) DEFAULT NULL,
  ClaveUso varchar(255) DEFAULT NULL,
  UsoCFDI varchar(255) DEFAULT NULL,
  TipoPrestador int NOT NULL DEFAULT 0,
  Usuario varchar(50) DEFAULT NULL,
  Contraseña varchar(255) DEFAULT NULL,
  IdPerfil int NOT NULL DEFAULT 0,
  Activo tinyint(1) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_colaboradores_entidad` on table `cat_colaboradores`
--
ALTER TABLE cat_colaboradores
ADD INDEX idx_colaboradores_entidad (IdEntidad);

--
-- Create foreign key
--
ALTER TABLE cat_colaboradores
ADD CONSTRAINT fk_colaboradores_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `cat_categorias_ticket`
--
CREATE TABLE cat_categorias_ticket (
  id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  nombre varchar(100) NOT NULL,
  descripcion text DEFAULT NULL,
  icono_clase varchar(50) DEFAULT NULL COMMENT 'Clase CSS para icono (ej: fa-wrench)',
  color varchar(20) DEFAULT NULL COMMENT 'Color hexadecimal para UI',
  activo tinyint(1) DEFAULT 1,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 8,
AVG_ROW_LENGTH = 2340,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Catálogo de categorías de tickets',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `cat_categorias_ticket`
--
ALTER TABLE cat_categorias_ticket
ADD INDEX idx_activo (activo);

--
-- Create index `idx_cat_ticket_entidad` on table `cat_categorias_ticket`
--
ALTER TABLE cat_categorias_ticket
ADD INDEX idx_cat_ticket_entidad (IdEntidad);

--
-- Create index `idx_nombre` on table `cat_categorias_ticket`
--
ALTER TABLE cat_categorias_ticket
ADD INDEX idx_nombre (nombre);

--
-- Create foreign key
--
ALTER TABLE cat_categorias_ticket
ADD CONSTRAINT fk_cat_ticket_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

--
-- Create table `op_tickets`
--
CREATE TABLE op_tickets (
  id int NOT NULL AUTO_INCREMENT,
  folio varchar(20) NOT NULL COMMENT 'Folio único generado por backend',
  titulo varchar(200) NOT NULL,
  descripcion text NOT NULL,
  categoria_id int NOT NULL,
  prioridad enum ('Baja', 'Media', 'Alta', 'Urgente') DEFAULT 'Media',
  estado enum ('Abierto', 'Asignado', 'En Proceso', 'Resuelto', 'Cerrado', 'Cancelado') DEFAULT 'Abierto',
  usuario_creador_id int NOT NULL COMMENT 'Usuario que creó el ticket',
  usuario_asignado_id int DEFAULT NULL COMMENT 'Técnico asignado',
  entidad_id int NOT NULL,
  sub_entidad_id int DEFAULT NULL,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  fecha_asignacion datetime DEFAULT NULL,
  fecha_primera_respuesta datetime DEFAULT NULL,
  fecha_resolucion datetime DEFAULT NULL,
  fecha_cierre datetime DEFAULT NULL,
  tiempo_respuesta_minutos int DEFAULT NULL,
  tiempo_resolucion_minutos int DEFAULT NULL,
  sla_cumplido tinyint(1) DEFAULT NULL,
  calificacion int DEFAULT NULL COMMENT 'Calificación 1-5',
  comentario_calificacion text DEFAULT NULL,
  ChatId bigint DEFAULT NULL COMMENT 'ID de Telegram del cliente',
  Canal varchar(50) DEFAULT 'Web' COMMENT 'Canal: Web, Telegram, Email, etc',
  Narrativa text DEFAULT NULL COMMENT 'Descripción completa del problema',
  ClienteNombre varchar(255) DEFAULT NULL COMMENT 'Nombre del cliente',
  ClienteTelefono varchar(100) DEFAULT NULL COMMENT 'Teléfono o username Telegram',
  Resumen text DEFAULT NULL COMMENT 'Resumen breve generado por IA',
  RequiereSeguimiento tinyint(1) DEFAULT 1 COMMENT 'Si requiere seguimiento',
  ClienteValidado tinyint(1) DEFAULT 0 COMMENT 'Si el cliente está validado',
  NivelValidacion varchar(50) DEFAULT 'pendiente' COMMENT 'Nivel de validación alcanzado',
  CreditosUsados int DEFAULT 0 COMMENT 'Créditos consumidos',
  RespuestaIa text DEFAULT NULL COMMENT 'Respuesta generada por Azure OpenAI',
  PRIMARY KEY (id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Tickets de soporte y mantenimiento',
ROW_FORMAT = DYNAMIC;

--
-- Create index `folio` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD UNIQUE INDEX folio (folio);

--
-- Create index `idx_busqueda` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_busqueda (estado, prioridad, fecha_creacion DESC);

--
-- Create index `idx_categoria` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_categoria (categoria_id);

--
-- Create index `idx_entidad` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_entidad (entidad_id);

--
-- Create index `idx_estado` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_estado (estado);

--
-- Create index `idx_fecha_creacion` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_fecha_creacion (fecha_creacion);

--
-- Create index `idx_folio` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_folio (folio);

--
-- Create index `idx_op_tickets_Canal` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_op_tickets_Canal (Canal);

--
-- Create index `idx_op_tickets_ChatId` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_op_tickets_ChatId (ChatId);

--
-- Create index `idx_op_tickets_ClienteValidado` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_op_tickets_ClienteValidado (ClienteValidado);

--
-- Create index `idx_prioridad` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_prioridad (prioridad);

--
-- Create index `idx_reportes` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_reportes (fecha_creacion, estado, categoria_id);

--
-- Create index `idx_sub_entidad` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_sub_entidad (sub_entidad_id);

--
-- Create index `idx_usuario_asignado` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_usuario_asignado (usuario_asignado_id);

--
-- Create index `idx_usuario_creador` on table `op_tickets`
--
ALTER TABLE op_tickets
ADD INDEX idx_usuario_creador (usuario_creador_id);

--
-- Create foreign key
--
ALTER TABLE op_tickets
ADD CONSTRAINT fk_ticket_categoria FOREIGN KEY (categoria_id)
REFERENCES cat_categorias_ticket (id);

--
-- Create foreign key
--
ALTER TABLE op_tickets
ADD CONSTRAINT fk_ticket_entidad FOREIGN KEY (entidad_id)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_tickets
ADD CONSTRAINT fk_ticket_sub_entidad FOREIGN KEY (sub_entidad_id)
REFERENCES cat_sub_entidades (Id) ON DELETE SET NULL;

--
-- Create foreign key
--
ALTER TABLE op_tickets
ADD CONSTRAINT fk_ticket_usuario_asignado FOREIGN KEY (usuario_asignado_id)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL;

--
-- Create foreign key
--
ALTER TABLE op_tickets
ADD CONSTRAINT fk_ticket_usuario_creador FOREIGN KEY (usuario_creador_id)
REFERENCES conf_usuarios (Id);

--
-- Create table `op_ticket_timeline`
--
CREATE TABLE op_ticket_timeline (
  id int NOT NULL AUTO_INCREMENT,
  ticket_id int NOT NULL,
  tipo_evento enum ('Creado', 'Asignado', 'Reasignado', 'Cambio Estado', 'Comentario', 'Adjunto', 'Calificado', 'Cerrado') NOT NULL,
  descripcion text DEFAULT NULL,
  usuario_id int DEFAULT NULL COMMENT 'Usuario que generó el evento',
  valor_anterior varchar(200) DEFAULT NULL,
  valor_nuevo varchar(200) DEFAULT NULL,
  fecha_evento datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Historial de eventos de tickets para auditoría',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_fecha` on table `op_ticket_timeline`
--
ALTER TABLE op_ticket_timeline
ADD INDEX idx_fecha (fecha_evento);

--
-- Create index `idx_ticket` on table `op_ticket_timeline`
--
ALTER TABLE op_ticket_timeline
ADD INDEX idx_ticket (ticket_id);

--
-- Create index `idx_tipo_evento` on table `op_ticket_timeline`
--
ALTER TABLE op_ticket_timeline
ADD INDEX idx_tipo_evento (tipo_evento);

--
-- Create foreign key
--
ALTER TABLE op_ticket_timeline
ADD CONSTRAINT fk_timeline_ticket FOREIGN KEY (ticket_id)
REFERENCES op_tickets (id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_ticket_timeline
ADD CONSTRAINT fk_timeline_usuario FOREIGN KEY (usuario_id)
REFERENCES conf_usuarios (Id) ON DELETE SET NULL;

DELIMITER $$

--
-- Create procedure `sp_crear_ticket`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_crear_ticket (IN p_titulo varchar(200),
IN p_descripcion text,
IN p_categoria_id int,
IN p_prioridad varchar(20),
IN p_usuario_creador_id int,
IN p_entidad_id int,
IN p_sub_entidad_id int,
OUT p_ticket_id int,
OUT p_folio varchar(20))
BEGIN
  DECLARE v_folio varchar(20);
  DECLARE v_contador int;

  -- Generar folio único
  SELECT
    COALESCE(MAX(CAST(SUBSTRING(folio, 4) AS UNSIGNED)), 0) + 1 INTO v_contador
  FROM op_tickets
  WHERE DATE(fecha_creacion) = CURDATE();

  SET v_folio = CONCAT('TKT', DATE_FORMAT(NOW(), '%Y%m%d'), LPAD(v_contador, 4, '0'));

  -- Insertar ticket
  INSERT INTO op_tickets (folio, titulo, descripcion, categoria_id, prioridad,
  usuario_creador_id, entidad_id, sub_entidad_id, estado)
    VALUES (v_folio, p_titulo, p_descripcion, p_categoria_id, p_prioridad, p_usuario_creador_id, p_entidad_id, p_sub_entidad_id, 'Abierto');

  SET p_ticket_id = LAST_INSERT_ID();
  SET p_folio = v_folio;

  -- Registrar en timeline
  INSERT INTO op_ticket_timeline (ticket_id, tipo_evento, descripcion, usuario_id)
    VALUES (p_ticket_id, 'Creado', CONCAT('Ticket creado: ', p_titulo), p_usuario_creador_id);

END
$$

DELIMITER ;

--
-- Create table `op_ticket_notificaciones`
--
CREATE TABLE op_ticket_notificaciones (
  id int NOT NULL AUTO_INCREMENT,
  ticket_id int NOT NULL,
  usuario_id int NOT NULL COMMENT 'Usuario destinatario',
  tipo_notificacion enum ('Asignación', 'Cambio Estado', 'Nuevo Comentario', 'Solicitud Calificación', 'Vencimiento SLA') NOT NULL,
  mensaje text NOT NULL,
  leida tinyint(1) DEFAULT 0,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  fecha_lectura datetime DEFAULT NULL,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Notificaciones de tickets para usuarios',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_leida` on table `op_ticket_notificaciones`
--
ALTER TABLE op_ticket_notificaciones
ADD INDEX idx_leida (leida);

--
-- Create index `idx_pendientes` on table `op_ticket_notificaciones`
--
ALTER TABLE op_ticket_notificaciones
ADD INDEX idx_pendientes (usuario_id, leida, fecha_creacion DESC);

--
-- Create index `idx_ticket` on table `op_ticket_notificaciones`
--
ALTER TABLE op_ticket_notificaciones
ADD INDEX idx_ticket (ticket_id);

--
-- Create index `idx_usuario` on table `op_ticket_notificaciones`
--
ALTER TABLE op_ticket_notificaciones
ADD INDEX idx_usuario (usuario_id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_notificaciones
ADD CONSTRAINT fk_notif_ticket FOREIGN KEY (ticket_id)
REFERENCES op_tickets (id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_ticket_notificaciones
ADD CONSTRAINT fk_notif_usuario FOREIGN KEY (usuario_id)
REFERENCES conf_usuarios (Id) ON DELETE CASCADE;

DELIMITER $$

--
-- Create procedure `sp_asignar_ticket`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_asignar_ticket (IN p_ticket_id int,
IN p_usuario_asignado_id int,
IN p_usuario_asigna_id int)
BEGIN
  DECLARE v_titulo varchar(200);
  DECLARE v_usuario_nombre varchar(100);

  -- Obtener datos del ticket
  SELECT
    titulo INTO v_titulo
  FROM op_tickets
  WHERE id = p_ticket_id;
  SELECT
    nombre INTO v_usuario_nombre
  FROM conf_usuarios
  WHERE id = p_usuario_asignado_id;

  -- Actualizar ticket
  UPDATE op_tickets
  SET usuario_asignado_id = p_usuario_asignado_id,
      fecha_asignacion = NOW(),
      estado = 'En Proceso'
  WHERE id = p_ticket_id;

  -- Registrar en timeline
  INSERT INTO op_ticket_timeline (ticket_id, tipo_evento, descripcion, usuario_id, valor_nuevo)
    VALUES (p_ticket_id, 'Asignado', CONCAT('Ticket asignado a ', v_usuario_nombre), p_usuario_asigna_id, v_usuario_nombre);

  -- Crear notificación
  INSERT INTO op_ticket_notificaciones (ticket_id, usuario_id, tipo_notificacion, mensaje)
    VALUES (p_ticket_id, p_usuario_asignado_id, 'Asignación', CONCAT('Se te ha asignado el ticket: ', v_titulo));

END
$$

DELIMITER ;

--
-- Create table `op_ticket_comentarios`
--
CREATE TABLE op_ticket_comentarios (
  id int NOT NULL AUTO_INCREMENT,
  ticket_id int NOT NULL,
  usuario_id int NOT NULL,
  comentario text NOT NULL,
  es_interno tinyint(1) DEFAULT 0 COMMENT 'Comentario visible solo para técnicos',
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Comentarios y seguimiento de tickets',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_fecha` on table `op_ticket_comentarios`
--
ALTER TABLE op_ticket_comentarios
ADD INDEX idx_fecha (fecha_creacion);

--
-- Create index `idx_ticket` on table `op_ticket_comentarios`
--
ALTER TABLE op_ticket_comentarios
ADD INDEX idx_ticket (ticket_id);

--
-- Create index `idx_usuario` on table `op_ticket_comentarios`
--
ALTER TABLE op_ticket_comentarios
ADD INDEX idx_usuario (usuario_id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_comentarios
ADD CONSTRAINT fk_comentario_ticket FOREIGN KEY (ticket_id)
REFERENCES op_tickets (id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_ticket_comentarios
ADD CONSTRAINT fk_comentario_usuario FOREIGN KEY (usuario_id)
REFERENCES conf_usuarios (Id);

--
-- Create table `op_ticket_adjuntos`
--
CREATE TABLE op_ticket_adjuntos (
  id int NOT NULL AUTO_INCREMENT,
  ticket_id int NOT NULL,
  nombre_archivo varchar(255) NOT NULL,
  ruta_archivo varchar(500) NOT NULL COMMENT 'URL o path en Azure Blob Storage',
  tipo_mime varchar(100) DEFAULT NULL,
  tamano_bytes bigint DEFAULT NULL,
  usuario_id int NOT NULL COMMENT 'Usuario que subió el archivo',
  fecha_subida datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Archivos adjuntos a tickets (fotos, documentos)',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_fecha` on table `op_ticket_adjuntos`
--
ALTER TABLE op_ticket_adjuntos
ADD INDEX idx_fecha (fecha_subida);

--
-- Create index `idx_ticket` on table `op_ticket_adjuntos`
--
ALTER TABLE op_ticket_adjuntos
ADD INDEX idx_ticket (ticket_id);

--
-- Create index `idx_usuario` on table `op_ticket_adjuntos`
--
ALTER TABLE op_ticket_adjuntos
ADD INDEX idx_usuario (usuario_id);

--
-- Create foreign key
--
ALTER TABLE op_ticket_adjuntos
ADD CONSTRAINT fk_adjunto_ticket FOREIGN KEY (ticket_id)
REFERENCES op_tickets (id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_ticket_adjuntos
ADD CONSTRAINT fk_adjunto_usuario FOREIGN KEY (usuario_id)
REFERENCES conf_usuarios (Id);

--
-- Create table `op_telegram_notifications_queue`
--
CREATE TABLE op_telegram_notifications_queue (
  Id int NOT NULL AUTO_INCREMENT,
  TicketId int DEFAULT NULL COMMENT 'ID del ticket relacionado',
  ChatId bigint NOT NULL COMMENT 'ID de Telegram destino',
  TipoNotificacion varchar(50) NOT NULL COMMENT 'Tipo: cambio_estado, nuevo_comentario, etc',
  EstadoNuevo varchar(50) DEFAULT NULL COMMENT 'Nuevo estado del ticket',
  Mensaje text NOT NULL COMMENT 'Mensaje a enviar',
  Procesado tinyint(1) DEFAULT 0 COMMENT 'Si ya fue procesado',
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de creación',
  FechaProcesado datetime DEFAULT NULL COMMENT 'Fecha de procesamiento',
  Intentos int DEFAULT 0 COMMENT 'Intentos de envío',
  ErrorMensaje text DEFAULT NULL COMMENT 'Mensaje de error si falló',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Cola de notificaciones pendientes para enviar a Telegram',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_ChatId` on table `op_telegram_notifications_queue`
--
ALTER TABLE op_telegram_notifications_queue
ADD INDEX idx_ChatId (ChatId);

--
-- Create index `idx_FechaCreacion` on table `op_telegram_notifications_queue`
--
ALTER TABLE op_telegram_notifications_queue
ADD INDEX idx_FechaCreacion (FechaCreacion DESC);

--
-- Create index `idx_Pendientes` on table `op_telegram_notifications_queue`
--
ALTER TABLE op_telegram_notifications_queue
ADD INDEX idx_Pendientes (Procesado, FechaCreacion);

--
-- Create index `idx_TicketId` on table `op_telegram_notifications_queue`
--
ALTER TABLE op_telegram_notifications_queue
ADD INDEX idx_TicketId (TicketId);

--
-- Create index `idx_TipoNotificacion` on table `op_telegram_notifications_queue`
--
ALTER TABLE op_telegram_notifications_queue
ADD INDEX idx_TipoNotificacion (TipoNotificacion);

--
-- Create foreign key
--
ALTER TABLE op_telegram_notifications_queue
ADD CONSTRAINT fk_notif_queue_ticket FOREIGN KEY (TicketId)
REFERENCES op_tickets (id) ON DELETE SET NULL;

DELIMITER $$

--
-- Create trigger `trg_NotificarCambioEstadoTelegram`
--
CREATE
DEFINER = 'jlsg'@'%'
TRIGGER trg_NotificarCambioEstadoTelegram
AFTER UPDATE
ON op_tickets_v2
FOR EACH ROW
BEGIN
  -- Solo si cambiÃ³ el estado y el canal es Telegram
  IF OLD.Estado != NEW.Estado
    AND NEW.Canal = 'Telegram'
    AND NEW.ChatId IS NOT NULL THEN
    INSERT INTO op_telegram_notifications_queue (IdEntidad,
    IdTicket,
    ChatId,
    TipoNotificacion,
    EstadoNuevo,
    Mensaje,
    IdUsuarioCreacion)
      VALUES (NEW.IdEntidad, NEW.Id, NEW.ChatId, 'cambio_estado', NEW.Estado, CONCAT('ðŸ”” Tu ticket #', NEW.Id, ' ha cambiado a estado: ', NEW.Estado), NEW.IdUsuarioCreacion);
  END IF;
END
$$

--
-- Create trigger `trg_NotificarCambioEstado`
--
CREATE
DEFINER = 'jlsg'@'%'
TRIGGER trg_NotificarCambioEstado
AFTER UPDATE
ON op_tickets
FOR EACH ROW
BEGIN
  -- Solo si cambiÃ³ el estado y tiene ChatId (es de Telegram)
  IF OLD.Estado != NEW.Estado
    AND NEW.ChatId IS NOT NULL THEN
    INSERT INTO op_telegram_notifications_queue (TicketId,
    ChatId,
    TipoNotificacion,
    EstadoNuevo,
    Mensaje,
    FechaCreacion)
      VALUES (NEW.Id, NEW.ChatId, 'cambio_estado', NEW.Estado, CONCAT('ðŸ“‹ Tu ticket #', NEW.Folio, ' ha cambiado a estado: ', NEW.Estado), NOW());
  END IF;
END
$$

DELIMITER ;

--
-- Create table `conf_ticket_sla`
--
CREATE TABLE conf_ticket_sla (
  id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 1,
  categoria_id int NOT NULL,
  prioridad enum ('Baja', 'Media', 'Alta', 'Urgente') NOT NULL,
  tiempo_respuesta_minutos int NOT NULL COMMENT 'Tiempo máximo para primera respuesta',
  tiempo_resolucion_minutos int NOT NULL COMMENT 'Tiempo máximo para resolución',
  activo tinyint(1) DEFAULT 1,
  fecha_creacion datetime DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 13,
AVG_ROW_LENGTH = 1365,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Configuración de SLA por categoría y prioridad',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_activo` on table `conf_ticket_sla`
--
ALTER TABLE conf_ticket_sla
ADD INDEX idx_activo (activo);

--
-- Create index `idx_sla_entidad` on table `conf_ticket_sla`
--
ALTER TABLE conf_ticket_sla
ADD INDEX idx_sla_entidad (IdEntidad);

--
-- Create index `uk_categoria_prioridad` on table `conf_ticket_sla`
--
ALTER TABLE conf_ticket_sla
ADD UNIQUE INDEX uk_categoria_prioridad (categoria_id, prioridad);

--
-- Create foreign key
--
ALTER TABLE conf_ticket_sla
ADD CONSTRAINT fk_sla_categoria FOREIGN KEY (categoria_id)
REFERENCES cat_categorias_ticket (id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE conf_ticket_sla
ADD CONSTRAINT fk_sla_entidad FOREIGN KEY (IdEntidad)
REFERENCES cat_entidades (Id);

DELIMITER $$

--
-- Create procedure `sp_cambiar_estado_ticket`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_cambiar_estado_ticket (IN p_ticket_id int,
IN p_nuevo_estado varchar(20),
IN p_usuario_id int,
IN p_comentario text)
BEGIN
  DECLARE v_estado_anterior varchar(20);
  DECLARE v_usuario_creador_id int;

  -- Obtener estado anterior y usuario creador
  SELECT
    estado,
    usuario_creador_id INTO v_estado_anterior, v_usuario_creador_id
  FROM op_tickets
  WHERE id = p_ticket_id;

  -- Actualizar estado
  UPDATE op_tickets
  SET estado = p_nuevo_estado,
      fecha_resolucion = CASE WHEN p_nuevo_estado = 'Resuelto' THEN NOW() ELSE fecha_resolucion END,
      fecha_cierre = CASE WHEN p_nuevo_estado = 'Cerrado' THEN NOW() ELSE fecha_cierre END
  WHERE id = p_ticket_id;

  -- Calcular métricas si se resuelve
  IF p_nuevo_estado = 'Resuelto' THEN
    UPDATE op_tickets
    SET tiempo_resolucion_minutos = TIMESTAMPDIFF(MINUTE, fecha_creacion, NOW()),
        sla_cumplido = (SELECT
            CASE WHEN TIMESTAMPDIFF(MINUTE, t.fecha_creacion, NOW()) <= s.tiempo_resolucion_minutos THEN 1 ELSE 0 END
          FROM op_tickets t
            INNER JOIN cat_categorias_ticket c
              ON t.categoria_id = c.id
            INNER JOIN conf_ticket_sla s
              ON c.id = s.categoria_id
              AND t.prioridad = s.prioridad
          WHERE t.id = p_ticket_id)
    WHERE id = p_ticket_id;
  END IF;

  -- Registrar en timeline
  INSERT INTO op_ticket_timeline (ticket_id, tipo_evento, descripcion, usuario_id, valor_anterior, valor_nuevo)
    VALUES (p_ticket_id, 'Cambio Estado', CONCAT('Estado cambiado de ', v_estado_anterior, ' a ', p_nuevo_estado), p_usuario_id, v_estado_anterior, p_nuevo_estado);

  -- Agregar comentario si existe
  IF p_comentario IS NOT NULL
    AND p_comentario != '' THEN
    INSERT INTO op_ticket_comentarios (ticket_id, usuario_id, comentario)
      VALUES (p_ticket_id, p_usuario_id, p_comentario);
  END IF;

  -- Notificar al creador
  INSERT INTO op_ticket_notificaciones (ticket_id, usuario_id, tipo_notificacion, mensaje)
    VALUES (p_ticket_id, v_usuario_creador_id, 'Cambio Estado', CONCAT('El estado de tu ticket cambió a: ', p_nuevo_estado));

END
$$

DELIMITER ;

--
-- Create view `vw_tickets_completo`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_tickets_completo
AS
SELECT
  `t`.`id` AS `id`,
  `t`.`folio` AS `folio`,
  `t`.`titulo` AS `titulo`,
  `t`.`descripcion` AS `descripcion`,
  `t`.`prioridad` AS `prioridad`,
  `t`.`estado` AS `estado`,
  `t`.`fecha_creacion` AS `fecha_creacion`,
  `t`.`fecha_resolucion` AS `fecha_resolucion`,
  `t`.`fecha_cierre` AS `fecha_cierre`,
  `t`.`calificacion` AS `calificacion`,
  `t`.`sla_cumplido` AS `sla_cumplido`,
  `t`.`tiempo_respuesta_minutos` AS `tiempo_respuesta_minutos`,
  `t`.`tiempo_resolucion_minutos` AS `tiempo_resolucion_minutos`,
  `c`.`nombre` AS `categoria_nombre`,
  `c`.`icono_clase` AS `categoria_icono`,
  `c`.`color` AS `categoria_color`,
  `uc`.`Nombre` AS `usuario_creador_nombre`,
  `uc`.`email` AS `usuario_creador_email`,
  `ua`.`Nombre` AS `usuario_asignado_nombre`,
  `ua`.`email` AS `usuario_asignado_email`,
  `e`.`RazonSocial` AS `entidad_nombre`,
  `se`.`RazonSocial` AS `sub_entidad_nombre`,
  (SELECT
      COUNT(0)
    FROM `op_ticket_comentarios`
    WHERE (`op_ticket_comentarios`.`ticket_id` = `t`.`id`)) AS `total_comentarios`,
  (SELECT
      COUNT(0)
    FROM `op_ticket_adjuntos`
    WHERE (`op_ticket_adjuntos`.`ticket_id` = `t`.`id`)) AS `total_adjuntos`,
  `s`.`tiempo_respuesta_minutos` AS `sla_tiempo_respuesta`,
  `s`.`tiempo_resolucion_minutos` AS `sla_tiempo_resolucion`,
  TIMESTAMPDIFF(MINUTE, `t`.`fecha_creacion`, COALESCE(`t`.`fecha_resolucion`, NOW())) AS `minutos_transcurridos`,
  (CASE WHEN (`t`.`estado` IN ('Resuelto', 'Cerrado')) THEN (CASE WHEN (`t`.`sla_cumplido` = 1) THEN 'Cumplido' ELSE 'Incumplido' END) WHEN (TIMESTAMPDIFF(MINUTE, `t`.`fecha_creacion`, NOW()) > `s`.`tiempo_resolucion_minutos`) THEN 'Vencido' WHEN (TIMESTAMPDIFF(MINUTE, `t`.`fecha_creacion`, NOW()) > (`s`.`tiempo_resolucion_minutos` * 0.8)) THEN 'Por Vencer' ELSE 'En Tiempo' END) AS `estado_sla`
FROM ((((((`op_tickets` `t`
  JOIN `cat_categorias_ticket` `c`
    ON ((`t`.`categoria_id` = `c`.`id`)))
  JOIN `conf_usuarios` `uc`
    ON ((`t`.`usuario_creador_id` = `uc`.`Id`)))
  LEFT JOIN `conf_usuarios` `ua`
    ON ((`t`.`usuario_asignado_id` = `ua`.`Id`)))
  LEFT JOIN `cat_entidades` `e`
    ON ((`t`.`entidad_id` = `e`.`Id`)))
  LEFT JOIN `cat_sub_entidades` `se`
    ON ((`t`.`sub_entidad_id` = `se`.`Id`)))
  LEFT JOIN `conf_ticket_sla` `s`
    ON (((`c`.`id` = `s`.`categoria_id`)
    AND (`t`.`prioridad` = `s`.`prioridad`))));

--
-- Create table `op_documentos`
--
CREATE TABLE op_documentos (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 0,
  IdSubEntidad int NOT NULL DEFAULT 0,
  IdTipoDocumento int NOT NULL DEFAULT 0,
  NoDocumento varchar(50) DEFAULT NULL,
  FechaCreacion datetime DEFAULT NULL,
  FechaAsignacion datetime DEFAULT NULL,
  FechaCierre date DEFAULT NULL,
  NoPartidas int NOT NULL DEFAULT 0,
  Referencia varchar(255) DEFAULT NULL,
  DocumentoRelacionado varchar(50) DEFAULT NULL,
  Comentarios text DEFAULT NULL,
  IdProceso int NOT NULL DEFAULT 0,
  IdProcesoAnterior int NOT NULL DEFAULT 0,
  FechaUltimoMovimiento datetime DEFAULT NULL,
  Activo tinyint(1) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 4,
AVG_ROW_LENGTH = 8192,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `op_fallo_formulario`
--
CREATE TABLE op_fallo_formulario (
  fallo_formulario_id int NOT NULL AUTO_INCREMENT,
  fallo_id int NOT NULL COMMENT 'ID del documento de fallo en op_documentos',
  formulario_id int NOT NULL,
  entidad_id int NOT NULL,
  sub_entidad_id int DEFAULT NULL,
  proveedor_id int DEFAULT NULL,
  colaborador_id int DEFAULT NULL,
  usuario_asignado int DEFAULT NULL COMMENT 'Usuario responsable de llenar',
  fecha_asignacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  asignado_por int NOT NULL,
  fecha_limite date DEFAULT NULL,
  prioridad enum ('baja', 'media', 'alta', 'urgente') DEFAULT 'media',
  estado enum ('pendiente', 'en_proceso', 'completado', 'cancelado') DEFAULT 'pendiente',
  notas_asignacion text DEFAULT NULL,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  creado_por int NOT NULL,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  modificado_por int DEFAULT NULL,
  PRIMARY KEY (fallo_formulario_id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Operación: Asignación de formularios a documentos de fallo',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_estado` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD INDEX idx_estado (estado);

--
-- Create index `idx_fallo` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD INDEX idx_fallo (fallo_id);

--
-- Create index `idx_fallo_form_estado_fecha` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD INDEX idx_fallo_form_estado_fecha (estado, fecha_limite);

--
-- Create index `idx_fecha_limite` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD INDEX idx_fecha_limite (fecha_limite);

--
-- Create index `idx_formulario` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD INDEX idx_formulario (formulario_id);

--
-- Create index `idx_usuario_asignado` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD INDEX idx_usuario_asignado (usuario_asignado);

--
-- Create index `uk_fallo_formulario` on table `op_fallo_formulario`
--
ALTER TABLE op_fallo_formulario
ADD UNIQUE INDEX uk_fallo_formulario (fallo_id, formulario_id);

--
-- Create foreign key
--
ALTER TABLE op_fallo_formulario
ADD CONSTRAINT fk_fallo_doc FOREIGN KEY (fallo_id)
REFERENCES op_documentos (Id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_fallo_formulario
ADD CONSTRAINT fk_fallo_entidad FOREIGN KEY (entidad_id)
REFERENCES cat_entidades (Id);

--
-- Create foreign key
--
ALTER TABLE op_fallo_formulario
ADD CONSTRAINT fk_fallo_form FOREIGN KEY (formulario_id)
REFERENCES cat_formularios (formulario_id);

--
-- Create view `vw_formularios_resumen`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_formularios_resumen
AS
SELECT
  `f`.`formulario_id` AS `formulario_id`,
  `f`.`nombre_formulario` AS `nombre_formulario`,
  `f`.`descripcion` AS `descripcion`,
  `f`.`plataformas` AS `plataformas`,
  `f`.`estado` AS `estado`,
  `f`.`version` AS `version`,
  `f`.`requiere_firma` AS `requiere_firma`,
  `f`.`requiere_foto` AS `requiere_foto`,
  `f`.`tiempo_estimado_minutos` AS `tiempo_estimado_minutos`,
  `f`.`fecha_creacion` AS `fecha_creacion`,
  COUNT(DISTINCT `c`.`campo_id`) AS `total_campos`,
  SUM((CASE WHEN (`c`.`es_requerido` = TRUE) THEN 1 ELSE 0 END)) AS `campos_requeridos`,
  COUNT(DISTINCT `ff`.`fallo_formulario_id`) AS `total_asignaciones`,
  COUNT(DISTINCT (CASE WHEN (`ff`.`estado` = 'completado') THEN `ff`.`fallo_formulario_id` END)) AS `asignaciones_completadas`
FROM ((`cat_formularios` `f`
  LEFT JOIN `cat_campos_formulario` `c`
    ON ((`f`.`formulario_id` = `c`.`formulario_id`)))
  LEFT JOIN `op_fallo_formulario` `ff`
    ON ((`f`.`formulario_id` = `ff`.`formulario_id`)))
GROUP BY `f`.`formulario_id`;

--
-- Create table `op_respuesta_formulario`
--
CREATE TABLE op_respuesta_formulario (
  respuesta_id int NOT NULL AUTO_INCREMENT,
  fallo_formulario_id int NOT NULL,
  usuario_responsable int NOT NULL,
  estado_respuesta enum ('nuevo', 'en_proceso', 'pausado', 'en_revision', 'completado', 'rechazado', 'archivado') DEFAULT 'nuevo',
  porcentaje_completado decimal(5, 2) DEFAULT 0.00,
  campos_completados int DEFAULT 0,
  campos_totales int DEFAULT 0,
  campos_requeridos_completados int DEFAULT 0,
  campos_requeridos_totales int DEFAULT 0,
  fecha_inicio_llenado timestamp NULL DEFAULT NULL,
  fecha_ultimo_guardado timestamp NULL DEFAULT NULL,
  fecha_fin_llenado timestamp NULL DEFAULT NULL,
  tiempo_llenado_segundos int DEFAULT 0,
  tipo_dispositivo enum ('web', 'movil', 'escritorio', 'tablet') DEFAULT 'web',
  sistema_operativo varchar(50) DEFAULT NULL,
  version_app varchar(20) DEFAULT NULL,
  modelo_dispositivo varchar(100) DEFAULT NULL,
  ip_address varchar(45) DEFAULT NULL,
  ubicacion_latitud decimal(10, 8) DEFAULT NULL,
  ubicacion_longitud decimal(11, 8) DEFAULT NULL,
  ubicacion_precision decimal(10, 2) DEFAULT NULL,
  hash_sincronizacion varchar(64) DEFAULT NULL COMMENT 'Hash MD5 para validar integridad offline',
  sincronizado tinyint(1) DEFAULT 1,
  fecha_sincronizacion timestamp NULL DEFAULT NULL,
  intentos_sincronizacion int DEFAULT 0,
  error_sincronizacion text DEFAULT NULL,
  comentarios_revision text DEFAULT NULL,
  revisado_por int DEFAULT NULL,
  fecha_revision timestamp NULL DEFAULT NULL,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  creado_por int NOT NULL,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  modificado_por int DEFAULT NULL,
  PRIMARY KEY (respuesta_id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Operación: Instancias de respuesta/captura de formularios',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_estado` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_estado (estado_respuesta);

--
-- Create index `idx_fallo_formulario` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_fallo_formulario (fallo_formulario_id);

--
-- Create index `idx_fecha_creacion` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_fecha_creacion (fecha_creacion);

--
-- Create index `idx_hash` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_hash (hash_sincronizacion);

--
-- Create index `idx_respuestas_estado_fecha` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_respuestas_estado_fecha (estado_respuesta, fecha_creacion);

--
-- Create index `idx_sincronizado` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_sincronizado (sincronizado);

--
-- Create index `idx_usuario` on table `op_respuesta_formulario`
--
ALTER TABLE op_respuesta_formulario
ADD INDEX idx_usuario (usuario_responsable);

--
-- Create foreign key
--
ALTER TABLE op_respuesta_formulario
ADD CONSTRAINT fk_respuesta_fallo_form FOREIGN KEY (fallo_formulario_id)
REFERENCES op_fallo_formulario (fallo_formulario_id) ON DELETE CASCADE;

DELIMITER $$

--
-- Create trigger `trg_respuesta_hash`
--
CREATE
DEFINER = 'jlsg'@'%'
TRIGGER trg_respuesta_hash
BEFORE INSERT
ON op_respuesta_formulario
FOR EACH ROW
BEGIN
  SET NEW.hash_sincronizacion = MD5(CONCAT(NEW.fallo_formulario_id, '-',
  NEW.usuario_responsable, '-',
  NOW()));
END
$$

DELIMITER ;

--
-- Create view `vw_respuestas_pendientes_sync`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_respuestas_pendientes_sync
AS
SELECT
  `rf`.`respuesta_id` AS `respuesta_id`,
  `rf`.`fallo_formulario_id` AS `fallo_formulario_id`,
  `f`.`nombre_formulario` AS `nombre_formulario`,
  `rf`.`usuario_responsable` AS `usuario_responsable`,
  `rf`.`estado_respuesta` AS `estado_respuesta`,
  `rf`.`porcentaje_completado` AS `porcentaje_completado`,
  `rf`.`tipo_dispositivo` AS `tipo_dispositivo`,
  `rf`.`sincronizado` AS `sincronizado`,
  `rf`.`intentos_sincronizacion` AS `intentos_sincronizacion`,
  `rf`.`error_sincronizacion` AS `error_sincronizacion`,
  `rf`.`fecha_creacion` AS `fecha_creacion`,
  `rf`.`fecha_modificacion` AS `fecha_modificacion`
FROM ((`op_respuesta_formulario` `rf`
  JOIN `op_fallo_formulario` `ff`
    ON ((`rf`.`fallo_formulario_id` = `ff`.`fallo_formulario_id`)))
  JOIN `cat_formularios` `f`
    ON ((`ff`.`formulario_id` = `f`.`formulario_id`)))
WHERE (`rf`.`sincronizado` = FALSE)
ORDER BY `rf`.`fecha_modificacion` DESC;

--
-- Create view `vw_estadisticas_formularios_entidad`
--
CREATE
DEFINER = 'jlsg'@'%'
VIEW vw_estadisticas_formularios_entidad
AS
SELECT
  `ff`.`entidad_id` AS `entidad_id`,
  `e`.`RazonSocial` AS `nombre_entidad`,
  COUNT(DISTINCT `ff`.`fallo_formulario_id`) AS `total_asignaciones`,
  COUNT(DISTINCT (CASE WHEN (`ff`.`estado` = 'pendiente') THEN `ff`.`fallo_formulario_id` END)) AS `pendientes`,
  COUNT(DISTINCT (CASE WHEN (`ff`.`estado` = 'en_proceso') THEN `ff`.`fallo_formulario_id` END)) AS `en_proceso`,
  COUNT(DISTINCT (CASE WHEN (`ff`.`estado` = 'completado') THEN `ff`.`fallo_formulario_id` END)) AS `completados`,
  AVG(`rf`.`porcentaje_completado`) AS `promedio_completado`,
  AVG(`rf`.`tiempo_llenado_segundos`) AS `tiempo_promedio_segundos`
FROM ((`op_fallo_formulario` `ff`
  JOIN `cat_entidades` `e`
    ON ((`ff`.`entidad_id` = `e`.`Id`)))
  LEFT JOIN `op_respuesta_formulario` `rf`
    ON ((`ff`.`fallo_formulario_id` = `rf`.`fallo_formulario_id`)))
GROUP BY `ff`.`entidad_id`,
         `e`.`RazonSocial`;

--
-- Create table `op_respuesta_campo`
--
CREATE TABLE op_respuesta_campo (
  respuesta_campo_id int NOT NULL AUTO_INCREMENT,
  respuesta_id int NOT NULL,
  campo_id int NOT NULL,
  valor_texto text DEFAULT NULL COMMENT 'Valor para campos de texto',
  valor_numero decimal(18, 4) DEFAULT NULL COMMENT 'Valor para campos numéricos',
  valor_fecha datetime DEFAULT NULL COMMENT 'Valor para campos de fecha/hora',
  valor_booleano tinyint(1) DEFAULT NULL COMMENT 'Valor para checkboxes',
  valor_json text DEFAULT NULL COMMENT 'Valor para campos complejos (múltiples selecciones, etc)',
  valor_archivo_nombre varchar(255) DEFAULT NULL,
  valor_archivo_ruta_local varchar(500) DEFAULT NULL COMMENT 'Ruta local en dispositivo móvil',
  valor_archivo_url_azure varchar(500) DEFAULT NULL COMMENT 'URL en Azure Blob Storage',
  valor_archivo_contenedor varchar(100) DEFAULT NULL,
  valor_archivo_blob_name varchar(255) DEFAULT NULL,
  valor_archivo_tamaño_bytes bigint DEFAULT NULL,
  valor_archivo_tipo_mime varchar(100) DEFAULT NULL,
  valor_firma_ruta_local varchar(500) DEFAULT NULL,
  valor_firma_url_azure varchar(500) DEFAULT NULL,
  ubicacion_latitud decimal(10, 8) DEFAULT NULL,
  ubicacion_longitud decimal(11, 8) DEFAULT NULL,
  ubicacion_direccion varchar(500) DEFAULT NULL,
  es_valido tinyint(1) DEFAULT 1,
  mensaje_validacion varchar(500) DEFAULT NULL,
  tiempo_captura_segundos int DEFAULT 0,
  cantidad_modificaciones int DEFAULT 1,
  fecha_primera_captura timestamp NULL DEFAULT NULL,
  fecha_ultima_modificacion timestamp NULL DEFAULT NULL,
  capturado_offline tinyint(1) DEFAULT 0,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (respuesta_campo_id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Operación: Valores de respuesta para cada campo del formulario',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_campo` on table `op_respuesta_campo`
--
ALTER TABLE op_respuesta_campo
ADD INDEX idx_campo (campo_id);

--
-- Create index `idx_offline` on table `op_respuesta_campo`
--
ALTER TABLE op_respuesta_campo
ADD INDEX idx_offline (capturado_offline);

--
-- Create index `idx_respuesta` on table `op_respuesta_campo`
--
ALTER TABLE op_respuesta_campo
ADD INDEX idx_respuesta (respuesta_id);

--
-- Create index `uk_respuesta_campo` on table `op_respuesta_campo`
--
ALTER TABLE op_respuesta_campo
ADD UNIQUE INDEX uk_respuesta_campo (respuesta_id, campo_id);

--
-- Create foreign key
--
ALTER TABLE op_respuesta_campo
ADD CONSTRAINT fk_resp_campo_campo FOREIGN KEY (campo_id)
REFERENCES cat_campos_formulario (campo_id);

--
-- Create foreign key
--
ALTER TABLE op_respuesta_campo
ADD CONSTRAINT fk_resp_campo_respuesta FOREIGN KEY (respuesta_id)
REFERENCES op_respuesta_formulario (respuesta_id) ON DELETE CASCADE;

DELIMITER $$

--
-- Create procedure `sp_actualizar_progreso_respuesta`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_actualizar_progreso_respuesta (IN p_respuesta_id int)
BEGIN
  DECLARE v_campos_completados int;
  DECLARE v_campos_requeridos_completados int;
  DECLARE v_campos_totales int;
  DECLARE v_campos_requeridos_totales int;
  DECLARE v_porcentaje decimal(5, 2);

  -- Obtener totales de la respuesta
  SELECT
    campos_totales,
    campos_requeridos_totales INTO v_campos_totales, v_campos_requeridos_totales
  FROM op_respuesta_formulario
  WHERE respuesta_id = p_respuesta_id;

  -- Contar campos completados
  SELECT
    COUNT(*),
    SUM(CASE WHEN c.es_requerido = TRUE THEN 1 ELSE 0 END) INTO v_campos_completados, v_campos_requeridos_completados
  FROM op_respuesta_campo rc
    JOIN cat_campos_formulario c
      ON rc.campo_id = c.campo_id
  WHERE rc.respuesta_id = p_respuesta_id
  AND (
  rc.valor_texto IS NOT NULL
  OR rc.valor_numero IS NOT NULL
  OR rc.valor_fecha IS NOT NULL
  OR rc.valor_booleano IS NOT NULL
  OR rc.valor_json IS NOT NULL
  OR rc.valor_archivo_url_azure IS NOT NULL
  OR rc.valor_firma_url_azure IS NOT NULL
  );

  -- Calcular porcentaje
  IF v_campos_totales > 0 THEN
    SET v_porcentaje = (v_campos_completados / v_campos_totales) * 100;
  ELSE
    SET v_porcentaje = 0;
  END IF;

  -- Actualizar respuesta
  UPDATE op_respuesta_formulario
  SET campos_completados = v_campos_completados,
      campos_requeridos_completados = v_campos_requeridos_completados,
      porcentaje_completado = v_porcentaje,
      fecha_ultimo_guardado = NOW()
  WHERE respuesta_id = p_respuesta_id;
END
$$

DELIMITER ;

--
-- Create table `op_documento_formulario_pdf`
--
CREATE TABLE op_documento_formulario_pdf (
  documento_pdf_id int NOT NULL AUTO_INCREMENT,
  respuesta_id int NOT NULL,
  fallo_id int NOT NULL COMMENT 'Referencia al documento padre',
  nombre_archivo varchar(255) NOT NULL,
  ruta_local_pdf varchar(500) DEFAULT NULL,
  url_pdf_azure varchar(500) DEFAULT NULL,
  contenedor_azure varchar(100) DEFAULT 'formularios-pdf',
  blob_name_azure varchar(255) DEFAULT NULL,
  tamaño_bytes bigint DEFAULT NULL,
  numero_paginas int DEFAULT 1,
  hash_md5 varchar(32) DEFAULT NULL COMMENT 'Hash para verificar integridad',
  hash_sha256 varchar(64) DEFAULT NULL,
  estado_almacenamiento enum ('pendiente', 'generando', 'subiendo', 'completado', 'error', 'eliminado') DEFAULT 'pendiente',
  intentos_generacion int DEFAULT 0,
  intentos_almacenamiento int DEFAULT 0,
  error_generacion text DEFAULT NULL,
  error_almacenamiento text DEFAULT NULL,
  fecha_generacion timestamp NULL DEFAULT NULL,
  fecha_almacenamiento timestamp NULL DEFAULT NULL,
  generado_por int DEFAULT NULL,
  plantilla_pdf varchar(100) DEFAULT NULL COMMENT 'Nombre de la plantilla usada',
  incluye_fotos tinyint(1) DEFAULT 1,
  incluye_firma tinyint(1) DEFAULT 1,
  incluye_ubicacion tinyint(1) DEFAULT 1,
  metadata_json text DEFAULT NULL COMMENT 'Metadatos adicionales del PDF',
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  creado_por int NOT NULL,
  fecha_modificacion timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  modificado_por int DEFAULT NULL,
  PRIMARY KEY (documento_pdf_id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Operación: PDFs generados de formularios completados',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_estado` on table `op_documento_formulario_pdf`
--
ALTER TABLE op_documento_formulario_pdf
ADD INDEX idx_estado (estado_almacenamiento);

--
-- Create index `idx_fallo` on table `op_documento_formulario_pdf`
--
ALTER TABLE op_documento_formulario_pdf
ADD INDEX idx_fallo (fallo_id);

--
-- Create index `idx_fecha` on table `op_documento_formulario_pdf`
--
ALTER TABLE op_documento_formulario_pdf
ADD INDEX idx_fecha (fecha_creacion);

--
-- Create index `uk_respuesta_pdf` on table `op_documento_formulario_pdf`
--
ALTER TABLE op_documento_formulario_pdf
ADD UNIQUE INDEX uk_respuesta_pdf (respuesta_id);

--
-- Create foreign key
--
ALTER TABLE op_documento_formulario_pdf
ADD CONSTRAINT fk_pdf_fallo FOREIGN KEY (fallo_id)
REFERENCES op_documentos (Id) ON DELETE CASCADE;

--
-- Create foreign key
--
ALTER TABLE op_documento_formulario_pdf
ADD CONSTRAINT fk_pdf_respuesta FOREIGN KEY (respuesta_id)
REFERENCES op_respuesta_formulario (respuesta_id) ON DELETE CASCADE;

--
-- Create table `op_formulario_historial`
--
CREATE TABLE op_formulario_historial (
  historial_id int NOT NULL AUTO_INCREMENT,
  tipo_entidad enum ('formulario', 'campo', 'respuesta', 'asignacion') NOT NULL,
  entidad_id int NOT NULL,
  accion enum ('crear', 'modificar', 'eliminar', 'activar', 'desactivar', 'asignar', 'completar', 'rechazar') NOT NULL,
  datos_anteriores json DEFAULT NULL,
  datos_nuevos json DEFAULT NULL,
  campo_modificado varchar(100) DEFAULT NULL,
  valor_anterior text DEFAULT NULL,
  valor_nuevo text DEFAULT NULL,
  ip_address varchar(45) DEFAULT NULL,
  user_agent varchar(500) DEFAULT NULL,
  usuario_id int NOT NULL,
  fecha_creacion timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (historial_id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Operación: Historial de cambios para auditoría',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_accion` on table `op_formulario_historial`
--
ALTER TABLE op_formulario_historial
ADD INDEX idx_accion (accion);

--
-- Create index `idx_fecha` on table `op_formulario_historial`
--
ALTER TABLE op_formulario_historial
ADD INDEX idx_fecha (fecha_creacion);

--
-- Create index `idx_tipo_entidad` on table `op_formulario_historial`
--
ALTER TABLE op_formulario_historial
ADD INDEX idx_tipo_entidad (tipo_entidad, entidad_id);

--
-- Create index `idx_usuario` on table `op_formulario_historial`
--
ALTER TABLE op_formulario_historial
ADD INDEX idx_usuario (usuario_id);

DELIMITER $$

--
-- Create procedure `sp_crear_respuesta_formulario`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_crear_respuesta_formulario (IN p_fallo_formulario_id int,
IN p_usuario_id int,
IN p_tipo_dispositivo varchar(20),
IN p_version_app varchar(20),
IN p_ip_address varchar(45),
OUT p_respuesta_id int)
BEGIN
  DECLARE v_campos_totales int;
  DECLARE v_campos_requeridos int;

  -- Contar campos del formulario
  SELECT
    COUNT(*),
    SUM(CASE WHEN c.es_requerido = TRUE THEN 1 ELSE 0 END) INTO v_campos_totales, v_campos_requeridos
  FROM cat_campos_formulario c
    JOIN op_fallo_formulario ff
      ON c.formulario_id = ff.formulario_id
  WHERE ff.fallo_formulario_id = p_fallo_formulario_id
  AND c.tipo_campo NOT IN ('separador', 'titulo_seccion');

  -- Crear respuesta
  INSERT INTO op_respuesta_formulario (fallo_formulario_id,
  usuario_responsable,
  estado_respuesta,
  campos_totales,
  campos_requeridos_totales,
  tipo_dispositivo,
  version_app,
  ip_address,
  fecha_inicio_llenado,
  creado_por)
    VALUES (p_fallo_formulario_id, p_usuario_id, 'en_proceso', v_campos_totales, v_campos_requeridos, p_tipo_dispositivo, p_version_app, p_ip_address, NOW(), p_usuario_id);

  SET p_respuesta_id = LAST_INSERT_ID();

  -- Actualizar estado de la asignación
  UPDATE op_fallo_formulario
  SET estado = 'en_proceso',
      fecha_modificacion = NOW()
  WHERE fallo_formulario_id = p_fallo_formulario_id;

  -- Registrar en historial
  INSERT INTO op_formulario_historial (tipo_entidad, entidad_id, accion, usuario_id, ip_address)
    VALUES ('respuesta', p_respuesta_id, 'crear', p_usuario_id, p_ip_address);
END
$$

--
-- Create procedure `sp_completar_respuesta_formulario`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_completar_respuesta_formulario (IN p_respuesta_id int,
IN p_usuario_id int,
OUT p_exito boolean,
OUT p_mensaje varchar(500))
BEGIN
  DECLARE v_campos_requeridos_faltantes int;
  DECLARE v_fallo_formulario_id int;
  DECLARE v_tiempo_total int;

  -- Verificar campos requeridos
  SELECT
    rf.fallo_formulario_id,
    rf.campos_requeridos_totales - rf.campos_requeridos_completados,
    TIMESTAMPDIFF(SECOND, rf.fecha_inicio_llenado, NOW()) INTO v_fallo_formulario_id, v_campos_requeridos_faltantes, v_tiempo_total
  FROM op_respuesta_formulario rf
  WHERE rf.respuesta_id = p_respuesta_id;

  IF v_campos_requeridos_faltantes > 0 THEN
    SET p_exito = FALSE;
    SET p_mensaje = CONCAT('Faltan ', v_campos_requeridos_faltantes, ' campos requeridos por completar');
  ELSE
    -- Actualizar respuesta como completada
    UPDATE op_respuesta_formulario
    SET estado_respuesta = 'completado',
        porcentaje_completado = 100.00,
        fecha_fin_llenado = NOW(),
        tiempo_llenado_segundos = v_tiempo_total,
        modificado_por = p_usuario_id
    WHERE respuesta_id = p_respuesta_id;

    -- Actualizar asignación
    UPDATE op_fallo_formulario
    SET estado = 'completado',
        fecha_modificacion = NOW(),
        modificado_por = p_usuario_id
    WHERE fallo_formulario_id = v_fallo_formulario_id;

    -- Registrar en historial
    INSERT INTO op_formulario_historial (tipo_entidad, entidad_id, accion, usuario_id)
      VALUES ('respuesta', p_respuesta_id, 'completar', p_usuario_id);

    SET p_exito = TRUE;
    SET p_mensaje = 'Formulario completado exitosamente';
  END IF;
END
$$

DELIMITER ;

--
-- Create table `op_medidorlectura`
--
CREATE TABLE op_medidorlectura (
  IdLectura bigint NOT NULL AUTO_INCREMENT,
  IdMedidor int NOT NULL,
  TsLectura datetime NOT NULL,
  VolumenTotal double DEFAULT NULL,
  CaudalInstantaneo double DEFAULT NULL,
  TemperaturaAgua double DEFAULT NULL,
  BateriaPorcentaje double DEFAULT NULL,
  Rssi int DEFAULT NULL,
  Snr double DEFAULT NULL,
  PayloadRaw text DEFAULT NULL,
  Fuente varchar(50) NOT NULL DEFAULT 'helium',
  FechaRecepcion datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (IdLectura)
)
ENGINE = INNODB,
AUTO_INCREMENT = 3,
AVG_ROW_LENGTH = 8192,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_0900_ai_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `op_medidorevento`
--
CREATE TABLE op_medidorevento (
  IdEvento bigint NOT NULL AUTO_INCREMENT,
  IdMedidor int NOT NULL DEFAULT 0,
  IdLectura int NOT NULL DEFAULT 0,
  TsEvento datetime DEFAULT NULL,
  TipoEvento varchar(50) NOT NULL DEFAULT '0',
  Severidad varchar(20) DEFAULT NULL,
  Descripcion varchar(255) DEFAULT NULL,
  PayloadRaw text DEFAULT NULL,
  Fuente varchar(50) NOT NULL DEFAULT 'helium',
  FechaRecepcion datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (IdEvento)
)
ENGINE = INNODB,
AUTO_INCREMENT = 3,
AVG_ROW_LENGTH = 8192,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_0900_ai_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `IdxEventoMedidorTs` on table `op_medidorevento`
--
ALTER TABLE op_medidorevento
ADD INDEX IdxEventoMedidorTs (IdMedidor);

--
-- Create table `op_documentos_detalle`
--
CREATE TABLE op_documentos_detalle (
  Id int NOT NULL AUTO_INCREMENT,
  IdDocumento int NOT NULL DEFAULT 0,
  IdConcepto int NOT NULL DEFAULT 0,
  IdProceso int DEFAULT NULL,
  IdUsuario int DEFAULT NULL,
  NoPartida int NOT NULL DEFAULT 0,
  CantidadPedida double NOT NULL DEFAULT 0,
  CantidadOperada double NOT NULL DEFAULT 0,
  CostoUnitario decimal(10, 2) DEFAULT NULL,
  CostoTotal decimal(10, 2) DEFAULT NULL,
  FechaMovimiento datetime DEFAULT NULL,
  PorcentajeOperacion double NOT NULL DEFAULT 0,
  Referencia varchar(255) DEFAULT NULL,
  Informativo varchar(255) DEFAULT NULL,
  Comentarios text DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `op_documentos_colonias`
--
CREATE TABLE op_documentos_colonias (
  Id int NOT NULL AUTO_INCREMENT,
  IdDocumento int DEFAULT NULL,
  IdColonia int DEFAULT NULL,
  NoPartida int DEFAULT NULL,
  MontoMinimo decimal(10, 2) DEFAULT NULL,
  MontoMaximo decimal(10, 2) DEFAULT NULL,
  Comentarios text DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `log_validacion_telegram`
--
CREATE TABLE log_validacion_telegram (
  Id int NOT NULL AUTO_INCREMENT,
  ChatId bigint NOT NULL COMMENT 'ID de Telegram',
  FechaValidacion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de validación',
  Resultado enum ('aprobado', 'rechazado', 'pendiente') NOT NULL COMMENT 'Resultado de validación',
  NivelAlcanzado varchar(50) DEFAULT NULL COMMENT 'Nivel de validación alcanzado (1-7)',
  RazonRechazo text DEFAULT NULL COMMENT 'Razón del rechazo si aplica',
  IpOrigen varchar(50) DEFAULT NULL COMMENT 'IP de origen',
  Metadatos json DEFAULT NULL COMMENT 'Datos adicionales en formato JSON',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Logs de validación de residentes Telegram',
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_ChatId` on table `log_validacion_telegram`
--
ALTER TABLE log_validacion_telegram
ADD INDEX idx_ChatId (ChatId);

--
-- Create index `idx_FechaValidacion` on table `log_validacion_telegram`
--
ALTER TABLE log_validacion_telegram
ADD INDEX idx_FechaValidacion (FechaValidacion DESC);

--
-- Create index `idx_NivelAlcanzado` on table `log_validacion_telegram`
--
ALTER TABLE log_validacion_telegram
ADD INDEX idx_NivelAlcanzado (NivelAlcanzado);

--
-- Create index `idx_Resultado` on table `log_validacion_telegram`
--
ALTER TABLE log_validacion_telegram
ADD INDEX idx_Resultado (Resultado);

--
-- Create table `conf_residentes_whitelist`
--
CREATE TABLE conf_residentes_whitelist (
  Id int NOT NULL AUTO_INCREMENT,
  ChatId bigint NOT NULL COMMENT 'ID de Telegram',
  ResidenteNombre varchar(255) NOT NULL COMMENT 'Nombre del residente',
  Email varchar(255) DEFAULT NULL COMMENT 'Email del residente',
  Empresa varchar(255) DEFAULT NULL COMMENT 'Empresa o condominio',
  FechaAprobacion datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de aprobación',
  AprobadoPor varchar(100) DEFAULT NULL COMMENT 'Usuario que aprobó',
  Notas text DEFAULT NULL COMMENT 'Notas adicionales',
  Prioridad enum ('alta', 'media', 'baja') DEFAULT 'media' COMMENT 'Prioridad del residente',
  Activo tinyint(1) DEFAULT 1 COMMENT 'Si el registro está activo',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Residentes preaprobados para crear tickets',
ROW_FORMAT = DYNAMIC;

--
-- Create index `ChatId` on table `conf_residentes_whitelist`
--
ALTER TABLE conf_residentes_whitelist
ADD UNIQUE INDEX ChatId (ChatId);

--
-- Create index `idx_Activo` on table `conf_residentes_whitelist`
--
ALTER TABLE conf_residentes_whitelist
ADD INDEX idx_Activo (Activo);

--
-- Create index `idx_ChatId` on table `conf_residentes_whitelist`
--
ALTER TABLE conf_residentes_whitelist
ADD INDEX idx_ChatId (ChatId);

--
-- Create index `idx_FechaAprobacion` on table `conf_residentes_whitelist`
--
ALTER TABLE conf_residentes_whitelist
ADD INDEX idx_FechaAprobacion (FechaAprobacion DESC);

--
-- Create index `idx_Prioridad` on table `conf_residentes_whitelist`
--
ALTER TABLE conf_residentes_whitelist
ADD INDEX idx_Prioridad (Prioridad);

--
-- Create table `conf_residentes_telegram`
--
CREATE TABLE conf_residentes_telegram (
  Id int NOT NULL AUTO_INCREMENT,
  ChatId bigint NOT NULL COMMENT 'ID de Telegram',
  Username varchar(255) DEFAULT NULL COMMENT 'Username de Telegram (@usuario)',
  FirstName varchar(255) DEFAULT NULL COMMENT 'Nombre de Telegram',
  LastName varchar(255) DEFAULT NULL COMMENT 'Apellido de Telegram',
  EstadoResidente enum ('activo', 'bloqueado', 'suspendido') DEFAULT 'activo' COMMENT 'Estado del residente',
  TipoResidente enum ('standard', 'premium', 'trial') DEFAULT 'standard' COMMENT 'Tipo de suscripción',
  FechaVencimiento date DEFAULT NULL COMMENT 'Fecha de vencimiento de suscripción',
  CreditosDisponibles int DEFAULT 0 COMMENT 'Créditos disponibles para usar',
  TicketsMesActual int DEFAULT 0 COMMENT 'Tickets creados en el mes actual',
  LimiteTicketsMes int DEFAULT 50 COMMENT 'Límite de tickets por mes',
  UltimaActividad datetime DEFAULT NULL COMMENT 'Última actividad del residente',
  RazonBloqueo text DEFAULT NULL COMMENT 'Razón del bloqueo si aplica',
  BloqueadoPor varchar(100) DEFAULT NULL COMMENT 'Usuario que bloqueó',
  FechaBloqueo datetime DEFAULT NULL COMMENT 'Fecha de bloqueo',
  IntentosFallidos int DEFAULT 0 COMMENT 'Intentos fallidos de validación',
  IpUltimoAcceso varchar(50) DEFAULT NULL COMMENT 'IP del último acceso',
  FechaRegistro datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de registro',
  Activo tinyint(1) DEFAULT 1 COMMENT 'Si el registro está activo',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Residentes registrados desde Telegram',
ROW_FORMAT = DYNAMIC;

--
-- Create index `ChatId` on table `conf_residentes_telegram`
--
ALTER TABLE conf_residentes_telegram
ADD UNIQUE INDEX ChatId (ChatId);

--
-- Create index `idx_Activo` on table `conf_residentes_telegram`
--
ALTER TABLE conf_residentes_telegram
ADD INDEX idx_Activo (Activo);

--
-- Create index `idx_ChatId` on table `conf_residentes_telegram`
--
ALTER TABLE conf_residentes_telegram
ADD INDEX idx_ChatId (ChatId);

--
-- Create index `idx_EstadoResidente` on table `conf_residentes_telegram`
--
ALTER TABLE conf_residentes_telegram
ADD INDEX idx_EstadoResidente (EstadoResidente);

--
-- Create index `idx_FechaRegistro` on table `conf_residentes_telegram`
--
ALTER TABLE conf_residentes_telegram
ADD INDEX idx_FechaRegistro (FechaRegistro DESC);

--
-- Create index `idx_TipoResidente` on table `conf_residentes_telegram`
--
ALTER TABLE conf_residentes_telegram
ADD INDEX idx_TipoResidente (TipoResidente);

--
-- Create table `conf_residentes_blacklist`
--
CREATE TABLE conf_residentes_blacklist (
  Id int NOT NULL AUTO_INCREMENT,
  ChatId bigint NOT NULL COMMENT 'ID de Telegram',
  Username varchar(255) DEFAULT NULL COMMENT 'Username de Telegram',
  RazonBloqueo text NOT NULL COMMENT 'Razón del bloqueo',
  FechaBloqueo datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'Fecha de bloqueo',
  BloqueadoPor varchar(100) DEFAULT NULL COMMENT 'Usuario que bloqueó',
  Permanente tinyint(1) DEFAULT 0 COMMENT 'Si el bloqueo es permanente',
  FechaLevantamiento datetime DEFAULT NULL COMMENT 'Fecha programada para levantar bloqueo',
  NotasAdicionales text DEFAULT NULL COMMENT 'Notas adicionales',
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
COMMENT = 'Residentes bloqueados para crear tickets',
ROW_FORMAT = DYNAMIC;

--
-- Create index `ChatId` on table `conf_residentes_blacklist`
--
ALTER TABLE conf_residentes_blacklist
ADD UNIQUE INDEX ChatId (ChatId);

--
-- Create index `idx_ChatId` on table `conf_residentes_blacklist`
--
ALTER TABLE conf_residentes_blacklist
ADD INDEX idx_ChatId (ChatId);

--
-- Create index `idx_FechaBloqueo` on table `conf_residentes_blacklist`
--
ALTER TABLE conf_residentes_blacklist
ADD INDEX idx_FechaBloqueo (FechaBloqueo DESC);

--
-- Create index `idx_FechaLevantamiento` on table `conf_residentes_blacklist`
--
ALTER TABLE conf_residentes_blacklist
ADD INDEX idx_FechaLevantamiento (FechaLevantamiento);

--
-- Create index `idx_Permanente` on table `conf_residentes_blacklist`
--
ALTER TABLE conf_residentes_blacklist
ADD INDEX idx_Permanente (Permanente);

--
-- Create table `cat_vehiculos_unidad`
--
CREATE TABLE cat_vehiculos_unidad (
  Id int NOT NULL AUTO_INCREMENT,
  UnidadId int NOT NULL,
  ResidenteId int DEFAULT NULL,
  Placas varchar(20) NOT NULL,
  TipoVehiculo varchar(50) DEFAULT NULL,
  Marca varchar(50) DEFAULT NULL,
  Modelo varchar(50) DEFAULT NULL,
  Anio int DEFAULT NULL,
  Color varchar(30) DEFAULT NULL,
  NumeroMotor varchar(50) DEFAULT NULL,
  NumeroSerie varchar(50) DEFAULT NULL,
  TipoCombustible varchar(30) DEFAULT NULL,
  CapacidadPasajeros int DEFAULT NULL,
  UsoVehiculo varchar(30) DEFAULT NULL,
  NumeroTarjeton varchar(50) DEFAULT NULL,
  FechaExpedicionTarjeta date DEFAULT NULL,
  FechaVigenciaTarjeta date DEFAULT NULL,
  PropietarioRegistrado varchar(200) DEFAULT NULL,
  Observaciones text DEFAULT NULL,
  Activo tinyint(1) DEFAULT 1,
  FechaCreacion datetime DEFAULT CURRENT_TIMESTAMP,
  FechaModificacion datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 2,
AVG_ROW_LENGTH = 16384,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create index `idx_placas` on table `cat_vehiculos_unidad`
--
ALTER TABLE cat_vehiculos_unidad
ADD INDEX idx_placas (Placas);

--
-- Create index `idx_residente` on table `cat_vehiculos_unidad`
--
ALTER TABLE cat_vehiculos_unidad
ADD INDEX idx_residente (ResidenteId);

--
-- Create index `idx_unidad` on table `cat_vehiculos_unidad`
--
ALTER TABLE cat_vehiculos_unidad
ADD INDEX idx_unidad (UnidadId);

--
-- Create table `cat_usos_cfdi`
--
CREATE TABLE cat_usos_cfdi (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(10) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 25,
AVG_ROW_LENGTH = 682,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_unidades_medidas`
--
CREATE TABLE cat_unidades_medidas (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(20) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  ClaveSat varchar(20) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 5,
AVG_ROW_LENGTH = 4096,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_tipo_documentos`
--
CREATE TABLE cat_tipo_documentos (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(20) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 5,
AVG_ROW_LENGTH = 4096,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_regimen_fiscal`
--
CREATE TABLE cat_regimen_fiscal (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(10) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 27,
AVG_ROW_LENGTH = 630,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_metodo_de_pago`
--
CREATE TABLE cat_metodo_de_pago (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(10) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 4,
AVG_ROW_LENGTH = 8192,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_forma_de_pago`
--
CREATE TABLE cat_forma_de_pago (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(10) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 20,
AVG_ROW_LENGTH = 862,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_documentos`
--
CREATE TABLE cat_documentos (
  Id int NOT NULL AUTO_INCREMENT,
  IdEntidad int NOT NULL DEFAULT 0,
  IdSubEntidad int NOT NULL DEFAULT 0,
  IdTipoDocumento int NOT NULL DEFAULT 0,
  Nombre varchar(255) DEFAULT NULL,
  RutaURL varchar(255) DEFAULT NULL,
  Parametros varchar(255) DEFAULT NULL,
  FechaDocumento date DEFAULT NULL,
  FechaExpiracion date DEFAULT NULL,
  FechaAlta date DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

--
-- Create table `cat_conceptos_familias`
--
CREATE TABLE cat_conceptos_familias (
  Id int NOT NULL AUTO_INCREMENT,
  Clave varchar(20) DEFAULT NULL,
  Nombre varchar(255) DEFAULT NULL,
  PRIMARY KEY (Id)
)
ENGINE = INNODB,
AUTO_INCREMENT = 5,
AVG_ROW_LENGTH = 4096,
CHARACTER SET utf8mb4,
COLLATE utf8mb4_unicode_ci,
ROW_FORMAT = DYNAMIC;

DELIMITER $$

--
-- Create procedure `sp_GenerarFolioTicket`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_GenerarFolioTicket (OUT nuevoFolio varchar(50))
BEGIN
  DECLARE fechaHoy varchar(8);
  DECLARE secuencial int;

  SET fechaHoy = DATE_FORMAT(NOW(), '%Y%m%d');

  -- Obtener el último secuencial del día
  SELECT
    COALESCE(MAX(CAST(SUBSTRING(Folio, -4) AS UNSIGNED)), 0) + 1 INTO secuencial
  FROM Tickets
  WHERE Folio LIKE CONCAT('TKT-', fechaHoy, '-%');

  -- Generar folio con formato TKT-YYYYMMDD-XXXX
  SET nuevoFolio = CONCAT('TKT-', fechaHoy, '-', LPAD(secuencial, 4, '0'));
END
$$

--
-- Create procedure `sp_ActualizarTiemposTicket`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE sp_ActualizarTiemposTicket (IN ticketId int)
BEGIN
  UPDATE Tickets
  SET TiempoRespuesta = CASE WHEN FechaAsignacion IS NOT NULL THEN TIMESTAMPDIFF(MINUTE, FechaCreacion, FechaAsignacion) ELSE NULL END,
      TiempoResolucion = CASE WHEN FechaResolucion IS NOT NULL THEN TIMESTAMPDIFF(MINUTE, FechaCreacion, FechaResolucion) ELSE NULL END
  WHERE Id = ticketId;
END
$$

--
-- Create procedure `drop_index_if_exists`
--
CREATE
DEFINER = 'jlsg'@'%'
PROCEDURE drop_index_if_exists (IN tableName varchar(64), IN indexName varchar(64))
BEGIN
  IF EXISTS (SELECT
        1
      FROM INFORMATION_SCHEMA.STATISTICS
      WHERE TABLE_SCHEMA = DATABASE()
      AND TABLE_NAME = tableName
      AND INDEX_NAME = indexName) THEN
    SET @sql = CONCAT('ALTER TABLE ', tableName, ' DROP INDEX ', indexName);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;
END
$$

DELIMITER ;

--
-- Restore previous SQL mode
--
/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;

--
-- Enable foreign keys
--
/*!40014 SET FOREIGN_KEY_CHECKS = @OLD_FOREIGN_KEY_CHECKS */;